<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="html">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Laporan Pembelian Per Pelanggan</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Popper.js (Bootstrap 5 needs it for dropdowns & collapse) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
       body {
           background-color: #f4f4f4;
       }

       .logout-button {
           margin-top: auto;
           padding: 1rem;
       }

       .add-user-btn {
           margin-bottom: 15px;
       }

       .filter-container {
           margin: 20px 0;
       }

       .dropdown-item.disabled {
           pointer-events: none;
           opacity: 0.5;
       }

       input[type="checkbox"]:disabled {
         opacity: 1;
         pointer-events: none;
         accent-color: #007bff;
       }

       .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: #e0e7ff;
            padding-left: calc(1rem - 4px);
        }

    </style>
</head>
<body>
<div class="page">
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>
    <div class="page-wrapper">
        <div class="container-fluid">
            <h2 style="text-align:center; padding-top:10px">Laporan Pembelian Per Pelanggan</h2>

            <!-- Date range filters -->
            <form method="get" action="/laporan/pengeluaran/pelanggan" class="row filter-container align-items-end">
                <div class="col-md-2">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" id="startDate" name="startDate" class="form-control" th:value="${startDate}">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" id="endDate" name="endDate" class="form-control" th:value="${endDate}">
                </div>

                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Cari</button>
                </div>

                <!-- Add View PDF Button -->
                <div class="col-md-2 d-flex align-items-end">
                    <button id="viewPdfBtn" type="button" class="btn btn-warning w-100">
                        <i class="bi bi-eye-fill me-1"></i>View as PDF
                    </button>
                </div>
            </form>

            <div class="row mt-3 justify-content-center">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">
                                Total Pembelian
                                <span id="totalBeliDisplay" class="card-text fw-bold text-primary">Rp0</span>
                            </h6>
                        </div>
                    </div>
                </div>
            </div>

            <div style="max-height: 70vh; overflow-y: auto;">
                <table id="userTable" class="table table-striped table-bordered">
                    <thead class="sticky-top">
                    <tr>
                        <th scope="col">No</th>
                        <th scope="col">Nama Supplier</th>
                        <th scope="col">Total Pembelian</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="laporan, iterStat : ${laporanData}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td th:text="${laporan.supplierName}">Nama</td>
                        <td><span th:attr="data-value=${laporan.totalHargaPembelian}" th:text="${laporan.totalHargaPembelian}"></span></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- jsPDF & autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script th:inline="none">
    // Fungsi format range periode sesuai filter
    function formatRangePeriode(start, end, filter) {
        if (!start || !end) return '';
        const startDate = new Date(start);
        const endDate = new Date(end);
        if (isNaN(startDate) || isNaN(endDate)) return '';

        if (filter === 'day') {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return `${new Intl.DateTimeFormat('id-ID', options).format(startDate)} - ${new Intl.DateTimeFormat('id-ID', options).format(endDate)}`;
        } else if (filter === 'month') {
            const options = { month: 'long', year: 'numeric' };
            return `${new Intl.DateTimeFormat('id-ID', options).format(startDate)} - ${new Intl.DateTimeFormat('id-ID', options).format(endDate)}`;
        } else if (filter === 'year') {
            const options = { year: 'numeric' };
            return `${new Intl.DateTimeFormat('id-ID', options).format(startDate)} - ${new Intl.DateTimeFormat('id-ID', options).format(endDate)}`;
        }
        return '';
    }
    // Format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    // Sum columns by selector
    function sumColumn(selector) {
        let sum = 0;
        document.querySelectorAll(selector).forEach(el => {
            const value = parseFloat(el.getAttribute('data-value'));
            if (!isNaN(value)) {
                sum += value;
            }
        });
        return sum;
    }

    // Update displayed totals
    function updateTotals() {
        // Get all filtered rows data (not just visible page)
        const allData = $('#userTable').DataTable().rows({ search: 'applied' }).data();
        let totalBeli = 0;


        allData.each(function(row) {
            const tempDivBeli = document.createElement('div');
            tempDivBeli.innerHTML = row[2];
            const beliStr = tempDivBeli.querySelector('span')?.getAttribute('data-value') || '0';

            const beliNum = parseInt(beliStr, 10) || 0;

            totalBeli += beliNum;
        });

        // Format and display totals
        document.getElementById('totalBeliDisplay').textContent = formatCurrency(totalBeli);
    }

    $(document).ready(function () {
        // Format currency in the table
        document.querySelectorAll('td span').forEach(el => {
            const number = parseFloat(el.textContent);
            if (!isNaN(number)) {
                el.textContent = new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(number);
            }
        });

        // Register custom sort type for currency columns
        jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
            "tsc-pre": function (data) {
                return parseInt(data.replace(/\D/g, ''), 10);
            },
            "tsc-asc": function (a, b) {
                return a - b;
            },
            "tsc-desc": function (a, b) {
                return b - a;
            }
        });

        // Initialize DataTables with pagination
        const table = $('#userTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50],
            ordering: true,
            order: [],
            language: {
                search: "Cari: ",
                lengthMenu: "Tampilkan _MENU_ data per halaman",
                zeroRecords: "Data tidak ditemukan",
                info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
                paginate: {
                    first: "Awal",
                    last: "Akhir",
                    next: "›",
                    previous: "‹"
                }
            },
            scrollCollapse: true,
        });

        // Initial total calculation
        updateTotals();

        // Update totals when table is filtered or paginated
        table.on('draw', function () {
            updateTotals();
        });

        // Export full table to PDF (all pages)
        document.getElementById('viewPdfBtn').addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // === STEP 1: Get Filter Text and Dates ===
            const filterSelect = document.getElementById('filterOptions');
            const selectedText = filterSelect ? filterSelect.options[filterSelect.selectedIndex].textContent : "Hari";

            const startDateValue = document.getElementById('startDate')?.value;
            const endDateValue = document.getElementById('endDate')?.value;

            function formatIndoDate(dateStr, type) {
                const date = new Date(dateStr);
                const options = { year: 'numeric' };
                if (type === 'month') options.month = 'long';
                else if (type === 'day') options.month = 'long', options.day = 'numeric';
                return new Intl.DateTimeFormat('id-ID', options).format(date);
            }

            let formattedStart, formattedEnd;
            const filterValue = filterSelect?.value;
            if (filterValue === 'month') {
                formattedStart = formatIndoDate(startDateValue, 'month');
                formattedEnd = formatIndoDate(endDateValue, 'month');
            } else if (filterValue === 'year') {
                formattedStart = formatIndoDate(startDateValue, 'year');
                formattedEnd = formatIndoDate(endDateValue, 'year');
            } else {
                formattedStart = formatIndoDate(startDateValue, 'day');
                formattedEnd = formatIndoDate(endDateValue, 'day');
            }

            // === STEP 2: Build Title ===
            const title = `Laporan Pembelian Per Supplier`;
            const subtitle = `Periode: ${formattedStart} - ${formattedEnd}`;

            // === STEP 3: Build Table Data from ALL DataTable Rows ===
            const table = $('#userTable').DataTable();
            const allData = table.rows().data(); // all rows, not just visible

            const body = [];
            for (let i = 0; i < allData.length; i++) {
                const row = allData[i];
                const cells = $('<div>').html(row[2]).text(); // Extract text from span inside cell
                body.push([
                    i + 1,
                    $(row[1]).text() || row[1],
                    $(row[2]).text() || row[2],
                ]);
            }

            // === STEP 4: Write PDF Content ===
            doc.setFontSize(14);
            const pageWidth = doc.internal.pageSize.getWidth();
            const titleWidth = doc.getTextWidth(title);
            const titleX = (pageWidth - titleWidth) / 2;
            doc.text(title, titleX, 20);

            doc.setFontSize(11);
            const subtitleWidth = doc.getTextWidth(subtitle);
            const subtitleX = (pageWidth - subtitleWidth) / 2;
            doc.text(subtitle, subtitleX, 28);

            // Add some vertical space before table
            doc.autoTable({
                startY: 36,
                head: [['No', 'Nama Pelanggan', 'Total Pembelian']],
                body: body,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [0, 123, 255] }, // Bootstrap blue
                columnStyles: {
                    0: { cellWidth: 10 },    // No
                    1: { cellWidth: 80 },    // Nama Pelanggan
                    2: { cellWidth: 100 },    // Kotor
                },
                margin: { left: 14, right: 14 }
            });

            // === STEP 5: Open PDF
            window.open(doc.output('bloburl'), '_blank');
        });
    });
</script>
</body>
</html>
