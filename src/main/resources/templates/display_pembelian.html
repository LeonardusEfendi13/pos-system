<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="html">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Riwayat Pembelian</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        /* ===========================
           Global Styles
        ============================ */
        html, body {
          overflow-x: hidden;
          margin: 0;
          padding: 0;
        }

        .container-fluid {
          padding-left: 0 !important;
          padding-right: 0 !important;
        }

        /* ===========================
           Navigation
        ============================ */
        .nav-link.active {
          background-color: rgba(255, 255, 255, 0.1); /* putih transparan */
          color: #e0e7ff;
          padding-left: calc(1rem - 4px); /* agar padding kiri pas */
        }

        .logout-button {
          margin-top: auto;
          padding: 1rem;
        }

        /* ===========================
           Buttons
        ============================ */
        .add-user-btn {
          margin-bottom: 15px;
        }

        /* ===========================
           Filters
        ============================ */
        .filter-container {
          margin: 20px 0 8px;
        }

        /* ===========================
           Dropdown & Form Controls
        ============================ */
        .dropdown-item.disabled {
          pointer-events: none;
          opacity: 0.5;
        }

        input[type="checkbox"]:disabled {
          opacity: 1;               /* keep full opacity */
          pointer-events: none;     /* prevent interaction */
          accent-color: #007bff;    /* custom bright blue */
        }
        /* Table Wrapper */
        #tableWrapper {
          height: 100%;
          overflow-y: auto;
          overflow-x: hidden;
          transition: height 0.3s ease;
        }

        /* Detail Container */
        #detailContainer {
            display: none;
            height: 50%;
            background: white;
            border-top: 2px solid #ccc;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .detail-header {
          background: #f8f9fa;
          padding: .5rem 1rem;
          border-bottom: 1px solid #ddd;
        }

        .detail-body {
          height: calc(100% - 45px); /* header tinggi fix */
          overflow-y: auto;
        }

        /* Sticky header tabel detail */
        #detailContent table thead th {
          position: sticky;
          top: 0;
          background: #f8f9fa;
          z-index: 10;
        }
        #userTable tbody tr.previewing-row,
        #userTable tbody tr.previewing-row td {
          background-color: #FFA500 !important;
        }
        .filepond--drop-label {
            color: #4c4e53;
        }

        .filepond--label-action {
            text-decoration-color: #babdc0;
        }

        .filepond--panel-root {
            border-radius: 2em;
            background-color: #edf0f4;
        }

        .filepond--item-panel {
            background-color: #595e68;
        }

        .filepond--drip-blob {
            background-color: #7f8a9a;
        }
        .required-label::after {
            content: " *";
            color: red;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white; /* solid background */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="page">
    <aside th:replace="~{fragments/sidebar :: sidebar(sidebarData=${sidebarData})}"></aside>
    <div class="page-wrapper">
        <div id="loadingOverlay">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div class="container-fluid">
            <h2 style="text-align:center; padding-top:10px">Riwayat Pembelian</h2>

            <!-- ADD: Date range filters -->
            <form method="get" action="/pembelian" class="row filter-container">
                <div class="row mx-0 mb-4 pe-0">
                    <div class="col-md-2">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" id="startDate" name="startDate" class="form-control" th:value="${startDate}">
                    </div>
                    <div class="col-md-2">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" id="endDate" name="endDate" class="form-control" th:value="${endDate}">
                    </div>
                    <div class="col">
                        <label for="supplierId" class="form-label">Supplier</label>
                        <select id="supplierId" name="supplierId" class="form-select">
                            <option value="">-- Semua Supplier --</option>
                            <option th:each="supplier : ${supplierData}"
                                    th:value="${supplier.supplierId}"
                                    th:text="${supplier.supplierName}"
                                    th:selected="${supplier.supplierId == supplierId}">
                            </option>
                        </select>
                    </div>
                    <div class="col">
                        <label for="tunai" class="form-label">Tipe Pembayaran</label>
                        <select id="tunai" name="tunai" class="form-select">
                            <option value="" th:selected="${tunai == null}">-- Semua --</option>
                            <option th:value="true" th:selected="${tunai == true}">Tunai</option>
                            <option th:value="false" th:selected="${tunai == false}">Kredit</option>
                        </select>
                    </div>
                    <div class="col">
                        <label for="lunas" class="form-label">Status Pembayaran</label>
                        <select id="lunas" name="lunas" class="form-select">
                            <option value="" th:selected="${lunas == null}">-- Semua --</option>
                            <option th:value="true" th:selected="${lunas == true}">Lunas</option>
                            <option th:value="false" th:selected="${lunas == false}">Belum Lunas</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Terapkan Filter</button>
                    </div>
                </div>

                <div class="row mx-0 pe-0 d-flex justify-content-end">
                    <div class="col-md-3 pe-0">
                        <form method="get" action="/pembelian">
                            <div class="input-group">
                                <input type="text" class="form-control rounded rounded-end-0" name="search" id="searchInput" placeholder="Cari Nomor Faktur..."
                                       th:value="${search != null ? search : ''}">
                                <button type="submit" class="btn btn-info">Cari</button>
                            </div>
                        </form>
                    </div>
                </div>
            </form>

            <div class="row mt-3 justify-content-center">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">
                                Total Pembelian
                                <span id="totalBeliDisplay" class="card-text fw-bold text-primary">Rp0</span>
                            </h6>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid d-flex flex-column" style="margin-top:20px; height: 80vh">
                <!-- Table Wrapper -->
                <div id="tableWrapper" style="padding-left: 20px;">
                    <table id="userTable" class="table table-striped table-bordered w-100">
                        <thead class="sticky-top">
                        <tr>
                            <th scope="col">No</th>
                            <th scope="col">No. Faktur</th>
                            <th scope="col">Tanggal Faktur</th>
                            <th scope="col">Tanggal Jatuh Tempo</th>
                            <th scope="col">Total Beli</th>
                            <th scope="col">Supplier</th>
                            <th scope="col">Tipe Pembayaran</th>
                            <th scope="col">Lunas</th>
                            <th scope="col">Kasir</th>
                            <th scope="col">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="pembelian, iterStat : ${pembelianData}"
                            th:attr="data-id=${pembelian.pembelianId}, data-iskredit=${!pembelian.isCash}, data-islunas=${pembelian.isPaid}">
                            <td th:text="${(currentPage * size) + iterStat.index + 1}">1</td>
                            <td th:text="${pembelian.noFaktur}">No Faktur</td>
                            <td th:text="${#temporals.format(pembelian.tanggalBeli, 'dd MMMM yyyy', T(java.util.Locale).forLanguageTag('id'))}">
                                Tanggal Jual
                            </td>
                            <td th:text="${pembelian.isCash} ? ${#temporals.format(pembelian.tanggalBeli, 'dd MMMM yyyy', T(java.util.Locale).forLanguageTag('id'))} : ${#temporals.format(pembelian.tanggalTempo, 'dd MMMM yyyy', T(java.util.Locale).forLanguageTag('id'))}">
                                Tanggal Jual
                            </td>
                            <td><span th:text="${pembelian.totalPrice}">Rp0</span></td>
                            <td th:text="${pembelian.supplierDTO.supplierName}">Supplier</td>
                            <td th:text="${pembelian.isCash} ? 'Tunai' : 'Kredit'"></td>
                            <td style="text-align:center">
                                <input type="checkbox" th:checked="${pembelian.isPaid}"
                                       style="transform:scale(1.5);pointer-events: none;"/>
                            </td>
                            <td th:text="${pembelian.accountName}">Account Name</td>
                            <td>
                                <form th:action="@{/pembelian/tambah}" method="get" style="display:inline;">
                                    <input type="hidden" name="pembelianId" th:value="${pembelian.pembelianId}">
                                    <button class="btn btn-sm btn-primary me-1">Edit</button>
                                </form>
                                <form th:action="@{|/pembelian/delete/${pembelian.pembelianId}|}" method="post"
                                      style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger"
                                            onclick="return confirm('Are you sure you want to delete this data?');">
                                        <i class="ti ti-trash"></i> Delete
                                    </button>
                                </form>
                                <!-- Preview Button -->
                                <button type="button" class="btn btn-sm btn-info preview-btn"
                                        th:data-id="${pembelian.pembelianId}">
                                    Preview
                                </button>
                                <!-- Bukti Bayar Button -->
                                <button type="button" class="btn btn-sm btn-success bukti-btn"
                                        th:data-id="${pembelian.pembelianId}"
                                        th:if="${pembelian.isPaid && !pembelian.isCash}">
                                    Bukti Bayar
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!--  Pagination  -->
                    <div class="d-flex justify-content-between align-items-center my-2">
                        <div>
                            Menampilkan
                            <span th:if="${totalData > 0}">
                                <span th:text="${startData}">1</span> -
                                <span th:text="${endData}">10</span>
                            </span>
                            <span th:unless="${totalData > 0}" th:text="0">0</span>
                            dari
                            <span th:text="${totalData}">0</span> data
                        </div>

                        <nav aria-label="Page navigation example">
                            <ul class="pagination mb-0">
                                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                    <a class="page-link" th:href="@{/pembelian(page=${currentPage - 1}, search=${search}, customerId=${customerId}, startDate=${startDate}, endDate=${endDate})}">â€¹</a>
                                </li>
                                <li class="page-item" th:each="i : ${#numbers.sequence(start, end)}"
                                    th:classappend="${i == currentPage} ? 'active'">
                                    <a class="page-link" th:href="@{/pembelian(page=${i}, search=${search}, customerId=${customerId}, startDate=${startDate}, endDate=${endDate})}" th:text="${i + 1}">1</a>
                                </li>

                                <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                    <a class="page-link" th:href="@{/pembelian(page=${currentPage + 1}, search=${search}, customerId=${customerId}, startDate=${startDate}, endDate=${endDate})}">â€º</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <!-- Detail -->
                <div id="detailContainer">
                    <div class="detail-header d-flex justify-content-between align-items-center">
                        <h5 id="detailTitle" class="mb-0">Detail Pembelian</h5>
                        <button id="closeDetail" class="btn btn-sm btn-outline-secondary">Tutup</button>
                    </div>
                    <div class="detail-body">
                        <div id="detailContent" class="table-responsive"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="contextMenu" class="dropdown-menu" style="position:absolute; display:none; z-index:10000;">
        <a class="dropdown-item" href="#" id="contextLunaskan">
            Lunaskan Kredit
        </a>
    </div>
</div>

<!-- Bukti Lunas Modal -->
<div
        class="modal fade"
        id="lunaskanModal"
        tabindex="-1"
        aria-labelledby="lunaskanModalLabel"
        aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modalHeader">
                <h5 class="modal-title" id="lunaskanModalLabel">
                    Bukti Pelunasan
                </h5>
            </div>
            <form class="dropzone" id="lunaskanForm" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group" id="tanggalBayarField">
                        <label for="tanggalBayar">Tanggal Bayar</label>
                        <input type="datetime-local" class="form-control" id="tanggalBayar" name="tanggalBayar">
                    </div>
                    <br>
                    <input type="hidden" id="selectedPembelianId" name="pembelianId" />
                    <div class="form-group">
                        <label for="jenisPembayaran">Jenis Pembayaran</label>
                        <select class="form-control" id="jenisPembayaran" name="jenisPembayaran" required>
                            <option value="">Pilih Jenis Pembayaran</option>
                            <option value="transfer">Transfer</option>
                            <option value="cash">Tunai</option>
                        </select>
                    </div>
                    <div id="transferFields" style="display: none;">
                        <div class="form-group mt-3">
                            <label for="rekeningAsal" class="required-label">Rekening Asal</label>
                            <input type="text" class="form-control" id="rekeningAsal" name="rekeningAsal" placeholder="Nomor Rekening Asal" required/>
                        </div>

                        <div class="form-group mt-3">
                            <label for="rekeningTujuan" class="required-label">Rekening Tujuan</label>
                            <input type="text" class="form-control" id="rekeningTujuan" name="rekeningTujuan" placeholder="Nomor Rekening Tujuan" required/>
                        </div>
                        <br>
                        <label for="buktiPembayaran">Bukti Pembayaran</label>
                        <input type="file" class="filepond" id="buktiPembayaran" name="buktiPembayaran"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="simpanButton" disabled>Simpan</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Scripts -->
<script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- FilePond core -->
<link href="https://unpkg.com/filepond/dist/filepond.min.css" rel="stylesheet" />
<script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>

<!-- FilePond image preview plugin -->
<link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css" rel="stylesheet" />
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.js"></script>

<script th:inline="javascript">
    var pembelianData = /*[[${pembelianData}]]*/ [];
    var detailsMap = {};

    pembelianData.forEach(function (p) {
      detailsMap[p.pembelianId] = p.pembelianDetailDTOS;
    });
</script>
<script>
    // Hide spinner once everything is loaded
    window.addEventListener("load", () => {
        const overlay = document.getElementById("loadingOverlay");
        overlay.classList.add("hidden");
        setTimeout(() => overlay.remove(), 400); // Remove from DOM after fade out
    });
</script>
<!--Populate Bukti Bayar-->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        let total = 0;
        if (Array.isArray(pembelianData)) {
            pembelianData.forEach(p => {
                total += p.totalPrice || 0;
            });
        }
        const formatted = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0
        }).format(total);

        document.getElementById("totalBeliDisplay").textContent = formatted;

        // ==========================
        // ðŸ”§ FilePond Setup
        // ==========================
        FilePond.registerPlugin(FilePondPluginImagePreview);
        const pond = FilePond.create(document.querySelector('#buktiPembayaran'));

        // ==========================
        // ðŸŒ DOM Elements
        // ==========================
        const jenisPembayaran = document.getElementById("jenisPembayaran");
        const transferFields = document.getElementById("transferFields");
        const simpanButton = document.getElementById("simpanButton");
        const rekeningAsal = document.getElementById("rekeningAsal");
        const rekeningTujuan = document.getElementById("rekeningTujuan");
        const tanggalBayar = document.getElementById("tanggalBayar");
        const tanggalBayarField = document.getElementById("tanggalBayarField");
        const $contextMenu = $('#contextMenu');
        const $menuItem = $('#contextLunaskan');
        const modalEl = document.getElementById("lunaskanModal");

        let selectedPembelianId = null;

        // Initial UI state
        transferFields.style.display = "none";
        simpanButton.disabled = true;
        tanggalBayarField.style.display = "none";

        // ==========================
        // ðŸ§© Helper Functions
        // ==========================
        function setFormReadOnly(isReadOnly) {
            $("#jenisPembayaran").prop("disabled", isReadOnly);
            $("#rekeningAsal").prop("readonly", isReadOnly);
            $("#rekeningTujuan").prop("readonly", isReadOnly);
            $("#tanggalBayar").prop("readonly", true); // always readonly

            if (isReadOnly) {
                $("#simpanButton").hide();
                pond.setOptions({ allowReplace: false, allowRemove: false, allowBrowse: false });
            } else {
                $("#simpanButton").show();
                pond.setOptions({ allowReplace: true, allowRemove: true, allowBrowse: true });
            }
        }

        function resetForm() {
            $("#jenisPembayaran").val("");
            $("#rekeningAsal").val("");
            $("#rekeningTujuan").val("");
            $("#tanggalBayar").val("");
            pond.removeFiles();
            $("#transferFields").hide();
            $("#simpanButton").prop("disabled", true);
            tanggalBayarField.style.display = "none";
        }

        // ==========================
        // ðŸ’³ Jenis Pembayaran Change
        // ==========================
        jenisPembayaran.addEventListener("change", function () {
            const type = this.value;

            if (type === "transfer") {
                transferFields.style.display = "block";
                simpanButton.disabled = false;
                rekeningAsal.required = true;
                rekeningTujuan.required = true;
            } else if (type === "cash") {
                transferFields.style.display = "none";
                simpanButton.disabled = false;
                rekeningAsal.value = "";
                rekeningTujuan.value = "";
                pond.removeFiles();
                rekeningAsal.required = false;
                rekeningTujuan.required = false;
            } else {
                transferFields.style.display = "none";
                simpanButton.disabled = true;
                rekeningAsal.required = false;
                rekeningTujuan.required = false;
            }
        });

        // ==========================
        // ðŸ“Ž Bukti Bayar Button (READ-ONLY)
        // ==========================
        $(document).on("click", ".bukti-btn", function () {
            selectedPembelianId = $(this).data("id");
            $("#selectedPembelianId").val(selectedPembelianId);

            resetForm();
            setFormReadOnly(true);

            fetch(`/api/pembelian/bukti/${selectedPembelianId}`)
                .then(res => {
                    if (!res.ok) throw new Error("Gagal mengambil data bukti pembayaran.");
                    return res.json();
                })
                .then(data => {
                    $("#jenisPembayaran").val(data.jenisBayar || "").trigger("change");

                    if (data.jenisBayar === "transfer") {
                        $("#transferFields").show();
                        $("#rekeningAsal").val(data.rekeningAsal || "");
                        $("#rekeningTujuan").val(data.rekeningTujuan || "");

                        if (data.filePath) {
                            pond.removeFiles();
                            pond.addFile("/" + data.filePath);
                        } else {
                            pond.removeFiles();
                            pond.setOptions({
                                labelIdle: 'Tidak ada bukti pembayaran'
                            });
                        }
                    }

                    // ðŸ•“ Show tanggal bayar if exists
                    if (data.tanggalBayar) {
                        const d = new Date(data.tanggalBayar);
                        const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
                                        .toISOString()
                                        .slice(0, 16);
                        $("#tanggalBayar").val(local);
                        tanggalBayarField.style.display = "block";
                    }
                })
                .catch(err => alert(err.message))
                .finally(() => {
                    new bootstrap.Modal(modalEl).show();
                });
        });

        // ==========================
        // ðŸ–±ï¸ Right-click Context Menu
        // ==========================
        $('#userTable tbody').on('contextmenu', 'tr', function (e) {
            e.preventDefault();
            selectedPembelianId = $(this).data('id');
            const isKredit = $(this).data('iskredit');
            const isLunas = $(this).data('islunas');

            $menuItem.toggleClass('disabled', !(isKredit && !isLunas));
            $contextMenu.css({ display: 'block', left: e.pageX, top: e.pageY });
        });

        $(document).on('click', function () {
            $contextMenu.hide();
        });

        // ==========================
        // ðŸ’° Context Menu: Lunaskan Kredit
        // ==========================
        $menuItem.on("click", function (e) {
            e.preventDefault();
            $contextMenu.hide();
            if ($(this).hasClass("disabled")) return;

            resetForm();
            setFormReadOnly(false); // enable edit
            tanggalBayarField.style.display = "block";

            // Auto-fill current datetime (local)
            const now = new Date();
            const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            $("#tanggalBayar").val(local);

            $("#selectedPembelianId").val(selectedPembelianId);
            new bootstrap.Modal(modalEl).show();
        });

        // ==========================
        // ðŸ’¾ Form Submission
        // ==========================
        $('#lunaskanForm').on('submit', function (e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('pembelianId', $('#selectedPembelianId').val());
            formData.append('jenisPembayaran', jenisPembayaran.value);
            formData.append('rekeningAsal', rekeningAsal.value || '');
            formData.append('rekeningTujuan', rekeningTujuan.value || '');
            formData.append('tanggalBayar', tanggalBayar.value || '');

            const file = pond.getFile();
            if (file) formData.append('buktiPembayaran', file.file);

            fetch('/api/pembelian/lunaskan', {
                method: 'POST',
                body: formData
            })
            .then(res => {
                if (!res.ok) throw new Error('Terjadi kesalahan saat mengirim data.');
                return res.text();
            })
            .then(msg => {
                alert(msg || 'Kredit berhasil dilunaskan.');
                window.location.reload();
            })
            .catch(err => alert('Gagal: ' + err.message));
        });
    });
</script>

<script>
   function formatCurrency(amount) {
       if (amount == null) return "-";
       return new Intl.NumberFormat("id-ID", {
         style: "currency",
         currency: "IDR",
         minimumFractionDigits: 0,
       }).format(amount);
     }

  $(document).ready(function () {
      // Format currency
      document.querySelectorAll('td span').forEach(el => {
          const number = parseFloat(el.textContent);
          el.textContent = new Intl.NumberFormat('id-ID', {
              style: 'currency',
              currency: 'IDR',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
          }).format(number);
      });

      // Register custom sort type
      jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
          "tsc-pre": function (data) {
              return parseInt(data.replace(/\D/g, ''), 10);
          },
          "tsc-asc": function (a, b) {
              return a - b;
          },
          "tsc-desc": function (a, b) {
              return b - a;
          }
      });

      const table = $('#userTable').DataTable({
          columnDefs: [{
              targets: 1, // No. Faktur
              type: 'tsc'
          }],
          paging: false,
          pageLength: 10,
          lengthMenu: [5, 10, 25, 50],
          ordering: true,
          order: [],
          info: false,
          searching: false,
          scrollX: true,
          language: {
              lengthMenu: "Tampilkan _MENU_ data per halaman",
              zeroRecords: "Data tidak ditemukan",
              info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
              paginate: {
                  first: "Awal",
                  last: "Akhir",
                  next: "â€º",
                  previous: "â€¹"
              }
          },
          scrollCollapse: true,
      });

      function format(details) {
           if (!details || details.length === 0) {
             return "<div class='p-2 text-muted'>Tidak ada detail produk</div>";
           }

           let html = `
             <table class="table table-sm table-bordered mb-0">
               <thead class="table-light">
                 <tr>
                   <th>Kode</th>
                   <th>Nama Barang</th>
                   <th>Qty</th>
                   <th>Harga Beli</th>
                   <th>Diskon (Rp)</th>
                   <th>Total</th>
                   <th>Markup 1</th>
                   <th>Harga Jual 1</th>
                   <th>Markup 2</th>
                   <th>Harga Jual 2</th>
                   <th>Markup 3</th>
                   <th>Harga Jual 3</th>
                 </tr>
               </thead>
               <tbody>`;

           details.forEach((d) => {
             html += `
               <tr>
                 <td>${d.code}</td>
                 <td>${d.name}</td>
                 <td>${d.qty}</td>
                 <td>${formatCurrency(d.price)}</td>
                 <td>${formatCurrency(d.discAmount)}</td>
                 <td>${formatCurrency(d.total)}</td>
                 <td>${d.markup1 || "-"}</td>
                 <td>${d.hargaJual1 ? formatCurrency(d.hargaJual1) : "-"}</td>
                 <td>${d.markup2 || "-"}</td>
                 <td>${d.hargaJual2 ? formatCurrency(d.hargaJual2) : "-"}</td>
                 <td>${d.markup3 || "-"}</td>
                 <td>${d.hargaJual3 ? formatCurrency(d.hargaJual3) : "-"}</td>
               </tr>`;
           });

           html += `</tbody></table>`;
           return html;
         }

       // Preview
         // Preview button handler
       $("#userTable tbody").on("click", ".preview-btn", function () {
         const pembelianId = $(this).data("id");
         const details = detailsMap[pembelianId] || [];
         const noFaktur = $(this).closest("tr").find("td:eq(1)").text();

         $("#detailTitle").text("Detail Pembelian (" + noFaktur + ")");
         $("#userTable tbody tr").removeClass("previewing-row");
         $(this).closest("tr").addClass("previewing-row");

         // Isi detail
         $("#detailContent").html(format(details));

        $("#detailContainer").show();
        $("#tableWrapper").css("height", "60%");
        $("#detailContainer").css("height", "50%");

<!--         $("#detailContainer").show().css("height", "40%");-->
<!--         $("#tableWrapper").css("height", "60%");-->
       });

       // Tutup detail
       $("#closeDetail").on("click", function () {
         $("#detailContainer").hide();
         $("#tableWrapper").css("height", "100%");

         // Reset judul
         $("#detailTitle").text("Detail Pembelian");

         // Hapus highlight row
         $("#userTable tbody tr").removeClass("previewing-row");
       });

       const $searchInput = $('#searchInput');
       const baseUrl = '/pembelian';

       $('#searchButton').on('click', function(e) {
           if ($searchInput.val().trim() === '') {
               e.preventDefault();

               window.location.href = baseUrl;
           }
       });
  });
</script>
</body>
</html>
