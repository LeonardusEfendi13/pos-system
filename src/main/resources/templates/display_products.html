<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="html">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Master Barang</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>

    <!-- Bootstrap 5 (example) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!--    datatable-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body {
            background-color: #f4f4f4;
        }

        .modalHeader {
            cursor: pointer;
            background-color: #f1f1f1;
            padding: 10px;
            font-weight: bold;
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1); /* putih transparan */
            color: #e0e7ff;
            padding-left: calc(1rem - 4px); /* agar padding kiri pas */
        }

        .vehicle-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;

            padding: 6px 10px;
            border-radius: 8px;

            background-color: #f8f9fa;
            border: 1px solid #dee2e6;

            font-size: 0.85rem;
            color: #212529;
        }

        .vehicle-chip:hover {
            background-color: #f1f3f5;
        }

        .chip-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .chip-title {
            font-weight: 600;
        }

        .chip-year {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .chip-remove {
            border: none;
            background: transparent;
            font-size: 1rem;
            line-height: 1;
            color: #dc3545;
            cursor: pointer;
        }

        .chip-remove:hover {
            color: #a71d2a;
        }
    </style>
</head>
<body>
<div class="page">
    <aside th:replace="~{fragments/sidebar :: sidebar(sidebarData=${sidebarData})}"></aside>
    <div class="page-wrapper">
        <div class="container-fluid">
            <h2 style="text-align:center;padding-top:10px">Daftar Barang</h2>

            <!-- Add Barang Button -->
            <div class="d-flex justify-content-between align-items-end mb-3 gap-3">

                <!-- Tombol Tambah -->
                <button class="btn btn-success add-product-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#addBarangModal"
                        id="add-barang-btn">
                    Tambah Barang
                </button>

                <!-- Filter + Search -->
                <form method="get" action="/products"
                      class="d-flex align-items-end gap-3"
                      autocomplete="off">

                    <!-- Supplier Filter -->
                    <div>
                        <select id="supplierIdFilter"
                                name="supplierIdFilter"
                                class="form-select">
                            <option value="">-- Semua Supplier --</option>
                            <option th:each="supplier : ${supplierData}"
                                    th:value="${supplier.supplierId}"
                                    th:text="${supplier.supplierName}"
                                    th:selected="${supplier.supplierId == supplierId}">
                            </option>
                        </select>
                    </div>

                    <!-- Search Bar -->
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               name="search"
                               id="searchInput"
                               placeholder="Cari produk..."
                               th:value="${search != null ? search : ''}">
                        <button type="submit" class="btn btn-info">Cari</button>
                    </div>

                </form>
            </div>


            <table id="productTable" class="table table-striped table-bordered w-100" style="width:100%">
                <thead class="sticky-top">
                <tr>
                    <th scope="col" style="width: 5%">No</th>
                    <th scope="col" style="white-space: nowrap;width: 20%">Kode Part</th>
                    <th scope="col" style="white-space: nowrap;width: 35%">Nama Barang</th>
                    <th scope="col" style="width: 5%">Min Stok</th>
                    <th scope="col" style="width: 5%">Stok</th>
                    <th scope="col" style="width: 10%">Harga Beli</th>
                    <th scope="col" style="width: 10%">Harga Jual</th>
                    <th scope="col" style="width: 10%">Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="product, iterStat : ${productData}">
                    <td th:text="${(currentPage * size) + iterStat.index + 1}">1</td>
                    <td th:text="${product.shortName}">Kode Part</td>
                    <td th:text="${product.fullName}">Nama Barang</td>
                    <td th:text="${product.minimumStock == null ? 0 : product.minimumStock}">Minimum Stok</td>
                    <td th:text="${product.stok == null ? 0 : product.stok}">Stok</td>
                    <td class="rupiah-price" th:data-price="${product.hargaBeli}"
                        th:text="${product.hargaBeli}">Harga Beli
                    </td>
                    <td class="rupiah-price" th:data-price="${product.productPricesDTO[0].price}"
                        th:text="${product.productPricesDTO[0].price}">Harga Jual
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1">
                            <button
                                    class="btn btn-sm btn-primary me-1 edit-barang-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addBarangModal"
                                    id="edit-barang-btn"
                                    th:attr="data-productid=${product.productId}"
                            >Edit
                            </button>

                            <form th:action="@{|/products/delete/${product.productId}|}"
                                  method="post"
                                  style="display:inline;">
                                <button type="submit"
                                        class="btn btn-sm btn-danger"
                                        onclick="return confirm('Apakah anda yakin ingin menghapus barang ini?');"
                                        title="Delete User">
                                    <i class="ti ti-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!--  Pagination  -->
            <div class="d-flex justify-content-between align-items-center my-2">
                <div>
                    Menampilkan <span th:text="${startData}">1</span> -
                    <span th:text="${endData}">10</span> dari
                    <span th:text="${totalData}">10</span> data
                </div>

                <nav aria-label="Page navigation example">
                    <ul class="pagination mb-0">
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/products(page=${currentPage - 1}, search=${search}, supplierIdFilter=${supplierId})}">‚Äπ</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(start, end)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link" th:href="@{/products(page=${i}, search=${search}, supplierIdFilter=${supplierId})}" th:text="${i + 1}">1</a>
                        </li>

                        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                            <a class="page-link" th:href="@{/products(page=${currentPage + 1}, search=${search}, supplierIdFilter=${supplierId})}">‚Ä∫</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Edit & Add Barang Modal -->
        <div
                class="modal fade"
                id="barangModal"
                tabindex="-1"
                aria-labelledby="editBarangLabel"
                aria-hidden="true"
        >
            <div class="modal-dialog modal-lg">
                <form th:action="@{/products/add}" method="post" id="barangForm" autocomplete="off">
                    <div class="modal-content">
                        <div class="modal-header py-2 modalHeader">
                            <h5 class="modal-title" id="editBarangLabel">
                                Edit/Tambah Master Barang
                            </h5>
                            <button
                                    type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"
                            ></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="searchKey" name="search"/>
                            <input type="hidden" id="productId" name="productId"/>
                            <!-- Kode -->
                            <div class="mb-3 row">
                                <label class="col-sm-2 col-form-label" for="shortName">Kode Part</label>
                                <div class="col-sm-4">
                                    <input
                                            type="text"
                                            id="shortName"
                                            class="form-control"
                                            name="shortName"
                                            style="text-transform: uppercase;"
                                            required/>
                                </div>
                            </div>

                            <!-- Nama Barang -->
                            <div class="mb-3 row">
                                <label class="col-sm-2 col-form-label" for="fullName">Nama Barang</label>
                                <div class="col-sm-6">
                                    <input
                                            type="text"
                                            class="form-control"
                                            id="fullName"
                                            name="fullName"
                                            style="text-transform: uppercase;"
                                            required
                                    />
                                </div>
                            </div>

                            <!-- Supplier (Searchable Dropdown) -->
                            <div class="mb-3 row">
                                <label class="col-sm-2 col-form-label">Supplier Utama</label>
                                <div class="col-sm-4">
                                    <select class="form-select highlight-field" id="supplierId" name="supplierId"
                                            required>
                                        <option value="" disabled selected>Pilih Supplier</option>
                                        <option th:each="suppliers : ${supplierData}"
                                                th:value="${suppliers.supplierId}"
                                                th:text="${suppliers.supplierName}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Stok -->
                            <div class="mb-3 row">
                                <label class="col-sm-2 col-form-label" for="stok">Minimum Stok</label>
                                <div class="col-sm-2">
                                    <input
                                            type="number"
                                            class="form-control"
                                            id="minimumStock"
                                            name="minimumStock"
                                            value="0"
                                            required
                                    />
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label class="col-sm-2 col-form-label" for="stok">Stok</label>
                                <div class="col-sm-2">
                                    <input
                                            type="number"
                                            class="form-control"
                                            id="stok"
                                            name="stock"
                                            value="0"
                                            required
                                    />
                                </div>
                            </div>

                            <hr/>

                            <!-- KENDARAAN COMPATIBLE -->
                            <div class="mb-3">
                                <label class="form-label">Kendaraan Compatible</label>

                                <div id="vehicleChips" class="d-flex flex-wrap gap-2 mb-2"></div>

                                <button type="button"
                                        class="btn btn-sm btn-outline-primary"
                                        onclick="toggleVehicleForm()">
                                    + Tambah Kendaraan
                                </button>
                            </div>

                            <div id="vehicleInlineForm" class="border rounded p-3 mb-3 d-none">
                                <div class="mb-3">
                                    <label class="form-label">Kendaraan</label>
                                    <select id="vehicleId" class="form-select">
                                        <option value="">Pilih Kendaraan</option>
                                        <option th:each="v : ${vehicleData}"
                                                th:value="${v.id}"
                                                th:text="${v.model}">
                                        </option>
                                    </select>
                                </div>

                                <div class="row mb-3">
                                    <div class="col">
                                        <label>Tahun Mulai</label>
                                        <input type="number" id="yearStart" class="form-control">
                                    </div>
                                    <div class="col">
                                        <label>Tahun Akhir</label>
                                        <input type="number" id="yearEnd" class="form-control">
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success btn-sm" onclick="addVehicle()">
                                        Simpan
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleVehicleForm()">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Harga Beli -->
                            <div class="mb-3">
                                <h6>Harga Beli</h6>
                                <div class="row mb-2">
                                    <div class="col-sm-3">
                                        <input
                                                type="text"
                                                class="form-control rupiah-input"
                                                id="supplierPrice"
                                                name="supplierPrice"
                                                required
                                        />
                                    </div>
                                </div>
                            </div>

                            <hr/>

                            <!-- Harga Jual -->
                            <h6>Harga Jual</h6>
                            <table class="table table-bordered table-sm align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th></th>
                                    <th>Maks Qty</th>
                                    <th>Pct</th>
                                    <th>Harga Jual Satuan</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><p>Harga Jual 1</p></td>
                                    <td>
                                        <input
                                                type="number"
                                                class="form-control form-control-sm"
                                                name="productPricesDTO[0].maximalCount"
                                                id="maxqty1"
                                                value="0"
                                                required/>
                                    </td>
                                    <td>
                                        <input
                                                type="number"
                                                class="form-control form-control-sm"
                                                id="pct1"
                                                name="productPricesDTO[0].percentage"
                                                value="0"
                                                step="0.01"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control form-control-sm rupiah-input"
                                                name="productPricesDTO[0].price"
                                                id="hargaJual1"
                                                value="0"
                                                required/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><p>Harga Jual 2</p></td>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control form-control-sm"
                                                name="productPricesDTO[1].maximalCount"
                                                value="0"
                                                id="maxqty2"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="number"
                                                class="form-control form-control-sm"
                                                name="productPricesDTO[1].percentage"
                                                id="pct2"
                                                value="0"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control form-control-sm rupiah-input"
                                                name="productPricesDTO[1].price"
                                                value="0"
                                                id="hargaJual2"
                                        />
                                    </td>
                                </tr>
                                <tr>
                                    <td><p>Harga Jual 3</p></td>
                                    <td>
                                        <input
                                                type="number"
                                                class="form-control form-control-sm"
                                                name="productPricesDTO[2].maximalCount"
                                                value="0"
                                                id="maxqty3"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="number"
                                                class="form-control form-control-sm"
                                                id="pct3"
                                                name="productPricesDTO[2].percentage"
                                                value="0"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control form-control-sm rupiah-input"
                                                name="productPricesDTO[2].price"
                                                value="0"
                                                id="hargaJual3"
                                        />
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer py-2">
                            <button type="submit" class="btn btn-primary" id="addProductForm">Simpan</button>
                            <button
                                    type="button"
                                    class="btn btn-secondary"
                                    data-bs-dismiss="modal"
                            >
                                Tutup
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tabler Core JS -->
<script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
<!-- jQuery DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<!--    For Draggable modals-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script th:inline="javascript">
    const productData = /*[[${productData}]]*/ [];
</script>
<script>
    $(document).ready(function () {
        $("#barangModal").draggable();
    });
     window.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("searchInput");
        if (input) {
            input.focus();
            // Move cursor to the end
            const len = input.value.length;
            input.setSelectionRange(len, len);
        }
    });


    let vehicleIndex = 0;
    function toggleVehicleForm() {
        const form = document.getElementById("vehicleInlineForm");
        form.classList.toggle("d-none");
    }

    function addVehicle() {
        const select = document.getElementById("vehicleId");
        const vehicleId = select.value;
        const vehicleName = select.options[select.selectedIndex]?.text;
        const yearStart = document.getElementById("yearStart").value;
        const yearEnd = document.getElementById("yearEnd").value;

        if (!vehicleId || vehicleId === "null" || !yearStart || !yearEnd) {
            alert("Lengkapi data kendaraan");
            return;
        }

        const index = document.querySelectorAll("#vehicleChips .vehicle-chip").length;

        const chip = document.createElement("div");
        chip.className = "vehicle-chip";

        chip.innerHTML = `
            <div class="chip-text">
                <span class="chip-title">${vehicleName}</span>
                <span class="chip-year">${yearStart} ‚Äì ${yearEnd}</span>
            </div>

            <button type="button"
                    class="chip-remove"
                    onclick="removeVehicle(this)">
                &times;
            </button>

            <input type="hidden"
                   name="compatibleVehicles[${index}].vehicleId"
                   value="${vehicleId}">

            <input type="hidden"
                   name="compatibleVehicles[${index}].yearStart"
                   value="${yearStart}">

            <input type="hidden"
                   name="compatibleVehicles[${index}].yearEnd"
                   value="${yearEnd}">
        `;

        document.getElementById("vehicleChips").appendChild(chip);

        select.value = "";
        document.getElementById("yearStart").value = "";
        document.getElementById("yearEnd").value = "";
        toggleVehicleForm();
    }

    function removeVehicle(button) {
        const chip = button.closest(".vehicle-chip");
        chip.remove();
        reindexVehicles();
    }

    function reindexVehicles() {
        const chips = document.querySelectorAll("#vehicleChips .vehicle-chip");

        chips.forEach((chip, index) => {
            chip.querySelector('input[name*=".vehicleId"]')
                .name = `compatibleVehicles[${index}].vehicleId`;

            chip.querySelector('input[name*=".yearStart"]')
                .name = `compatibleVehicles[${index}].yearStart`;

            chip.querySelector('input[name*=".yearEnd"]')
                .name = `compatibleVehicles[${index}].yearEnd`;
        });
    }
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var status = /*[[${status}]]*/ false;
    var message = /*[[${message}]]*/ "Unknown message";

    if (status == 'true') {
        alert(message);
    }
    /*]]>*/
</script>
<script>
    $(document).ready(function () {
        const barangModal = document.getElementById('barangModal');
        const barangForm = document.getElementById('barangForm');
        const rupiahFormatter = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0
        });

        const hargaBeliInput = document.getElementById("supplierPrice");
        const hargaJual1 = document.getElementById("hargaJual1");
        const hargaJual2 = document.getElementById("hargaJual2");
        const hargaJual3 = document.getElementById("hargaJual3");
        const pct1 = document.getElementById("pct1");
        const pct2 = document.getElementById("pct2");
        const pct3 = document.getElementById("pct3");
        const rupiahInputs = document.querySelectorAll(".rupiah-input");
        const rupiahPrices = document.querySelectorAll(".rupiah-price");

        // --- Helper Functions ---
        function updatePercentage(hargaJualInput, pctOutput) {
            const hargaBeli = parseCurrency(hargaBeliInput.value.replace(/[^0-9]/g, '')) || 0;
            const hargaJualRaw = (hargaJualInput.value || "").toString().replace(/[^0-9.]/g, '');
            const hargaJual = parseCurrency(hargaJualRaw);

            const calculatedPct = ((hargaJual - hargaBeli) / hargaBeli) * 100;
            const result = calculatedPct.toFixed(2);
            pctOutput.value = result;
        }

        function updateHargaJual(pctInput, jualOutput) {
            const hargaBeli = parseFloat(hargaBeliInput.value.replace(/[^0-9]/g, '')) || 0;
            const percentage = parseFloat(pctInput.value) || 0;
            const calculatedHargaJual = hargaBeli + (hargaBeli * (percentage / 100));
            jualOutput.value = rupiahFormatter.format(calculatedHargaJual);
        }

        function parseCurrency(input) {
            if (!input) return 0;

            // Remove currency symbol and spaces
            let cleaned = input.replace(/[^0-9.,]/g, '');

            // Remove thousands separator
            cleaned = cleaned.replace(/\./g, '');

            // Replace decimal comma with dot
            cleaned = cleaned.replace(/,/g, '.');

            return parseFloat(cleaned) || 0;
        }

        function cleanRupiahToNumber(value) {
            return value.replace(/[^0-9]/g, '');
        }

        function clearForm() {
            barangForm.reset();
            $('#modalLabel').text('Tambah Master Barang & Jasa');
            $('#barangForm').attr('action', '/products/add');
            $('#productId').val(''); // Clear the hidden ID for new products

            // üî• CLEAR COMPATIBLE VEHICLE CHIPS
            $('#vehicleChips').empty();

            // Optional: hide inline form if open
            $('#vehicleInlineForm').addClass('d-none');
            $('#shortName').focus();
        }

        function populateForm(data) {
            console.log("Populating..");
            $('#modalLabel').text('Edit Master Barang & Jasa');
            $('#barangForm').attr('action', '/products/edit');
            $('#productId').val(data.productId); // Set the hidden ID for editing
            console.log("data", data);
            // Populate other fields
            $('#shortName').val(data.shortName);
            $('#fullName').val(data.fullName);
            $('#supplierId').val(data.supplierId);
            $('#stok').val(data.stok);
            $('#minimumStock').val(data.minimumStock);
            $('#supplierPrice').val(rupiahFormatter.format(data.hargaBeli));

           // ===== productPricesDTO SAFE ACCESS =====
            const prices = data.productPricesDTO || [];

            const p1 = prices[0] || {};
            const p2 = prices[1] || {};
            const p3 = prices[2] || {};

            $('#hargaJual1').val(p1.price ? rupiahFormatter.format(p1.price) : '');
            $('#hargaJual2').val(p2.price ? rupiahFormatter.format(p2.price) : '');
            $('#hargaJual3').val(p3.price ? rupiahFormatter.format(p3.price) : '');

            $('#pct1').val(p1.percentage ?? '');
            $('#pct2').val(p2.percentage ?? '');
            $('#pct3').val(p3.percentage ?? '');

            $('#maxqty1').val(p1.maximalCount ?? '');
            $('#maxqty2').val(p2.maximalCount ?? '');
            $('#maxqty3').val(p3.maximalCount ?? '');

            console.log("retrieving cvm..");

            const container = document.getElementById("vehicleChips");
            container.innerHTML = "";  // clear old chips
            vehicleIndex = 0;          // reset index for this modal

            const compatible = data.compatibleProductsDTOS || [];
            console.log("compatible", compatible);

            compatible.forEach((cp) => {
                const chip = document.createElement("div");
                chip.className = "vehicle-chip";

                chip.innerHTML = `
                    <div class="chip-text">
                        <span class="chip-title">${cp.model}</span>
                        <span class="chip-year">${cp.yearStart} ‚Äì ${cp.yearEnd}</span>
                    </div>

                    <button type="button"
                            class="chip-remove"
                            onclick="this.closest('.vehicle-chip').remove()">
                        &times;
                    </button>

                    <input type="hidden" name="compatibleVehicles[${vehicleIndex}].vehicleId" value="${cp.vehicleId}">
                    <input type="hidden" name="compatibleVehicles[${vehicleIndex}].yearStart" value="${cp.yearStart}">
                    <input type="hidden" name="compatibleVehicles[${vehicleIndex}].yearEnd" value="${cp.yearEnd}">
                `;

                container.appendChild(chip);
                vehicleIndex++;
            });
        }

        // Listener for the "Add Product" button to open the modal and clear the form.
        $('#add-barang-btn').on('click', function () {
            clearForm();
            $('#barangModal').modal('show');
        });

        // Listener for the "Edit" buttons to open the modal and populate the form.
        // The data attributes on these buttons are crucial for this to work.
        $('.edit-barang-btn').on('click', function () {
            const data = $(this).data();
            const id = $(this).data('productid');
            const product = productData.find(p => p.productId === id);
            populateForm(product);
            $('#barangModal').modal('show');
        });

        // Event listeners for price and percentage inputs (remains the same)
        hargaJual1.addEventListener('input', () => updatePercentage(hargaJual1, pct1));
        hargaJual2.addEventListener('input', () => updatePercentage(hargaJual2, pct2));
        hargaJual3.addEventListener('input', () => updatePercentage(hargaJual3, pct3));
        pct1.addEventListener('input', () => updateHargaJual(pct1, hargaJual1));
        pct2.addEventListener('input', () => updateHargaJual(pct2, hargaJual2));
        pct3.addEventListener('input', () => updateHargaJual(pct3, hargaJual3));

        // Event listeners for Rupiah formatting (remains the same)
        rupiahInputs.forEach(function (input) {
            input.addEventListener("input", function () {
                let rawValue = this.value.replace(/[^0-9]/g, '');
                this.value = rawValue ? rupiahFormatter.format(rawValue) : '';
            });
            input.addEventListener("blur", function () {
                let rawValue = this.value.replace(/[^0-9]/g, '');
                this.value = rawValue ? rupiahFormatter.format(rawValue) : '';
            });
        });

        document.querySelectorAll('.rupiah-price').forEach(element => {
            const price = parseFloat(element.getAttribute('data-price'));
            if (!isNaN(price)) {
                element.textContent = rupiahFormatter.format(price);
            }
        });

        // Form submission listener to clean up Rupiah values before submission.
        document.getElementById("addProductForm").addEventListener("click", function (e) {
            e.preventDefault();

            const form = document.getElementById("barangForm");

            // 1Ô∏è‚É£ Convert all text inputs to uppercase
            form.querySelectorAll("input[type='text']").forEach(input => {
                if (input.value && input.value.trim() !== "") {
                    input.value = input.value.toUpperCase();
                }
            });

            // 2Ô∏è‚É£ Clean Rupiah values before submitting
            rupiahInputs.forEach(input => {
                if (!input?.value || input.value.trim() === "") return;
                const cleaned = cleanRupiahToNumber(input.value);
                input.value = cleaned;
            });

            // 3Ô∏è‚É£ Submit form
            form.submit();
        });


        <!--        Handle maxqty-->
        const dirtyFlags = {
            maxqty2: false,
            maxqty3: false
        };

        function onInputChange() {
            dirtyFlags[this.id] = true; // User changed the value, mark dirty
        }

        function validateOnBlur() {
            const maxqty1 = parseInt(document.getElementById('maxqty1').value) || 0;
            const maxqty2 = parseInt(document.getElementById('maxqty2').value) || 0;
            const maxqty3 = parseInt(document.getElementById('maxqty3').value) || 0;

            if (this.id === 'maxqty2') {
                if (dirtyFlags.maxqty2 && !(maxqty2 > maxqty1)) {
                    alert('Maks Qty tidak boleh lebih kecil dari nilai sebelumnya');
                    dirtyFlags.maxqty2 = false;  // reset dirty flag after alert
                    this.focus(); // refocus to fix
                }
            }

            if (this.id === 'maxqty3') {
                if (dirtyFlags.maxqty3 && !(maxqty3 > maxqty2 && maxqty3 > maxqty1)) {
                    alert('Maks Qty tidak boleh lebih kecil dari nilai sebelumnya');
                    dirtyFlags.maxqty3 = false;  // reset dirty flag after alert
                    this.focus(); // refocus to fix
                }
            }
        }

        const maxqty2Input = document.getElementById('maxqty2');
        const maxqty3Input = document.getElementById('maxqty3');

        maxqty2Input.addEventListener('input', onInputChange);
        maxqty3Input.addEventListener('input', onInputChange);

        maxqty2Input.addEventListener('blur', validateOnBlur);
        maxqty3Input.addEventListener('blur', validateOnBlur);

        $('#productTable').DataTable({
            paging: false,
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50],
            ordering: true,
            order: [],
            info: false,
            searching: false,
            scrollX: true,
            language: {
                zeroRecords: "Data tidak ditemukan"
            }
        });

        const $searchInput = $('#searchInput');
        const baseUrl = '/products';

        document.getElementById("searchKey").value = $searchInput.val();

        $('#searchButton').on('click', function(e) {
            if ($searchInput.val().trim() === '') {
                e.preventDefault();
                window.location.href = baseUrl;
            }
        });
    });
</script>
</body>
</html>

