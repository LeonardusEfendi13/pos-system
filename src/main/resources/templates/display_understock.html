<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="html">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Barang Understock</title>

    <!-- Tabler (optional) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js" defer></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- jQuery (required by DataTables and some utilities) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>

    <!-- jQuery UI (if you want draggable modal) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" defer></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js" defer></script>

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"
            defer></script>

    <style>
        .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1); /* putih transparan */
        color: #e0e7ff;
        padding-left: calc(1rem - 4px); /* agar padding kiri pas */
    }

    body {
        background-color: #f8f9fc;
    }
    .section-title {
        font-weight: 600;
        margin-bottom: 15px;
        text-align: center;
    }
    .product-checkbox,
    #select-all {
        transform: scale(1.3);
        cursor: pointer;
    }
    table thead th {
        position: sticky;
        background: white;
        top: 0;
        z-index: 1;
    }
    .table-wrapper {
        max-height: 70vh;
        overflow-y: auto;
    }

    /* RIGHT CLICK CONTEXT MENU */
    #rowContextMenu {
        position: absolute;
        display: none;
        z-index: 10000;
        background: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        width: 170px;
        padding: 4px 0;
    }
    #rowContextMenu ul {
        list-style: none;
        padding: 5px 0;
        margin: 0;
    }
    #rowContextMenu li {
        padding: 8px 12px;
        cursor: pointer;
    }
    #rowContextMenu li:hover {
        background: #f0f0f0;
    }

    /* small responsiveness */
    @media (max-width: 768px) {
        .table-responsive { overflow-x: auto; }
    }
    </style>
</head>

<body>
<div class="page">
    <!-- Sidebar fragment (Thymeleaf) -->
    <aside th:replace="~{fragments/sidebar :: sidebar(sidebarData=${sidebarData})}"></aside>

    <div class="page-wrapper">
        <div class="page-content container py-4">

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="section-title">
                        Barang Understock <br>
                        <span class="small text-muted"
                              th:text="${supplierId == null ? '--Pilih Supplier--' : (supplierName)}"></span>
                    </h4>

                    <form method="get" action="/preorder/understock" class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="supplierId" class="form-label">Supplier</label>
                            <select id="supplierId" name="supplierId" class="form-select">
                                <option value="">Pilih Supplier</option>
                                <option th:each="supplier : ${supplierData}"
                                        th:value="${supplier.supplierId}"
                                        th:text="${supplier.supplierName}"
                                        th:selected="${supplier.supplierId == supplierId}">
                                </option>
                            </select>
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                Terapkan Filter
                            </button>
                        </div>

                        <div class="col-md-4 d-flex align-items-end justify-content-end">
                            <button type="button" class="btn btn-success px-3"
                                    id="viewSelectedBtn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#selectedModal">
                                ðŸ’¾ Buat Preorder
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- TABLE -->
            <div style="overflow-y: auto; height: 65vh">
                <table id="userTable" class="table table-striped table-bordered">
                    <thead class="sticky-top bg-white">
                    <tr>
                        <th>No</th>
                        <th>Kode Barang</th>
                        <th>Nama Barang</th>
                        <th>Minimum Stock</th>
                        <th>Stock</th>
                        <th style="text-align:center">
                            <input type="checkbox" id="select-all"/>
                            <label for="select-all" style="margin-left: 5px;">
                                (<span id="selected-count">0</span>)
                            </label>
                        </th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="product, iterStat : ${productData}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td th:text="${product.shortName}">KODE</td>
                        <td th:text="${product.fullName}">Nama</td>
                        <td th:text="${product.minimumStock}">0</td>
                        <td th:text="${product.stok}">0</td>
                        <td class="text-center">
                            <input type="checkbox" name="selectedProducts"
                                   th:value="${product.productId}"
                                   th:attr="
                                        data-shortname=${product.shortName},
                                        data-fullname=${product.fullName},
                                        data-hargabeli=${product.hargaBeli},
                                        data-stok=${product.stok},
                                        data-minimumstock=${product.minimumStock}
                                   "
                                   class="product-checkbox"/>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(productData)}">
                        <td colspan="6" class="text-center text-muted fst-italic">
                            Data tidak ditemukan. Harap pilih supplier.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade"
     id="selectedModal"
     tabindex="-1"
     aria-labelledby="selectedModalLabel"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Selected Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Supplier Dropdown -->
                <label for="supplierSelect" class="form-label">Select Supplier</label>
                <select id="supplierSelect" class="form-select mb-3" required>
                    <option value="" disabled selected>---Pilih Supplier---</option>
                    <option th:each="supplier : ${supplierData}"
                            th:value="${supplier.supplierId}"
                            th:text="${supplier.supplierName}">
                    </option>
                </select>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th style="width:5%">No</th>
                            <th style="width:20%">Kode Barang</th>
                            <th style="width:35%">Nama Barang</th>
                            <th style="width:10%">Harga Beli</th>
                            <th style="width:5%">Stok</th>
                            <th style="width:5%">Min Stock</th>
                            <th style="width:5%">Order Qty</th>
                            <th style="width:15%">Subtotal</th>
                        </tr>
                        </thead>
                        <tbody id="selectedProductsTableBody">
                        <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>

                <!-- Grand Total -->
                <div class="text-end fw-bold fs-5 mt-3">
                    Grand Total: Rp <span id="grandTotal">0</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveOrderBtn">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Context Menu -->
<div id="rowContextMenu">
    <ul>
        <li id="ctxDeleteRow">ðŸ—‘ Delete Row</li>
    </ul>
</div>

<!-- Main JS (placed at bottom so DOM is present) -->
<script>
    // Wait for deferred scripts (bootstrap/jQuery) to load if they were deferred.
    (function () {
        // Utility: currency formatting (IDR)
        function currencyFormat(num) {
            if (isNaN(num)) return '0';
            return new Intl.NumberFormat('id-ID').format(num);
        }

        // Expose to window in case other inline code expects it
        window.currencyFormat = currencyFormat;

        // Elements & state
        const selectAllCheckbox = document.getElementById('select-all');
        const selectedCountEl = document.getElementById('selected-count');
        let activeContextRow = null;

        // Update selected count
        function updateSelectedCount() {
            const count = document.querySelectorAll('.product-checkbox:checked').length;
            selectedCountEl.textContent = count;
        }

        // Init checkboxes listeners (for checkbox elements already in DOM)
        function initCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => {
                cb.removeEventListener('change', updateSelectedCount);
                cb.addEventListener('change', updateSelectedCount);
            });
        }

        // Select all behavior
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedCount();
            });
        }

        // Ensure initial listeners
        document.addEventListener('DOMContentLoaded', initCheckboxListeners);
        // Also call once now (in case DOM already parsed)
        initCheckboxListeners();
        updateSelectedCount();

        // Helper: recalc grand total
        function calculateGrandTotal() {
            let total = 0;
            document.querySelectorAll('.order-qty').forEach(input => {
                const qty = parseInt(input.value || 0);
                const harga = parseFloat(input.dataset.harga || 0);
                total += qty * harga;
            });
            document.getElementById('grandTotal').textContent = currencyFormat(total);
        }
        window.calculateGrandTotal = calculateGrandTotal;

        // Helper: attach qty listeners for inputs in modal
        function setupQtyListeners() {
            const qtyInputs = document.querySelectorAll('.order-qty');
            qtyInputs.forEach(input => {
                // remove previous to avoid duplicate handlers
                input.removeEventListener('input', input._qtyHandler || (() => {}));
                const handler = function () {
                    const qty = parseInt(this.value || 0);
                    const harga = parseFloat(this.dataset.harga || 0);
                    const subtotal = qty * harga;
                    const subtotalEl = this.closest('tr').querySelector('.subtotal');
                    if (subtotalEl) subtotalEl.textContent = currencyFormat(subtotal);
                    calculateGrandTotal();
                };
                input.addEventListener('input', handler);
                // keep ref so removal possible
                input._qtyHandler = handler;
            });
        }
        window.setupQtyListeners = setupQtyListeners;

        // Build rows when "Buat Preorder" clicked
        const viewSelectedBtn = document.getElementById('viewSelectedBtn');
        if (viewSelectedBtn) {
            viewSelectedBtn.addEventListener('click', function () {
                const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
                const tbody = document.getElementById('selectedProductsTableBody');
                tbody.innerHTML = '';

                if (selectedCheckboxes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products selected.</td></tr>';
                    calculateGrandTotal();
                    return;
                }

                let index = 1;
                selectedCheckboxes.forEach(cb => {
                    const shortName = cb.dataset.shortname || cb.getAttribute('data-shortname') || '';
                    const fullName = cb.dataset.fullname || cb.getAttribute('data-fullname') || '';
                    const hargaBeli = parseFloat(cb.dataset.hargabeli || cb.getAttribute('data-hargabeli') || 0) || 0;
                    const stok = cb.dataset.stok || cb.getAttribute('data-stok') || '';
                    const minimumStock = cb.dataset.minimumstock || cb.getAttribute('data-minimumstock') || '';

                    const row = document.createElement('tr');

                    // Context menu open
                    row.addEventListener('contextmenu', function (e) {
                        e.preventDefault();
                        activeContextRow = row;
                        const menu = document.getElementById('rowContextMenu');
                        menu.style.display = 'block';

                        // Position within viewport to avoid overflow
                        const padding = 8;
                        const menuRect = menu.getBoundingClientRect();
                        const x = e.pageX;
                        const y = e.pageY;
                        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
                        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);

                        // Try to position such that the menu stays inside viewport
                        let left = x;
                        let top = y;
                        // if menu would overflow right side
                        if (left + menuRect.width + padding > window.scrollX + vw) {
                            left = window.scrollX + vw - menuRect.width - padding;
                        }
                        // if menu would overflow bottom
                        if (top + menuRect.height + padding > window.scrollY + vh) {
                            top = window.scrollY + vh - menuRect.height - padding;
                        }

                        menu.style.left = left + 'px';
                        menu.style.top = top + 'px';
                    });

                    row.title = "Right-click to open menu";

                    row.innerHTML = `
                        <td style="width:5%">${index++}</td>
                        <td style="width:20%">${escapeHtml(shortName)}</td>
                        <td style="width:35%">${escapeHtml(fullName)}</td>
                        <td style="width:10%">Rp <span class="harga-beli">${currencyFormat(hargaBeli)}</span></td>
                        <td style="width:5%">${escapeHtml(stok)}</td>
                        <td style="width:5%">${escapeHtml(minimumStock)}</td>
                        <td style="width:5%">
                            <input type="number" min="1" value="1" class="form-control order-qty" data-harga="${hargaBeli}" />
                        </td>
                        <td style="width:15%">Rp <span class="subtotal">${currencyFormat(hargaBeli)}</span></td>
                    `;

                    tbody.appendChild(row);
                });

                setupQtyListeners();
                calculateGrandTotal();
            });
        }

        // Escape HTML to avoid injection in innerHTML
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Global click hides the custom menu (but don't hide when clicking the menu itself)
        document.addEventListener('click', function (e) {
            const menu = document.getElementById('rowContextMenu');
            if (!menu) return;
            // If click is outside menu, hide it
            if (!menu.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // Delete action for context menu
        const ctxDelete = document.getElementById('ctxDeleteRow');
        if (ctxDelete) {
            ctxDelete.addEventListener('click', function () {
                if (activeContextRow) {
                    activeContextRow.remove();
                    activeContextRow = null;
                    calculateGrandTotal();
                }
                document.getElementById('rowContextMenu').style.display = 'none';
            });
        }

        // Also hide context menu on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const menu = document.getElementById('rowContextMenu');
                if (menu) menu.style.display = 'none';
            }
        });

        // Save button logic (collect rows and POST)
        const saveBtn = document.getElementById('saveOrderBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', async function () {
                const supplierSelect = document.getElementById('supplierSelect');
                const selectedSupplierId = supplierSelect ? supplierSelect.value : null;
                const selectedSupplierName = supplierSelect ? supplierSelect.options[supplierSelect.selectedIndex].text : '';

                if (!selectedSupplierId) {
                    alert("Please select a supplier.");
                    return;
                }

                const preorderDetailDTOS = [];
                let subtotal = 0;
                let totalDisc = 0;

                document.querySelectorAll('#selectedProductsTableBody tr').forEach(row => {
                    // ignore "No products selected" row
                    const qtyInput = row.querySelector('.order-qty');
                    if (!qtyInput) return;

                    const code = row.children[1].textContent.trim();
                    const fullName = row.children[2].textContent.trim();
                    const hargaBeli = parseFloat(qtyInput.dataset.harga || 0) || 0;
                    const qty = parseInt(qtyInput.value || 0) || 0;
                    if (qty <= 0) return;

                    const total = hargaBeli * qty;
                    subtotal += total;

                    preorderDetailDTOS.push({
                        code: code,
                        name: fullName,
                        qty: qty,
                        price: hargaBeli,
                        discAmount: 0,
                        total: total
                    });
                });

                if (preorderDetailDTOS.length === 0) {
                    alert("No valid items to save.");
                    return;
                }

                const requestPayload = {
                    supplierId: parseInt(selectedSupplierId),
                    preorderDetailDTOS,
                    subtotal,
                    totalDisc,
                    totalPrice: subtotal - totalDisc
                };

                try {
                    const response = await fetch("/api/preorder/add", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestPayload),
                    });

                    const text = await response.text();

                    if (!response.ok) {
                        alert("Gagal menyimpan data");
                        console.error("Server returned:", text);
                        return;
                    }

                    alert("Berhasil menyimpan data");

                    // generate PDF immediately
                    generateSimplePDF(preorderDetailDTOS, selectedSupplierName || 'supplier');

                    // redirect to preorder page
                    window.location.href = '/preorder';

                } catch (err) {
                    console.error(err);
                    alert("Terjadi kesalahan saat menyimpan data.");
                }
            });
        }

        // Simple PDF generator using jsPDF + autotable
        function generateSimplePDF(preorderDetailDTOS, supplierName) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();

                doc.setFontSize(16);
                doc.text("Preorder Anugrah Motor", pageWidth / 2, 15, { align: "center" });

                const today = new Date();
                const formattedDate = today.toLocaleDateString("id-ID", {
                    day: "2-digit",
                    month: "long",
                    year: "numeric"
                });

                doc.setFontSize(11);
                doc.text(`Supplier: ${supplierName}`, 10, 30);
                doc.setFontSize(10);
                doc.text(`${formattedDate}`, pageWidth - 10, 30, { align: "right" });

                const tableColumn = ["No", "Kode", "Nama Barang", "Qty"];
                const tableRows = [];

                preorderDetailDTOS.forEach((item, index) => {
                    tableRows.push([
                        String(index + 1),
                        item.code,
                        item.name,
                        String(item.qty)
                    ]);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40,
                    theme: "grid",
                    styles: {
                        fontSize: 9,
                        lineWidth: 0.2
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 100 },
                        3: { cellWidth: 20, halign: "right" }
                    },
                    tableWidth: "wrap"
                });

                const fileNameSafe = supplierName.replace(/[^\w\d\-_.]/g, '_');
                doc.save(`preorder-${fileNameSafe}-${formattedDate}.pdf`);
            } catch (e) {
                console.error("PDF generation failed:", e);
            }
        }
        window.generateSimplePDF = generateSimplePDF;


        // Re-init checkbox listeners whenever the table might be re-rendered
        // (for example, datatable redraw or server-side changes)
        // We use MutationObserver on tbody to detect changes and re-bind
        (function observeCheckboxContainer() {
            const tbody = document.querySelector('#userTable tbody');
            if (!tbody) return;
            const mo = new MutationObserver(function () {
                initCheckboxListeners();
                updateSelectedCount();
            });
            mo.observe(tbody, { childList: true, subtree: true });
        })();

    })();
</script>
</body>
</html>
