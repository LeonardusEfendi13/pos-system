<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:inline="html">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Barang Understock</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body {
            background-color: #f8f9fc;
        }
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1); /* putih transparan */
            color: #e0e7ff;
            padding-left: calc(1rem - 4px); /* agar padding kiri pas */
        }
        .page-content {
            padding: 25px;
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        .product-checkbox,
        #select-all {
            transform: scale(1.3);
            cursor: pointer;
        }
        table thead th {
            position: sticky;
            background: white;
            top: 0;
            z-index: 1;
        }
        .table-wrapper {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>

<body>
<div class="page">
    <aside th:replace="~{fragments/sidebar :: sidebar(sidebarData=${sidebarData})}"></aside>

    <div class="page-wrapper">
        <div class="page-content container">

            <div class="card shadow-sm mb-4">
                <div class="card-body">

                    <h4 class="section-title">
                        Barang Understock
                        <br>
                        <span class="small text-muted"
                              th:text="${supplierId == null ? '--Pilih Supplier--' : (supplierName)}"></span>
                    </h4>

                    <form method="get" action="/preorder/understock" class="row g-3">
                        <div class="col-md-6">
                            <label for="supplierId" class="form-label">Supplier</label>
                            <select id="supplierId" name="supplierId" class="form-select">
                                <option value="">Pilih Supplier</option>
                                <option th:each="supplier : ${supplierData}"
                                        th:value="${supplier.supplierId}"
                                        th:text="${supplier.supplierName}"
                                        th:selected="${supplier.supplierId == supplierId}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                Terapkan Filter
                            </button>
                        </div>
                        <div class="col-md-4 d-flex align-items-end justify-content-end">
                            <button type="button" class="btn btn-success px-3"
                                    id="viewSelectedBtn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#selectedModal">
                                ðŸ’¾ Buat Preorder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div style="overflow-y: auto;height:10  0vh">
                <table id="userTable" class="table table-striped table-bordered">
                    <thead class="sticky-top">
                    <tr>
                        <th scope="col">No</th>
                        <th scope="col">Kode Barang</th>
                        <th scope="col">Nama Barang</th>
                        <th scope="col">Minimum Stock</th>
                        <th scope="col">Stock</th>
                        <th style="text-align:center">
                            <input type="checkbox" id="select-all"/>
                            <label for="select-all" style="margin-left: 5px;">
                                (<span id="selected-count">0</span>)
                            </label>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="product, iterStat : ${productData}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td th:text="${product.shortName}">Kode Barang</td>
                        <td th:text="${product.fullName}">Full Name</td>
                        <td th:text="${product.minimumStock}">999</td>
                        <td th:text="${product.stok}">888</td>
                        <td style="text-align:center">
                            <input type="checkbox" name="selectedProducts"
                                   th:value="${product.productId}"
                                   th:attr="
                        data-shortname=${product.shortName},
                        data-fullname=${product.fullName},
                        data-hargabeli=${product.hargaBeli},
                        data-stok=${product.stok},
                        data-minimumstock=${product.minimumStock}
                   "
                                   class="product-checkbox"/>
                        </td>
                    </tr>

                    <!-- Show this row if the list is empty -->
                    <tr th:if="${#lists.isEmpty(productData)}">
                        <td colspan="6" style="text-align:center; font-style:italic; color:gray;">
                            Data tidak ditemukan. Harap pilih supplier
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade"
     id="selectedModal"
     tabindex="-1"
     aria-labelledby="selectedModalLabel"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Selected Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Supplier Dropdown -->
                <label for="supplierSelect" class="form-label">Select Supplier</label>
                <select id="supplierSelect" class="form-select mb-3" required>
                    <option value="" disabled selected>---Pilih Supplier---</option>
                    <option th:each="supplier : ${supplierData}"
                            th:value="${supplier.supplierId}"
                            th:text="${supplier.supplierName}">
                    </option>
                </select>

                <!-- Table -->
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th style="width:5%">No</th>
                        <th style="width:20%">Kode Barang</th>
                        <th style="width:35%">Nama Barang</th>
                        <th style="width:10%">Harga Beli</th>
                        <th style="width:5%">Stok</th>
                        <th style="width:5%">Min Stock</th>
                        <th style="width:5%">Order Qty</th>
                        <th style="width:15%">Subtotal</th>
                    </tr>
                    </thead>
                    <tbody id="selectedProductsTableBody">
                    <!-- JS will populate this -->
                    </tbody>
                </table>

                <!-- Grand Total -->
                <div class="text-end fw-bold fs-5 mt-3">
                    Grand Total: Rp <span id="grandTotal">0</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveOrderBtn">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Tabler Core JS -->
<script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>

<!-- jQuery DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!--    For Draggable modals-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
    document.addEventListener("focusin", function(e) {
        if (e.target.tagName === "INPUT") {
            e.target.select();
        }
    });

$(document).ready(function () {
    // Event Edit User Modal
    $('.edit-user-btn').on('click', function () {
        const userId = $(this).data('userid');
        const name = $(this).data('name');
        const username = $(this).data('username');
        const role = $(this).data('role');

        $('#editUserId').val(userId);
        $('#editName').val(name);
        $('#editUsername').val(username);
        $('#editRole').val(role);
    });
});

const selectAll = document.getElementById('select-all');
const checkboxes = document.querySelectorAll('.product-checkbox');
const selectedCount = document.getElementById('selected-count');

function updateSelectedCount() {
    const count = document.querySelectorAll('.product-checkbox:checked').length;
    selectedCount.textContent = count;
}

selectAll.addEventListener('change', function () {
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
});

checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

const currencyFormat = num => new Intl.NumberFormat('id-ID').format(num);

document.getElementById('viewSelectedBtn').addEventListener('click', function () {
    const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
    const tbody = document.getElementById('selectedProductsTableBody');
    tbody.innerHTML = '';

    if (selectedCheckboxes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products selected.</td></tr>';
        return;
    }

    let index = 1;
    selectedCheckboxes.forEach(cb => {
        const shortName = cb.dataset.shortname;
        const fullName = cb.dataset.fullname;
        const hargaBeli = parseFloat(cb.dataset.hargabeli || 0);
        const stok = cb.dataset.stok;
        const minimumStock = cb.dataset.minimumstock;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="width:5%">${index++}</td>
            <td style="width:20%">${shortName}</td>
            <td style="width:35%">${fullName}</td>
            <td style="width:10%">Rp <span class="harga-beli">${currencyFormat(hargaBeli)}</span></td>
            <td style="width:5%">${stok}</td>
            <td style="width:5%">${minimumStock}</td>
            <td style="width:5%">
                <input type="number" min="1" value="1" class="form-control order-qty" data-harga="${hargaBeli}" />
            </td>
            <td style="width:15%">Rp <span class="subtotal">${currencyFormat(hargaBeli)}</span></td>
        `;
        tbody.appendChild(row);
    });

    calculateGrandTotal();
    setupQtyListeners();
});

function setupQtyListeners() {
    const qtyInputs = document.querySelectorAll('.order-qty');
    qtyInputs.forEach(input => {
        input.addEventListener('input', function () {
            const qty = parseInt(this.value || 0);
            const harga = parseFloat(this.dataset.harga);
            const subtotal = qty * harga;
            const subtotalEl = this.closest('tr').querySelector('.subtotal');
            subtotalEl.textContent = currencyFormat(subtotal);
            calculateGrandTotal();
        });
    });
}

function calculateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.order-qty').forEach(input => {
        const qty = parseInt(input.value || 0);
        const harga = parseFloat(input.dataset.harga || 0);
        total += qty * harga;
    });
    document.getElementById('grandTotal').textContent = currencyFormat(total);
}

// Placeholder for Save button
document.getElementById('saveOrderBtn').addEventListener('click', async function () {
    const supplierSelect = document.getElementById('supplierSelect');
    const selectedSupplierId = supplierSelect.value;
    const selectedSupplierName = supplierSelect.options[supplierSelect.selectedIndex].text;

    if (!selectedSupplierId) {
        alert("Please select a supplier.");
        return;
    }

    const preorderDetailDTOS = [];
    let subtotal = 0;
    let totalDisc = 0;

    document.querySelectorAll('#selectedProductsTableBody tr').forEach(row => {
        const code = row.children[1].textContent;
        const fullName = row.children[2].textContent;
        const hargaBeli = parseFloat(row.querySelector('.order-qty').dataset.harga || 0);
        const qty = parseInt(row.querySelector('.order-qty').value || 0);
        if (qty <= 0) return;

        const total = hargaBeli * qty;
        subtotal += total;

        preorderDetailDTOS.push({
            code: code,
            name: fullName,
            qty: qty,
            price: hargaBeli,
            discAmount: 0,
            total: total
        });
    });

    const requestPayload = {
        supplierId: parseInt(selectedSupplierId),
        preorderDetailDTOS,
        subtotal,
        totalDisc,
        totalPrice: subtotal - totalDisc
    };

    try {
        const response = await fetch("/api/preorder/add", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestPayload),
        });

        const result = await response.text();
        if (!response.ok) {
            alert("Gagal menyimpan data");
            throw new Error(`${result}`);
        }

        alert("Berhasil menyimpan data");

        // ðŸ”½ Immediately generate PDF
        generateSimplePDF(preorderDetailDTOS, selectedSupplierName);
        window.location.href = '/preorder';
    } catch (err) {
        console.error(err);
    }
});

</script>
<script th:inline="none">
    function generateSimplePDF(preorderDetailDTOS, supplierName) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();

        // --- Header Title ---
        doc.setFontSize(18);
        doc.text("Preorder Anugrah Motor", pageWidth / 2, 15, { align: "center" });

        // --- Supplier & Date Info ---
        const today = new Date();
        const formattedDate = today.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric"
        });

        doc.setFontSize(12);
        doc.text(`Supplier: ${supplierName}`, 10, 30);
        doc.setFontSize(10);
        doc.text(`${formattedDate}`, pageWidth - 10, 30, { align: "right" });

        // --- Table Columns (only 4) ---
        const tableColumn = ["No", "Kode", "Nama Barang", "Qty"];
        const tableRows = [];

        preorderDetailDTOS.forEach((item, index) => {
            tableRows.push([
                String(index + 1),
                item.code,
                item.name,
                String(item.qty)
            ]);
        });

        // --- Table ---
        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 50,
            theme: "grid",
            styles: {
                fontSize: 10,
                lineWidth: 0.2,
                lineColor: [0, 0, 0]
            },
            headStyles: {
                fillColor: [255, 255, 255],
                textColor: [0, 0, 0],
                fontStyle: "bold"
            },
            columnStyles: {
                0: { cellWidth: 15 },               // No
                1: { cellWidth: 40 },               // Kode
                2: { cellWidth: 90 },               // Nama Barang
                3: { cellWidth: 20, halign: "right" } // Qty (right aligned)
            },
            tableWidth: "wrap"
        });

        // --- Save File ---
        const fileName = `preorder-${supplierName}-${formattedDate}.pdf`;
        doc.save(fileName);
    }
</script>
</body>
</html>
