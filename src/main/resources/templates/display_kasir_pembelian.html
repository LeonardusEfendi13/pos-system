<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Pembelian</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>

    <!-- Bootstrap 5 (example) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!--    datatable-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
          background-color: #f8f9fa;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            "Helvetica Neue", Arial, sans-serif;
        }
        .card {
          border: none;
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .table {
          margin-bottom: 0;
        }
        .table thead {
          background-color: #e9ecef;
        }
        .table td,
        .table th {
          vertical-align: middle;
          padding: 0.5rem 0.75rem;
        }
        .form-control-sm,
        .form-select-sm {
          padding: 0.25rem 0.5rem;
          font-size: 0.875rem;
        }
        .btn {
          font-size: 0.875rem;
        }

        #contextMenu {
          position: absolute;
          display: none;
          background-color: white;
          border: 1px solid #ccc;
          z-index: 1000;
          min-width: 150px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
          border-radius: 0.25rem;
        }
        #contextMenu ul {
          list-style: none;
          padding: 0;
          margin: 0;
        }
        #contextMenu li {
          padding: 8px 12px;
          cursor: pointer;
          font-size: 0.875rem;
        }
        #contextMenu li:hover {
          background-color: #f0f0f0;
        }

        /* Custom styles for the scrollable table */
        .scrollable-table {
          max-height: 50vh;
          overflow-y: auto;
        }

        /* Payment section styling */
        .payment-section-card {
          background-color: #e9ecef;
          padding: 1.5rem;
        }
        html, body {
          height: 100%;
          overflow: hidden; /* hilangkan scroll body */
        }
        .table-responsive {
          border-radius: 0.3rem;
          height: 100%;
          max-width:100%;
          overflow-y: auto; /* kalau banyak data scroll di tabel aja */
          overflow-x:auto;
        }
        .scrollable-table thead th {
          position: sticky;
          top: 0;
          background: #f8f9fa;  /* biar header tidak tembus */
          z-index: 2;           /* biar header di atas isi tabel */
        }
        #sellTable {
          width: max-content; /* Biarkan tabel melebar melebihi container */
          min-width: 100%;    /* Tetap 100% minimal */
        }

        #sellTable th,
        #sellTable td {
          white-space: nowrap; /* Jangan wrap konten */
        }

        .bottom-right-fixed {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #productTable th,
        #productTable td {
          border-right: 1px solid #dee2e6; /* Bootstrap's default border color */
        }

        #productTable th:last-child,
        #productTable td:last-child {
          border-right: none; /* Remove border on the last column */
        }

        #productTable thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-right: 1px solid #dee2e6;
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
            height: 40px; /* fixed height */
        }

        #productTable thead th:last-child {
            border-right: none;
        }

        #productTable tbody td {
            border-right: 1px solid #dee2e6;
        }

        #productTable tbody td:last-child {
            border-right: none;
        }

        /* Push the first row down by header height */
        #productTable tbody tr:first-child {
            padding-top: 40px;
            display: table-row;
        }
        #sellTable input.form-control {
          border: none;           /* hilangkan border bootstrap */
          box-shadow: none;       /* hilangkan shadow fokus */
          padding: 0 2px;         /* rapat kiri kanan */
          height: 20px;           /* perkecil tinggi */
          font-size: 0.8rem;      /* font lebih kecil */
          line-height: 1.2;
          margin: 0;
          border-radius: 0;
        }
        #sellTable td,
        #sellTable th {
          padding: 2px 4px;  /* default bootstrap 8–12px, ini lebih rapat */
        }
        #sellTable input:focus {
          outline: none; /* supaya pas fokus tidak muncul border biru tebal */
          background-color: #fff7cc;
        }
        #sellTable td:has(input:focus) {
          background-color: #fff3cd; /* warna highlight cell */
        }
       .modalHeader {
          cursor: pointer;
          background-color: #f1f1f1;
          padding: 10px;
          font-weight: bold;
        }
    </style>
</head>
<body class="d-flex flex-column vh-100 p-2">
<div class="container-fluid">
    <div
            class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-3"
    >
        <!-- CARD -->
        <div class="card p-3 flex-grow-1" style="min-width: 600px">
            <div class="row g-3">
                <!-- Kiri: Info Utama -->
                <div class="col-md-4">
                    <h5 class="m-0 mb-2" id="transactionNumberDisplay">#TRX000001</h5>
                    <select
                            id="customerSelect"
                            class="form-select form-select-sm w-100"
                    ></select>
                    <br>

                    <button class="btn btn-success add-product-btn" data-bs-toggle="modal"
                            data-bs-target="#addBarangModal" id="add-barang-btn">Tambah Product
                    </button>

                </div>

                <!-- Tengah: Faktur + PO Date -->
                <div class="col-md-4">
                    <label for="invoiceNumber" class="form-label">No. Faktur</label>
                    <div class="d-flex mb-2">
                        <input
                                type="text"
                                id="invoiceNumber"
                                class="form-control form-control-sm me-2"
                                placeholder="Masukkan No. Faktur"
                                required
                        />
                        <button type="button" class="btn btn-info btn-sm" onclick="cekNoFaktur(document.getElementById('invoiceNumber').value)">Cek</button>
                    </div>

                    <label for="poDate" class="form-label">PO Date</label>
                    <input
                            type="date"
                            id="poDate"
                            class="form-control form-control-sm"
                            required
                    />
                </div>

                <!-- Kanan: Pembayaran + Due Date -->
                <div class="col-md-4">
                    <label for="paymentType" class="form-label"
                    >Jenis Pembayaran</label
                    >
                    <select id="paymentType" class="form-select form-select-sm w-100">
                        <option value="tunai">Tunai</option>
                        <option value="kredit">Kredit</option>
                    </select>

                    <div class="mt-2" id="dueDateContainer" style="display: none">
                        <label for="poDueDate" class="form-label">PO Due Date</label>
                        <input
                                type="date"
                                id="poDueDate"
                                class="form-control form-control-sm"
                        />
                    </div>
                </div>
            </div>
        </div>

        <!-- TOMBOL KEMBALI -->
        <div class="d-flex align-items-start">
            <a
                    th:href="@{/pembelian}"
                    class="btn btn-warning"
                    onclick="return confirm('Apakah anda yakin ingin kembali ke main menu?');"
            >Kembali
            </a>
        </div>
    </div>

    <div class="table-responsive mb-3 scrollable-table">
        <table class="table table-bordered" id="sellTable">
            <thead class="table-light">
            <tr>
                <th style="width: 30px;font-weight:bold;background-color:white;color:black">No.</th>
                <th style="width: 200px;font-weight:bold;background-color:white;color:black">Kode</th>
                <th style="width: 550px;font-weight:bold;background-color:white;color:black">Nama</th>
                <th style="width: 80px;font-weight:bold;background-color:white;color:black">Qty</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Harga Beli</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Disc (%)</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Disc (Rp)</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Total Harga</th>
                <th style="width: 80px;font-weight:bold;background-color:white;color:black">Stok Lama</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Harga Jual Lama</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Markup 1 (%)</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Harga Jual Baru 1</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Markup 2 (%)</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Harga Jual Baru 2</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Markup 3 (%)</th>
                <th style="width: 150px;font-weight:bold;background-color:white;color:black">Harga Jual Baru 3</th>
            </tr>
            </thead>
            <tbody id="sellTableBody"></tbody>
        </table>
    </div>

    <div class="bottom-right-fixed">
        <div class="card p-3 payment-section-card">
            <div class="row">
                <div class="col">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Subtotal:</strong>
                        <span id="subTotalDisplay">Rp 0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Discount (%):</strong>
                        <input
                                type="number"
                                id="grandDiscountPercent"
                                class="form-control form-control-sm w-50 text-end"
                                value="0"
                                min="0"
                                max="100"
                        />
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Discount (Rp):</strong>
                        <input
                                type="number"
                                id="grandDiscountAmount"
                                class="form-control form-control-sm w-50 text-end"
                                value="0"
                                min="0"
                        />
                    </div>
                    <hr class="my-2"/>
                    <div
                            class="d-flex justify-content-between align-items-center mb-2"
                    >
                        <h5 class="m-0">Grand Total:</h5>
                        <h5 class="m-0 text-end" id="grandTotalDisplay">Rp 0</h5>
                    </div>
                    <div class="d-flex justify-content-end" style="margin-top:20px">
                        <div>
                            <button
                                    class="btn btn-primary btn-sm me-2"
                                    onclick="saveTransaction()"
                            >
                                Simpan
                            </button>
                            <button
                                    class="btn btn-secondary btn-sm"
                                    onclick="cancelTransaction()"
                            >
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit & Add Barang Modal -->
    <div
            class="modal fade"
            id="barangModal"
            tabindex="-1"
            aria-labelledby="editBarangLabel"
            aria-hidden="true"
    >
        <div class="modal-dialog modal-lg">
            <form th:action="@{/api/product/add}" method="post" id="barangForm">
                <div class="modal-content">
                    <div class="modal-header py-2 modalHeader">
                        <h5 class="modal-title" id="editBarangLabel">
                            Edit/Tambah Master Barang
                        </h5>
                        <button
                                type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="productId" name="productId"/>
                        <!-- Kode -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label" for="shortName">Kode Barang</label>
                            <div class="col-sm-4">
                                <input type="text" id="shortName" class="form-control" name="shortName"
                                       oninput="this.value = this.value.toUpperCase();" required/>
                            </div>
                        </div>

                        <!-- Nama Barang -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label" for="fullName">Nama Barang</label>
                            <div class="col-sm-6">
                                <input
                                        type="text"
                                        class="form-control"
                                        id="fullName"
                                        name="fullName"
                                        oninput="this.value = this.value.toUpperCase();"
                                        required
                                />
                            </div>
                        </div>

                        <!-- Supplier (Searchable Dropdown) -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label">Supplier Utama</label>
                            <div class="col-sm-4">
                                <select class="form-select highlight-field" id="supplierId" name="supplierId"
                                        required>
                                    <option value="" disabled selected>Pilih Supplier</option>
                                </select>
                            </div>
                        </div>

                        <!-- Nama Barang -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label" for="stok">Stok</label>
                            <div class="col-sm-2">
                                <input
                                        type="number"
                                        class="form-control"
                                        id="stok"
                                        name="stock"
                                        value="0"
                                        required
                                />
                            </div>
                        </div>

                        <hr/>

                        <!-- Harga Beli -->
                        <div class="mb-3">
                            <h6>Harga Beli</h6>
                            <div class="row mb-2">
                                <label class="col-sm-3 col-form-label" for="supplierPrice">Harga Beli Satuan</label>
                                <div class="col-sm-3">
                                    <input
                                            type="text"
                                            class="form-control rupiah-input"
                                            id="supplierPrice"
                                            name="supplierPrice"
                                            required
                                    />
                                </div>
                            </div>
                        </div>

                        <hr/>

                        <!-- Harga Jual -->
                        <h6>Harga Jual</h6>
                        <table class="table table-bordered table-sm align-middle">
                            <thead class="table-light">
                            <tr>
                                <th></th>
                                <th>Maks Qty</th>
                                <th>Pct</th>
                                <th>Harga Jual Satuan</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td><p>Harga Jual 1</p></td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[0].maximalCount"
                                            id="maxqty1"
                                            value="0"
                                            required/>
                                </td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="pct1"
                                            name="productPricesDTO[0].percentage"
                                            value="0"
                                            step="0.01"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm rupiah-input"
                                            name="productPricesDTO[0].price"
                                            id="hargaJual1"
                                            value="0"
                                            required/>
                                </td>
                            </tr>
                            <tr>
                                <td><p>Harga Jual 2</p></td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[1].maximalCount"
                                            value="0"
                                            id="maxqty2"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[1].percentage"
                                            id="pct2"
                                            value="0"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm rupiah-input"
                                            name="productPricesDTO[1].price"
                                            value="0"
                                            id="hargaJual2"
                                    />
                                </td>
                            </tr>
                            <tr>
                                <td><p>Harga Jual 3</p></td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[2].maximalCount"
                                            value="0"
                                            id="maxqty3"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="pct3"
                                            name="productPricesDTO[2].percentage"
                                            value="0"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm rupiah-input"
                                            name="productPricesDTO[2].price"
                                            value="0"
                                            id="hargaJual3"
                                    />
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-primary" id="addProductForm">
                            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                            <span class="btn-text">Simpan</span>
                        </button>
                        <button
                                type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                        >
                            Tutup
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="contextMenu">
    <ul>
        <li onclick="deleteRow()">🗑️ Delete Row</li>
    </ul>
</div>

<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modalHeader">
                <h5 class="modal-title">Select Product</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 5px;">

                <!-- Sticky Search Inputs -->
                <div class="sticky-top bg-white pb-2">
                    <div class="row mb-2">
                        <div class="col">
                            <input
                                    type="text"
                                    id="searchCode"
                                    class="form-control form-control-sm"
                                    placeholder="Search by Code"
                            />
                        </div>
                        <div class="col">
                            <input
                                    type="text"
                                    id="searchName"
                                    class="form-control form-control-sm"
                                    placeholder="Search by Name"
                            />
                        </div>
                    </div>
                </div>

                <!-- Scrollable Table Body -->
                <div style="max-height: 400px; overflow-y: auto;padding-bottom:10px">
                    <table class="table table-sm table-hover mb-0" id="productTable">
                        <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Stok</th>
                        </tr>
                        </thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!--    For Draggable modals-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
    $(document).ready(function () {
      $("#barangModal").draggable();
      $("#productModal").draggable();
    });
</script>
<script th:inline="javascript">
    let masterProducts = /*[[${productData}]]*/ [];
    const masterSuppliers = /*[[${supplierData}]]*/ [];
    const masterTransactions = /*[[${pembelianData}]]*/ [];
  function populateSupplierOptions() {
    const select = document.getElementById("supplierId");
    // Clear all options except the first placeholder
    select.length = 1;

    masterSuppliers.forEach((supplier) => {
      const option = document.createElement("option");
      option.value = supplier.supplierId;
      option.textContent = supplier.supplierName;
      select.appendChild(option);
    });
  }

  // Run after DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    populateSupplierOptions();
  });
</script>
<script th:inline="none">
    //Send new product to backend
    document.getElementById("addProductForm").addEventListener("click", async function () {
        const button = this;
        const spinner = button.querySelector(".spinner-border");
        const buttonText = button.querySelector(".btn-text");

        // Show spinner, disable button
        spinner.classList.remove("d-none");
        buttonText.textContent = "Menyimpan...";
        button.disabled = true;

        const form = document.getElementById("barangForm");
        const formData = new FormData(form);
        const jsonData = {};

        formData.forEach((value, key) => {
            const match = key.match(/^([^\[]+)\[(\d+)]\.(.+)$/);
            if (match) {
                const [, arrName, index, field] = match;
                jsonData[arrName] = jsonData[arrName] || [];
                jsonData[arrName][index] = jsonData[arrName][index] || {};
                jsonData[arrName][index][field] =
                    field === "price" ? parseRupiah(value) : value;
            } else {
                jsonData[key] = key.toLowerCase().includes("price")
                    ? parseRupiah(value)
                    : value;
            }
        });

        try {
            const response = await fetch("/api/product/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(jsonData),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || "Failed to save product");
            }

            const fetchResponse = await fetch("/api/product/list");
            if (!fetchResponse.ok) {
                throw new Error("Failed to fetch updated product list");
            }

            const updatedProductList = await fetchResponse.json();
            masterProducts = updatedProductList;
            console.log("update product list : ", JSON.stringify(masterProducts, null, 2));
            loadProductTable(masterProducts);

            const modal = bootstrap.Modal.getInstance(document.getElementById("barangModal"));
            modal.hide();
            form.reset();

            alert("Produk berhasil disimpan dan daftar produk diperbarui.");
            setTimeout(() => {
                focusNextEmptyRow(); // baris baru
                const nextRow = sellTableBody.lastElementChild;
                const nextCodeInput = nextRow?.querySelector(".code-input");
                nextCodeInput?.focus(); // langsung fokus ke code-input
              }, 300);
        } catch (err) {
            console.error("Error:", err);
            alert(err.message);
        } finally {
            // Hide spinner, enable button
            spinner.classList.add("d-none");
            buttonText.textContent = "Simpan";
            button.disabled = false;
        }
    });
    $(document).ready(function () {
        const barangModal = document.getElementById('barangModal');
        const barangForm = document.getElementById('barangForm');
        const rupiahFormatter = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0
        });

        const hargaBeliInput = document.getElementById("supplierPrice");
        const hargaJual1 = document.getElementById("hargaJual1");
        const hargaJual2 = document.getElementById("hargaJual2");
        const hargaJual3 = document.getElementById("hargaJual3");
        const pct1 = document.getElementById("pct1");
        const pct2 = document.getElementById("pct2");
        const pct3 = document.getElementById("pct3");
        const rupiahInputs = document.querySelectorAll(".rupiah-input");
        const rupiahPrices = document.querySelectorAll(".rupiah-price");

        // --- Helper Functions ---
        function updatePercentage(hargaJualInput, pctOutput){
            const hargaBeli = parseCurrency(hargaBeliInput.value.replace(/[^0-9]/g, '')) || 0;
            const hargaJualRaw = (hargaJualInput.value || "").toString().replace(/[^0-9.]/g, '');
            const hargaJual = parseCurrency(hargaJualRaw);

            const calculatedPct = ((hargaJual - hargaBeli) / hargaBeli) * 100;
            const result = calculatedPct.toFixed(2);
            pctOutput.value = result;
        }

        function updateHargaJual(pctInput, jualOutput) {
            const hargaBeli = parseFloat(hargaBeliInput.value.replace(/[^0-9]/g, '')) || 0;
            const percentage = parseFloat(pctInput.value) || 0;
            const calculatedHargaJual = hargaBeli + (hargaBeli * (percentage / 100));
            jualOutput.value = rupiahFormatter.format(calculatedHargaJual);
        }

        function parseCurrency(input) {
            if (!input) return 0;

            // Remove currency symbol and spaces
            let cleaned = input.replace(/[^0-9.,]/g, '');

            // Remove thousands separator
            cleaned = cleaned.replace(/\./g, '');

            // Replace decimal comma with dot
            cleaned = cleaned.replace(/,/g, '.');

            return parseFloat(cleaned) || 0;
        }

        function cleanRupiahToNumber(value) {
            return value.replace(/[^0-9]/g, '');
        }

        function clearForm() {
            barangForm.reset();
            $('#modalLabel').text('Tambah Master Barang & Jasa');
            $('#barangForm').attr('action', '/api/product/add');
            $('#productId').val(''); // Clear the hidden ID for new products
            $('#shortName').focus();
        }

        // Listener for the "Add Product" button to open the modal and clear the form.
        $('#add-barang-btn').on('click', function() {
            clearForm();
            $('#barangModal').modal('show');
        });


        // Event listeners for price and percentage inputs (remains the same)
        hargaJual1.addEventListener('input', () => updatePercentage(hargaJual1, pct1));
        hargaJual2.addEventListener('input', () => updatePercentage(hargaJual2, pct2));
        hargaJual3.addEventListener('input', () => updatePercentage(hargaJual3, pct3));
        pct1.addEventListener('input', () => updateHargaJual(pct1, hargaJual1));
        pct2.addEventListener('input', () => updateHargaJual(pct2, hargaJual2));
        pct3.addEventListener('input', () => updateHargaJual(pct3, hargaJual3));

        // Event listeners for Rupiah formatting (remains the same)
        rupiahInputs.forEach(function (input) {
            input.addEventListener("input", function () {
                let rawValue = this.value.replace(/[^0-9]/g, '');
                this.value = rawValue ? rupiahFormatter.format(rawValue) : '';
            });
            input.addEventListener("blur", function () {
                let rawValue = this.value.replace(/[^0-9]/g, '');
                this.value = rawValue ? rupiahFormatter.format(rawValue) : '';
            });
        });

        document.querySelectorAll('.rupiah-price').forEach(element => {
            const price = parseFloat(element.getAttribute('data-price'));
            if (!isNaN(price)) {
                element.textContent = rupiahFormatter.format(price);
            }
        });

        // Form submission listener to clean up Rupiah values before submission.
        document.getElementById("barangForm").addEventListener("submit", function (e) {
            e.preventDefault(); // Stop the default form submission temporarily

            // Clean Rupiah inputs by removing formatting
            rupiahInputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    input.value = cleanRupiahToNumber(input.value);
                }
            });

            this.submit();
        });
        const dirtyFlags = {
          maxqty2: false,
          maxqty3: false
        };

        function onInputChange() {
          dirtyFlags[this.id] = true; // User changed the value, mark dirty
        }

        function validateOnBlur() {
          const maxqty1 = parseInt(document.getElementById('maxqty1').value) || 0;
          const maxqty2 = parseInt(document.getElementById('maxqty2').value) || 0;
          const maxqty3 = parseInt(document.getElementById('maxqty3').value) || 0;

          if (this.id === 'maxqty2') {
            if (dirtyFlags.maxqty2 && !(maxqty2 > maxqty1)) {
              alert('Maks Qty tidak boleh lebih kecil dari nilai sebelumnya');
              dirtyFlags.maxqty2 = false;  // reset dirty flag after alert
              this.focus(); // refocus to fix
            }
          }

          if (this.id === 'maxqty3') {
            if (dirtyFlags.maxqty3 && !(maxqty3 > maxqty2 && maxqty3 > maxqty1)) {
              alert('Maks Qty tidak boleh lebih kecil dari nilai sebelumnya');
              dirtyFlags.maxqty3 = false;  // reset dirty flag after alert
              this.focus(); // refocus to fix
            }
          }
        }

        const maxqty2Input = document.getElementById('maxqty2');
        const maxqty3Input = document.getElementById('maxqty3');

        maxqty2Input.addEventListener('input', onInputChange);
        maxqty3Input.addEventListener('input', onInputChange);

        maxqty2Input.addEventListener('blur', validateOnBlur);
        maxqty3Input.addEventListener('blur', validateOnBlur);
    });
</script>
<script>
    let dynamicProductsCache = [];

    //Cek no faktur
    function cekNoFaktur(noFaktur){
        const supplierId = document.getElementById("customerSelect").value;
        if(!supplierId){
            alert("Harap pilih supplier terlebih dahulu");
            return;
        }
        const params = noFaktur + "_" + supplierId;
        const apiUrl = `/api/pembelian/cek/${params}`;

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not OK');
            }
            return response.text();
        })
        .then(data => {
            // Handle the response data from your backend
            // For example, show a message
            alert(data);
        })
        .catch(error => {
            alert('Failed to check invoice number');
        });
    }
    document.addEventListener("keydown", (e) => {
        // 🚫 Ignore if modal is visible
        const productModalEl = document.getElementById("productModal");
        if (productModalEl && productModalEl.classList.contains("show")) return;

        const activeElement = document.activeElement;
        const isInputInTable = activeElement?.closest("#sellTableBody");
        if (!isInputInTable) return;

        const currentRow = activeElement.closest("tr");
        let currentRows = [...sellTableBody.querySelectorAll("tr")];
        let currentRowIndex = currentRows.indexOf(currentRow);

        const editableInputs = [...currentRow.querySelectorAll("input:not([readonly])")];
        const currentEditableIndex = editableInputs.indexOf(activeElement);

        let nextRowIndex = currentRowIndex;
        let nextEditableIndex = currentEditableIndex;

        switch (e.key) {
            case "Enter":
                e.preventDefault();
                // go to next row
                nextRowIndex = currentRowIndex + 1;
                if (nextRowIndex >= currentRows.length) {
                    addNewRow(false); // no auto-focus
                    currentRows = [...sellTableBody.querySelectorAll("tr")]; // requery
                    nextRowIndex = currentRows.length - 1;
                }
                break;

            case "ArrowDown":
                e.preventDefault();
                nextRowIndex = currentRowIndex + 1;
                if (nextRowIndex >= currentRows.length) {
                    addNewRow(false);
                    currentRows = [...sellTableBody.querySelectorAll("tr")];
                    nextRowIndex = currentRows.length - 1;
                }
                break;

            case "ArrowUp":
                e.preventDefault();
                nextRowIndex = Math.max(0, currentRowIndex - 1);
                break;

            case "ArrowLeft":
                e.preventDefault();
                nextEditableIndex = Math.max(0, currentEditableIndex - 1);
                break;

            case "ArrowRight":
                e.preventDefault();
                nextEditableIndex = Math.min(
                    editableInputs.length - 1,
                    currentEditableIndex + 1
                );
                break;

            default:
                return;
        }

        // 🧭 Focus target cell
        const targetRow = sellTableBody.querySelectorAll("tr")[nextRowIndex];
        if (!targetRow) return;

        const targetEditableInputs = [
            ...targetRow.querySelectorAll("input:not([readonly])"),
        ];

        // Keep same column index when moving up/down
        if (e.key === "ArrowUp" || e.key === "ArrowDown" || e.key === "Enter") {
            const sameColumnInput = targetEditableInputs[currentEditableIndex];
            if (sameColumnInput) {
                sameColumnInput.focus();
                sameColumnInput.select();
                return;
            }
        }

        // For left/right, go within same row
        const targetInput = targetEditableInputs[nextEditableIndex];
        if (targetInput) {
            targetInput.focus();
            targetInput.select();
        }
    });

     document.addEventListener("DOMContentLoaded", () => {
      const addButton = document.getElementById("add-barang-btn");
      const productModalEl = document.getElementById("barangModal");
      const productModal = new bootstrap.Modal(productModalEl);

      addButton.addEventListener("click", () => {
        productModal.show();
      });

        // Set default PO Date = today
        const poDate = document.getElementById("poDate");
        const poDueDate = document.getElementById("poDueDate");

        // Get today's date in YYYY-MM-DD format
        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];
        poDate.value = todayStr;

        // Add 30 days
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + 30); // Automatically handles month/year rollovers

        const dueDateStr = dueDate.toISOString().split("T")[0];
        poDueDate.value = dueDateStr;

       const cekButton = document.querySelector(".btn-info");
       const noFakturInput = document.getElementById("invoiceNumber");

       function toggleButtonState() {
        if (noFakturInput.value.trim().length === 0) {
            cekButton.disabled = true;
        } else {
            cekButton.disabled = false;
        }
       }
        toggleButtonState();
        noFakturInput.addEventListener('input', toggleButtonState);
     });

     // Toggle PO Due Date visibility
     const paymentType = document.getElementById("paymentType");
     const dueDateContainer = document.getElementById("dueDateContainer");

     paymentType.addEventListener("change", () => {
       if (paymentType.value === "kredit") {
         dueDateContainer.style.display = "block";
       } else {
         dueDateContainer.style.display = "none";
       }
     });
   const sellTableBody = document.getElementById("sellTableBody");
   const productTableBody = document.getElementById("productTableBody");
   const searchCode = document.getElementById("searchCode");
   const searchName = document.getElementById("searchName");
   const productModalEl = document.getElementById("productModal");
   const productModal = new bootstrap.Modal(productModalEl);
  productModalEl.addEventListener("shown.bs.modal", () => {
      searchName.focus();
    });
   const subTotalDisplay = document.getElementById("subTotalDisplay");
   const grandTotalDisplay = document.getElementById("grandTotalDisplay");
   const grandDiscountPercent = document.getElementById(
     "grandDiscountPercent"
   );
   const grandDiscountAmount = document.getElementById(
     "grandDiscountAmount"
   );
   const returnAmountInput = document.getElementById("returnAmount");
   const saveButton = document.querySelector(".btn-primary");

   const transactionNumberDisplay = document.getElementById(
     "transactionNumberDisplay"
   );
   const customerSelect = document.getElementById("customerSelect");

   let selectedRow = null;
   let currentKeyboardIndex = -1;
   let activeSearchField = "shortName";

   function generateTransactionNumber() {
     const timestamp = Date.now();
     const random = Math.floor(Math.random() * 10000);
     return `#TRX${timestamp}${random}`;
   }

   function isRowEmpty(row) {
     const code = row.querySelector(".code-input").value.trim();
     return code === "";
   }

   function formatTanggalWaktuIndonesia(date = new Date()) {
     const hari = new Intl.DateTimeFormat("id-ID", {
       weekday: "long",
     }).format(date);
     const tanggal = new Intl.DateTimeFormat("id-ID", {
       day: "numeric",
       month: "long",
       year: "numeric",
     }).format(date);
     const jam = date.getHours().toString().padStart(2, "0");
     const menit = date.getMinutes().toString().padStart(2, "0");
     const detik = date.getSeconds().toString().padStart(2, "0");

     return `${hari}, ${tanggal} - ${jam}:${menit}:${detik}`;
   }

   function parseRupiah(rupiahString) {
     if (!rupiahString) return 0;
     return parseFloat(
       rupiahString.replace(/^Rp\s*|\./g, "").replace(",", ".") || 0
     );
   }

   function formatRupiah(number) {
     return (
       "Rp " +
       number.toLocaleString("id-ID", {
         minimumFractionDigits: 0,
         maximumFractionDigits: 0,
       })
     );
   }

   function handleFormattedFocus(event) {
     let value = parseRupiah(event.target.value);
     if (value === 0) {
       event.target.value = "";
     } else {
       event.target.value = value;
     }
   }

   function handleFormattedBlur(event) {
      const input = event.target;
      const row = input.closest("tr");
      const codeInput = row.querySelector(".code-input");

      // cari product di master
      const product = masterProducts.find(
        (p) => p.shortName === codeInput.value.trim()
      );

      if (product) {
        const hargaBeli = product.hargaBeli;
        const parsedValue = parseRupiah(input.value);

        // cek apakah input ini harga jual (tier berapa)
        const hargaJualMatch = [...input.classList].find(cls =>
          cls.startsWith("harga-jual-")
        );
        let tierIndex = null;
        if (hargaJualMatch) {
          tierIndex = parseInt(hargaJualMatch.replace("harga-jual-", "").replace("-input", ""));
        }

        // validasi harga jual < harga beli
        if (tierIndex && parsedValue < hargaBeli && parsedValue > 0) {
          alert(
            "Harga jual tidak boleh lebih rendah dari harga beli: " +
            formatRupiah(hargaBeli)
          );

          // koreksi harga jual pakai harga backend sesuai tier
          const correctedHargaJual = product.productPricesDTO[tierIndex - 1]?.price || hargaBeli;

          // update harga jual yang salah
          input.value = formatRupiah(correctedHargaJual);

          // ✅ update markup sesuai tier yang sama
          const markupInput = row.querySelector(`.markup-${tierIndex}-input`);
          if (markupInput) {
            const markup = ((correctedHargaJual - hargaBeli) / hargaBeli) * 100;
            markupInput.value = markup.toFixed(2);
          }

          updateTotalRow(row);
          return;
        }
      }

      // Default behavior → formatting
      const value = event.target.value.replace(/[^0-9]/g, "");
      if (value === "" || isNaN(value)) {
        event.target.value = formatRupiah(0);
      } else {
        event.target.value = formatRupiah(parseInt(value));
      }
    }

   function clearZeroOnFocus(event) {
     if (event.target.value === "0") {
       event.target.value = "";
     }
   }


    function ensureZeroOnBlur(input, decimals = 0, row = null) {
      input.addEventListener("blur", () => {
        let val = input.value.trim();

        // handle formatted rupiah
        if (val.startsWith("Rp")) {
          val = parseRupiah(val);
        }

        if (val === "" || isNaN(val)) {
          if (decimals > 0) {
            input.value = (0).toFixed(decimals);  // misal 0.00
          } else {
            input.value = "0";
          }
        }

        // ✅ kalau ada row, update subtotal row & grand total
        if (row) {
          updateTotalRow(row);
        } else {
          calculateGrandTotal();
        }
      });
    }

    function ensureOneOnBlur(input, decimals = 0, row = null) {
      input.addEventListener("blur", () => {
        let val = input.value.trim();

        if (val === "" || isNaN(val)) {
          if (decimals > 0) {
            input.value = (0).toFixed(decimals);  // misal 0.00
          } else {
            input.value = "1";
          }
        }
        // ✅ kalau ada row, update subtotal row & grand total
        if (row) {
          updateTotalRow(row);
        } else {
          calculateGrandTotal();
        }
      });
    }

   function addNewRow(focus = true) {
     const rows = sellTableBody.querySelectorAll("tr");
     if (rows.length > 0) {
       const lastRowCodeInput =
         rows[rows.length - 1].querySelector(".code-input");
       if (lastRowCodeInput && lastRowCodeInput.value.trim() === "") {
         if (focus) {
           lastRowCodeInput.focus();
         }
         return;
       }
     }
     const rowNumber = rows.length + 1;
     const row = document.createElement("tr");

     row.innerHTML = `
<td class="row-number">${rowNumber}</td>
<td><input type="text" class="form-control form-control-sm code-input" /></td>
<td><input type="text" class="form-control form-control-sm name-input" readonly /></td>
<td><input type="number" class="form-control form-control-sm qty-input" min="1" value="1" /></td>
<td><input type="text" class="form-control form-control-sm price-input" /></td>
<td><input type="number" class="form-control form-control-sm discount-percent-input" min="0" max="100" value="0" /></td>
<td><input type="number" class="form-control form-control-sm discount-amount-input" min="0" value="0" /></td>
<td class="total-cell">Rp 0</td>
<td><input type="number" class="form-control form-control-sm stok-input" value="0" readonly/></td>
<td><input type="text" class="form-control form-control-sm harga-jual-lama" value="0" readonly/></td>
<td><input type="number" class="form-control form-control-sm markup-1-input" value="0" /></td>
<td><input type="text" class="form-control form-control-sm harga-jual-1-input" value="${formatRupiah(0)}"/></td>
<td><input type="number" class="form-control form-control-sm markup-2-input" value="0" /></td>
<td><input type="text" class="form-control form-control-sm harga-jual-2-input" value="${formatRupiah(0)}" /></td>
<td><input type="number" class="form-control form-control-sm markup-3-input" value="0"/></td>
<td><input type="text" class="form-control form-control-sm harga-jual-3-input" value="${formatRupiah(0)}"/></td>
`;

     sellTableBody.appendChild(row);

     const codeInput = row.querySelector(".code-input");
     const nameInput = row.querySelector(".name-input");
     const priceInput = row.querySelector(".price-input");
     const qtyInput = row.querySelector(".qty-input");
     const discPercentInput = row.querySelector(".discount-percent-input");
     const discAmountInput = row.querySelector(".discount-amount-input");
     const markUp1Input = row.querySelector(".markup-1-input");
     const hargaJual1Input = row.querySelector(".harga-jual-1-input");
     const markUp2Input = row.querySelector(".markup-2-input");
     const hargaJual2Input = row.querySelector(".harga-jual-2-input");
     const markUp3Input = row.querySelector(".markup-3-input");
     const hargaJual3Input = row.querySelector(".harga-jual-3-input");

     // Optional: also allow double-click on codeInput itself
    codeInput.addEventListener("dblclick", () => {
      selectedRow = row;
      productModal.show();
      loadProductTable();
    });
     // tambahkan auto-set 0 on blur
    [discPercentInput, discAmountInput, markUp1Input, markUp2Input, markUp3Input]
      .forEach(inp => ensureZeroOnBlur(inp, 2, row));  // 0.00 untuk disc/markup

    [priceInput, hargaJual1Input, hargaJual2Input, hargaJual3Input]
      .forEach(inp => ensureZeroOnBlur(inp, 0, row));  // integer → 0

    [qtyInput].forEach(inp => ensureOneOnBlur(inp, 0, row));
    hargaJual1Input.addEventListener("focus", handleFormattedFocus);
    hargaJual1Input.addEventListener("blur", handleFormattedBlur);
    hargaJual2Input.addEventListener("focus", handleFormattedFocus);
    hargaJual2Input.addEventListener("blur", handleFormattedBlur);
    hargaJual3Input.addEventListener("focus", handleFormattedFocus);
    hargaJual3Input.addEventListener("blur", handleFormattedBlur);

     priceInput.addEventListener("focus", handleFormattedFocus);
     priceInput.addEventListener("blur", handleFormattedBlur);
     priceInput.addEventListener("input", () => {
        updateMarkups(row)
       updateTotalRow(row);
     });

     qtyInput.addEventListener("focus", clearZeroOnFocus);
     discPercentInput.addEventListener("focus", clearZeroOnFocus);
     discAmountInput.addEventListener("focus", clearZeroOnFocus);

     grandDiscountPercent.addEventListener("focus", clearZeroOnFocus);
     grandDiscountAmount.addEventListener("focus", clearZeroOnFocus);

     [discPercentInput, discAmountInput].forEach((inp) => {
          inp.addEventListener("blur", () => {
            if (inp.value.trim() === "" || isNaN(parseFloat(inp.value))) {
              inp.value = "0";
            }
          });
        });

     if (focus) codeInput.focus();
        codeInput.addEventListener("keydown", async (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
              selectedRow = row;
              loadProductTable();
              productModal.show();
              return;
            }

            // 🔍 Cari produk di masterProducts dulu
            let product = masterProducts.find((p) => p.shortName === code);

            // 🚀 Kalau belum ada, fetch ke backend
            if (!product) {
              try {
                const res = await fetch(`/products/find?keyword=${encodeURIComponent(code)}`);
                if (res.ok) {
                  const result = await res.json();
                  if (result) {
                    product = result;
                    // ✅ Simpan ke cache agar validasi harga jual bisa pakai data B ini
                    dynamicProductsCache.push(product);
                  }
                }
              } catch (err) {
                console.error("Error fetching product:", err);
              }
            }

            if (product) {
              // 🔁 Cek apakah produk ini sudah ada di baris lain
              const existingRow = [...sellTableBody.querySelectorAll("tr")].find((r) => {
                const existingCode = r.querySelector(".code-input").value.trim().toUpperCase();
                return existingCode === code;
              });

              if (existingRow && existingRow !== row) {
                // ✅ Kalau sudah ada → tambahkan qty dan update total
                const qtyInput = existingRow.querySelector(".qty-input");
                qtyInput.value = parseInt(qtyInput.value || "0") + 1;
                updateTotalRow(existingRow);

                // Kosongkan input baru agar tidak duplikat
                codeInput.value = "";
                codeInput.focus();
                return;
              }

              // 🔹 Kalau produk baru → isi data ke baris ini
              fillProductRow(row, product);
              maybeAddNewRow();
            } else {
              alert("Product not found");
              codeInput.value = "";
              codeInput.focus();
            }
          }
        });

     qtyInput.addEventListener("input", () => {
       const qty = parseInt(qtyInput.value) || 0;
       const code = codeInput.value.trim();
<!--       const product = masterProducts.find((p) => p.shortName === code);-->

       updateTotalRow(row);
     });

      markUp1Input.addEventListener("input", () => {
          let val = markUp1Input.value;

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markUp1Input.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(row.querySelector(".price-input").value);
          const markUp1Percent = parseFloat(markUp1Input.value) || 0;
          const markUp1Amount = price + ((markUp1Percent * price) / 100)
          hargaJual1Input.value = Math.round(markUp1Amount)
          updateTotalRow(row);
        });

      hargaJual1Input.addEventListener("input", () => {
           const price = parseRupiah(row.querySelector(".price-input").value);
           const qty = parseInt(qtyInput.value) || 0;
           const hargaJual1 = parseFloat(hargaJual1Input.value) || 0;
           const markUp1 = ((hargaJual1 - price) / price) * 100;
           markUp1Input.value = isFinite(markUp1) ? markUp1.toFixed(2) : "0" ;
           updateTotalRow(row);
      });

      markUp2Input.addEventListener("input", () => {
          let val = markUp2Input.value;

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markUp2Input.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(row.querySelector(".price-input").value);
          const markUp2Percent = parseFloat(markUp2Input.value) || 0;
          const markUp2Amount = price + ((markUp2Percent * price) / 100)
          hargaJual2Input.value = Math.round(markUp2Amount)
          updateTotalRow(row);
        });

      hargaJual2Input.addEventListener("input", () => {
           const price = parseRupiah(row.querySelector(".price-input").value);
           const qty = parseInt(qtyInput.value) || 0;
           const hargaJual2 = parseFloat(hargaJual2Input.value) || 0;
           const markUp2 = ((hargaJual2 - price) / price) * 100;
           markUp2Input.value = isFinite(markUp2) ? markUp2.toFixed(2) : "0" ;
           updateTotalRow(row);
      });

      markUp3Input.addEventListener("input", () => {
          let val = markUp3Input.value;

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markUp3Input.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(row.querySelector(".price-input").value);
          const markUp3Percent = parseFloat(markUp3Input.value) || 0;
          const markUp3Amount = price + ((markUp3Percent * price) / 100)
          hargaJual3Input.value = Math.round(markUp3Amount)
          updateTotalRow(row);
        });

      hargaJual3Input.addEventListener("input", () => {
           hargaJual3Input.value = hargaJual3Input.value.replace(/[^0-9.]/g, '');
           const price = parseRupiah(row.querySelector(".price-input").value);
           const qty = parseInt(qtyInput.value) || 0;
           const hargaJual3 = parseFloat(hargaJual3Input.value) || 0;
           const markUp3 = ((hargaJual3 - price) / price) * 100;
           markUp3Input.value = isFinite(markUp3) ? markUp3.toFixed(2) : "0" ;
           updateTotalRow(row);
      });

     discPercentInput.addEventListener("input", () => {
          let val = discPercentInput.value;

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            discPercentInput.value = intPart + "." + decPart.slice(0, 2);
          }

          const price = parseRupiah(row.querySelector(".price-input").value);
          const qty = parseInt(qtyInput.value) || 0;
          const discountPercent = parseFloat(discPercentInput.value) || 0;

          if (price * qty > 0) {
            const discountAmount = price * qty * (discountPercent / 100);
            discAmountInput.value = Math.round(discountAmount);
          } else {
            discAmountInput.value = "0";
          }
          updateTotalRow(row);
     });

     discAmountInput.addEventListener("input", () => {
       const price = parseRupiah(row.querySelector(".price-input").value);
       const qty = parseInt(qtyInput.value) || 0;
       const discountAmount = parseFloat(discAmountInput.value) || 0;

       if (price * qty > 0 ) {
         const discountPercent = (discountAmount / (price * qty)) * 100;
         discPercentInput.value = isFinite(discountPercent) ? discountPercent.toFixed(2) : "0" ;
       } else {
         discPercentInput.value = "0";
       }
       updateTotalRow(row);
     });

     row.addEventListener("contextmenu", function (e) {
       e.preventDefault();
       selectedRow = row;
       showContextMenu(e.pageX, e.pageY);
     });
     calculateGrandTotal();
   }

   function maybeAddNewRow() {
     const rows = [...sellTableBody.querySelectorAll("tr")];
     const lastRow = rows[rows.length - 1];
     const codeVal = lastRow.querySelector(".code-input").value.trim();
     if (codeVal) {
       addNewRow();
     }
   }

   function fillProductRow(row, product) {
        console.log("product : ", product);
      const qty = 1; // default qty
      row.querySelector(".code-input").value = product.shortName;
      row.querySelector(".name-input").value = product.fullName;
      row.querySelector(".price-input").value = formatRupiah(product.hargaBeli);
      row.querySelector(".qty-input").value = qty;
      row.querySelector(".discount-percent-input").value = 0;
      row.querySelector(".discount-amount-input").value = 0;
      row.querySelector(".stok-input").value = product.stok;
      row.querySelector(".harga-jual-lama").value = formatRupiah(product.productPricesDTO[0].price);

      const tiers = product.productPricesDTO;

      // loop harga jual 1, 2, 3
      tiers.forEach((tier, i) => {
        const markupInput = row.querySelector(`.markup-${i+1}-input`);
        const hargaInput = row.querySelector(`.harga-jual-${i+1}-input`);

        if (tier && tier.price > 0) {
          // ✅ ada harga jual dari backend → isi & enabled
          markupInput.value = ((tier.price - product.hargaBeli) / product.hargaBeli * 100).toFixed(2);
          markupInput.disabled = false;
          hargaInput.value = formatRupiah(tier.price);
          hargaInput.disabled = false;
        } else {
          // ❌ tidak ada harga jual → disable
          markupInput.value = 0;
          markupInput.disabled = true;
          hargaInput.value = formatRupiah(0);
          hargaInput.disabled = true;
        }
      });

      updateTotalRow(row);
    }

   function updateTotalRow(r) {
     const price = parseRupiah(r.querySelector(".price-input").value);
     const qty = parseInt(r.querySelector(".qty-input").value) || 0;
     const discAmount =
       parseFloat(r.querySelector(".discount-amount-input").value) || 0;
     const subtotal = price * qty;
     const total = subtotal - discAmount;
     r.querySelector(".total-cell").textContent =
       "Rp " + total.toLocaleString("id-ID");
     calculateGrandTotal();
   }

   function selectProduct(product) {
      const rows = [...sellTableBody.querySelectorAll("tr")];

      // ---- First, check if product already exists in any row ----
      let existingRow = rows.find(r => {
        const code = r.querySelector(".code-input").value.trim().toUpperCase();
        return code === product.shortName;
      });

      if (existingRow) {
        // ✅ Increase qty if already exists
        const qtyInput = existingRow.querySelector(".qty-input");
        qtyInput.value = parseInt(qtyInput.value || "0") + 1;
        updateTotalRow(existingRow);

        productModal.hide();
        selectedRow = null;
        return; // stop here, no duplicates
      }

      // ---- If product not already in table ----
      if (selectedRow) {
        // ✅ Replace that specific row (from modal click)
        fillProductRow(selectedRow, product);
        selectedRow.querySelector(".qty-input").value = 1;
        selectedRow.querySelector(".discount-percent-input").value = "0";
        selectedRow.querySelector(".discount-amount-input").value = "0";
        updateTotalRow(selectedRow);

        productModal.hide();
        selectedRow = null;
        return; // stop here
      }

      // ---- Normal flow (manual typing/scan, new row needed) ----
      let targetRow = rows.find(r => {
        const code = r.querySelector(".code-input").value.trim();
        return code === "";
      });

      if (!targetRow) {
        addNewRow(false);
        targetRow = sellTableBody.lastElementChild;
      }

      fillProductRow(targetRow, product);
      targetRow.querySelector(".qty-input").value = 1;
      updateTotalRow(targetRow);
      maybeAddNewRow();

      productModal.hide();

      setTimeout(() => {
        focusNextEmptyRow();
      }, 200);
    }

   function calculateGrandTotal() {
     let subtotal = 0;
     let totalDiscount = 0;
     const rows = sellTableBody.querySelectorAll("tr");
     rows.forEach((row) => {
       const price = parseRupiah(row.querySelector(".price-input").value);
       const qty = parseInt(row.querySelector(".qty-input").value) || 0;
       const discAmt = parseFloat(row.querySelector(".discount-amount-input").value) || 0;

       if (price && qty) {
         subtotal += price * qty;
         totalDiscount += discAmt;
       }
     });

     const grandDiscPercent = parseFloat(grandDiscountPercent.value) || 0;
     const grandDiscAmount = parseFloat(grandDiscountAmount.value) || 0;

     let finalDiscount = totalDiscount;
     if (grandDiscPercent > 0) {
       finalDiscount += subtotal * (grandDiscPercent / 100);
     } else {
       finalDiscount += grandDiscAmount;
     }

     const grandTotal = subtotal - finalDiscount;

     subTotalDisplay.textContent = "Rp " + subtotal.toLocaleString("id-ID");
     grandTotalDisplay.textContent =
       "Rp " + Math.max(0, grandTotal).toLocaleString("id-ID");

     calculateReturnAmount();
   }

   function calculateReturnAmount() {
     const grandTotal =
       parseFloat(
         grandTotalDisplay.textContent
           .replace("Rp ", "")
           .replace(/\./g, "")
           .replace(",", ".")
       ) || 0;
     saveButton.disabled =
       sellTableBody.querySelectorAll("tr").length === 0 || grandTotal === 0;
   }

   grandDiscountPercent.addEventListener("input", () => {
     updateGrandDiscountAmount();
   });

   grandDiscountAmount.addEventListener("input", () => {
     updateGrandDiscountPercent();
   });

   function updateGrandDiscountAmount() {
     const subtotal =
       parseFloat(
         subTotalDisplay.textContent.replace("Rp ", "").replace(/\./g, "")
       ) || 0;
     const discountPercent = parseFloat(grandDiscountPercent.value) || 0;

     if (subtotal > 0 && discountPercent >= 0) {
       const discountAmount = subtotal * (discountPercent / 100);
       grandDiscountAmount.value = discountAmount.toFixed(0);
     } else {
       grandDiscountAmount.value = 0;
     }
     calculateGrandTotal();
   }

   function updateGrandDiscountPercent() {
     const subtotal =
       parseFloat(
         subTotalDisplay.textContent.replace("Rp ", "").replace(/\./g, "")
       ) || 0;
     const discountAmount = parseFloat(grandDiscountAmount.value) || 0;

     if (subtotal > 0 && discountAmount >= 0) {
       const discountPercent = (discountAmount / subtotal) * 100;
       grandDiscountPercent.value = discountPercent.toFixed(2);
     } else {
       grandDiscountPercent.value = 0;
     }
     calculateGrandTotal();
   }

   function loadProductTable(filteredProducts = masterProducts) {
     productTableBody.innerHTML = "";
     let rows = [];

     filteredProducts.forEach((product, index) => {
       const row = document.createElement("tr");
       row.setAttribute("data-index", index);
       row.tabIndex = 0;
       row.style.cursor = "pointer";

       row.innerHTML = `
 <td>${product.shortName}</td>
 <td>${product.fullName}</td>
 <td>Rp ${product.productPricesDTO[0].price.toLocaleString("id-ID")}</td>
 <td>${product.stok}</td>
`;

       row.addEventListener("dblclick", () => {
         selectProduct(product);
       });

        // ⭐ added: Mouse click = behave like arrow key highlight
        row.addEventListener("click", () => {
          // remove highlight from all rows
          rows.forEach(r => r.classList.remove("table-active"));
          // highlight clicked row
          row.classList.add("table-active");
          // keep index in sync with keyboard navigation
          currentKeyboardIndex = parseInt(row.getAttribute("data-index"));
          // focus row (so Enter works naturally)
          row.focus();
        });

        // 🔑 Press Enter to select
        row.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                selectProduct(product);
            }
        });

       productTableBody.appendChild(row);
       rows.push(row);
     });

     currentKeyboardIndex = -1;
     highlightRow(null);

     document.onkeydown = null;

     document.onkeydown = function (e) {
       if (!productModalEl.classList.contains("show")) return;

       const activeElement = document.activeElement;
       const isInSearch =
         activeElement === searchCode || activeElement === searchName;

       switch (e.key) {
         case "ArrowDown":
           e.preventDefault();
           if (rows.length === 0) return;

           if (isInSearch) {
             currentKeyboardIndex = 0;
             highlightRow(rows[currentKeyboardIndex]);
             rows[currentKeyboardIndex].focus();
           } else {
             if (currentKeyboardIndex < rows.length - 1)
               currentKeyboardIndex++;
             highlightRow(rows[currentKeyboardIndex]);
             rows[currentKeyboardIndex].focus();
           }
           break;

         case "ArrowUp":
           e.preventDefault();
           if (rows.length === 0) return;

           if (!isInSearch) {
             if (currentKeyboardIndex > 0) currentKeyboardIndex--;
             highlightRow(rows[currentKeyboardIndex]);
             rows[currentKeyboardIndex].focus();
           }
           break;

         case "ArrowLeft":
           e.preventDefault();
           searchCode.focus();
           break;

         case "ArrowRight":
           e.preventDefault();
           searchName.focus();
           break;

         case "Enter":
           e.preventDefault();

           if (isInSearch) {
             doFilter();
           } else {
             if (currentKeyboardIndex >= 0 && rows[currentKeyboardIndex]) {
               const selectedCode = rows[currentKeyboardIndex]
                 .querySelector("td")
                 .textContent.trim();
               const selected = masterProducts.find(
                 (p) => p.shortName === selectedCode
               );
               if (selected) selectProduct(selected);
             }
           }
           break;
       }
     };

     function highlightRow(row) {
       rows.forEach((r) => r.classList.remove("table-active"));
       if (row) {
         row.classList.add("table-active");
         row.scrollIntoView({ block: "nearest", behavior: "smooth" });
       }
     }
   }

   searchCode.addEventListener("focus", () => {
     activeSearchField = "shortName";
   });

   searchName.addEventListener("focus", () => {
     activeSearchField = "fullName";
   });

    async function doFilter() {
        const keyword = activeSearchField === "shortName"
            ? searchCode.value.trim()
            : searchName.value.trim();

        if (!keyword) {
            loadProductTable(masterProducts);
            return;
        }

        try {
            const field = activeSearchField;
            const response = await fetch(`/products/search?keyword=${encodeURIComponent(keyword)}&field=${field}`);

            if (!response.ok) {
                throw new Error("Failed to fetch products");
            }

            const filteredProducts = await response.json();

            if (!filteredProducts || filteredProducts.length === 0) {
                loadProductTable([]);
                return;
            }

            loadProductTable(filteredProducts);
        } catch (err) {
            console.error(err);
            alert("Gagal mencari produk: " + err.message);
            loadProductTable(masterProducts); // fallback ke semua produk
        }
    }

   [searchCode, searchName].forEach((input) => {
     input.addEventListener("keydown", (e) => {
       if (e.key === "Enter") {
         e.preventDefault();
         doFilter();
       }
     });
   });

   function showContextMenu(x, y) {
     const menu = document.getElementById("contextMenu");
     menu.style.top = `${y}px`;
     menu.style.left = `${x}px`;
     menu.style.display = "block";
   }

   function deleteRow() {
     if (selectedRow) {
       selectedRow.remove();
       selectedRow = null;
       document.getElementById("contextMenu").style.display = "none";

       reindexRows();

       if (sellTableBody.querySelectorAll("tr").length === 0) {
         addNewRow();
       }
       calculateGrandTotal();
     }
   }
   function reindexRows() {
      const rows = sellTableBody.querySelectorAll("tr");
      rows.forEach((row, index) => {
        // Assuming the first cell (td) contains the row number
        row.cells[0].textContent = index + 1;
      });
    }

   document.addEventListener("click", () => {
     document.getElementById("contextMenu").style.display = "none";
   });

   productModalEl.addEventListener("hidden.bs.modal", () => {
     searchCode.value = "";
     searchName.value = "";
     loadProductTable();
     focusNextEmptyRow();
   });

   function focusNextEmptyRow() {
     const rows = [...sellTableBody.querySelectorAll("tr")];
     for (const row of rows) {
       const codeInput = row.querySelector(".code-input");
       const nameInput = row.querySelector(".name-input");
       if (codeInput.value.trim() === "" && nameInput.value.trim() === "") {
         codeInput.focus();
         return;
       }
     }
     addNewRow(true);
   }

   function loadCustomers() {
     customerSelect.innerHTML =
       '<option value="">-- Pilih Supplier --</option>';
     masterSuppliers.forEach((supplier) => {
       const option = document.createElement("option");
       const newOption = `<option value="${supplier.supplierId}">${supplier.supplierName}</option>`;
       customerSelect.insertAdjacentHTML("beforeend", newOption);
     });
   }

   function cleanUpRowsBeforeSave() {
        const rows = [...sellTableBody.querySelectorAll("tr")];

        rows.forEach((row) => {
            const code = row.querySelector(".code-input")?.value.trim();
            const name = row.querySelector(".name-input")?.value.trim();
            const qty = row.querySelector(".qty-input")?.value.trim();

            const isFullyFilled = code && name && qty;
            console.log("valid : ", isFullyFilled);
            if (!isFullyFilled) {
                // Hapus baris yang tidak lengkap
                row.remove();
            }
        });
    }

    function validateMarkups() {
      const rows = [...sellTableBody.querySelectorAll("tr")];
      for (const row of rows) {
        const code = row.querySelector(".code-input")?.value.trim();
        if (!code) continue; // skip empty rows

        const markups = [
          row.querySelector(".markup-1-input"),
          row.querySelector(".markup-2-input"),
          row.querySelector(".markup-3-input")
        ];

        for (const markupInput of markups) {
          if (!markupInput.disabled) { // only check active ones
            const val = parseFloat(markupInput.value) || 0;
            if (val <= 0) {
              alert(`Markup tidak valid pada produk ${code}. Harus lebih dari 0.`);
              return false; // stop checking
            }
          }
        }
      }
      return true; // all good
    }

   async function saveTransaction() {
     if (!validateMarkups()) {
        return; // stop save
      }
     const grandTotal =
       parseFloat(
         grandTotalDisplay.textContent
           .replace("Rp ", "")
           .replace(/\./g, "")
           .replace(",", ".")
       ) || 0;
     if (
       sellTableBody.querySelectorAll("tr").length === 0 ||
       grandTotal === 0
     ) {
       alert("Transaction cannot be saved with no items.");
       return;
     }

     const isCash = document.getElementById("paymentType").value === "tunai";
        let poDueDate = null;
        const poDueDateInput = document.getElementById("poDueDate");

        if (!isCash) {
            if (!poDueDateInput || !poDueDateInput.value) {
                alert("PO Due Date wajib diisi untuk pembayaran Kredit.");
                return;
            }
            poDueDate = poDueDateInput.value;
        }

     const selectedCustomerId = customerSelect.value;
     if(!selectedCustomerId){
        alert("Nama supplier tidak boleh kosong");
        return;
     }
     const selectedCustomer = masterSuppliers.find(
       (c) => c.supplierId == selectedCustomerId
     );

     const purchasingNumberInput = document.getElementById("invoiceNumber").value;
     if(!purchasingNumberInput){
        alert("Nomor Faktur tidak boleh kosong");
        return;
     }

     const poDateInput = document.getElementById("poDate").value;
     if(!poDateInput){
        alert("Tanggal Faktur tidak boleh kosong");
        return;
     }
     // ⭐ Clean up half-typed rows before collecting data
    cleanUpRowsBeforeSave();

     const transactionData = {
       supplierId: selectedCustomer.supplierId,
       purchasingNumber: purchasingNumberInput,
       pembelianDetailDTOS: [],
       subtotal: parseFloat(
         subTotalDisplay.textContent
           .replace("Rp ", "")
           .replace(/\./g, "")
           .replace(",", ".")
       ),
       totalDisc: parseFloat(grandDiscountAmount.value) || 0,
       totalPrice: grandTotal,
       isCash: isCash,
       poDate: document.getElementById("poDate").value,
       poDueDate: poDueDate
     };

     sellTableBody.querySelectorAll("tr").forEach((row) => {
       const code = row.querySelector(".code-input").value;
<!--       const product = masterProducts.find(p => p.shortName === code);-->
<!--       if (!code || !product) {-->
<!--         return;-->
<!--       }-->
       if (code) {
         transactionData.pembelianDetailDTOS.push({
           code: code,
           name: row.querySelector(".name-input").value,
           price: parseRupiah(row.querySelector(".price-input").value),
           qty: parseInt(row.querySelector(".qty-input").value),
           discAmount: parseFloat(
             row.querySelector(".discount-amount-input").value
           ),
           total: parseFloat(
             row
               .querySelector(".total-cell")
               .textContent.replace("Rp ", "")
               .replace(/\./g, "")
               .replace(",", ".")
           ),
           markup1: row.querySelector(".markup-1-input").value,
           markup2: row.querySelector(".markup-2-input").value,
           markup3: row.querySelector(".markup-3-input").value,
           hargaJual1: parseRupiah(row.querySelector(".harga-jual-1-input").value),
           hargaJual2: parseRupiah(row.querySelector(".harga-jual-2-input").value),
           hargaJual3: parseRupiah(row.querySelector(".harga-jual-3-input").value),
         });
       }
     });
     try {
      console.log("transaction data : ", JSON.stringify(transactionData, null, 2));
      let response;
      if (
        masterTransactions.pembelianId !== null &&
        masterTransactions.pembelianDetailDTOS !== null
      ) {
        response = await fetch(`/api/pembelian/edit/${masterTransactions.pembelianId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(transactionData),
        });
      } else {
        response = await fetch("/api/pembelian/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(transactionData),
        });
      }

      if (!response.ok) {
        const errorMessage = await response.text();
        throw new Error(`${errorMessage}`);
      }

      const result = await response.text();
      alert("Transaction saved successfully!");

      if (
        masterTransactions.transactionId !== null &&
        masterTransactions.pembelianDetailDTOS !== null
      ) {
        window.location.href = "/pembelian";
      } else {
        window.location.href = "/pembelian/tambah";
      }

    } catch (error) {
      console.error("Failed to save transaction:", error.message);
      alert(`Gagal menyimpan data, ${error.message}`);
    }
   }

   function cancelTransaction() {
    location.reload();
   }

   function updateJam() {
     transactionNumberDisplay.textContent = formatTanggalWaktuIndonesia();
   }

   function attachNavigationHandlers(row) {
      const inputs = [...row.querySelectorAll("input:not([readonly])")];

      inputs.forEach((input) => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const currentRow = e.target.closest("tr");
            const lastRow = sellTableBody.lastElementChild;

            if (currentRow === lastRow && !isRowEmpty(currentRow)) {
              maybeAddNewRow();
            }

            const nextRow = currentRow.nextElementSibling;
            if (nextRow) {
              nextRow.querySelector(".code-input").focus();
            }
          } else if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
            e.preventDefault();

            const rows = [...sellTableBody.querySelectorAll("tr")];
            const currentRowIndex = rows.indexOf(row);
            const currentInputs = [...row.querySelectorAll("input:not([readonly])")];
            const currentInputIndex = currentInputs.indexOf(e.target);

            let nextRowIndex = currentRowIndex;
            let nextInputIndex = currentInputIndex;

            if (e.key === "ArrowUp") nextRowIndex = Math.max(0, currentRowIndex - 1);
            if (e.key === "ArrowDown") nextRowIndex = Math.min(rows.length - 1, currentRowIndex + 1);
            if (e.key === "ArrowLeft") nextInputIndex = Math.max(0, currentInputIndex - 1);
            if (e.key === "ArrowRight") nextInputIndex = Math.min(currentInputs.length - 1, currentInputIndex + 1);

            const targetRow = rows[nextRowIndex];
            const targetInputs = [...targetRow.querySelectorAll("input:not([readonly])")];
            const targetInput = targetInputs[nextInputIndex];

            if (targetInput) {
              targetInput.focus();
              if (["ArrowLeft", "ArrowRight", "ArrowDown", "ArrowUp"].includes(e.key)) {
                targetInput.select();
              }
            }
          }
        });
      });
    }

    function attachMarkupHandlers(row) {
      const priceInput = row.querySelector(".price-input");
      const qtyInput = row.querySelector(".qty-input");

      const markUp1Input = row.querySelector(".markup-1-input");
      const hargaJual1Input = row.querySelector(".harga-jual-1-input");
      const markUp2Input = row.querySelector(".markup-2-input");
      const hargaJual2Input = row.querySelector(".harga-jual-2-input");
      const markUp3Input = row.querySelector(".markup-3-input");
      const hargaJual3Input = row.querySelector(".harga-jual-3-input");

      function bindMarkup(markupInput, hargaJualInput) {
        // markup → harga jual
        markupInput.addEventListener("input", () => {
          let val = markupInput.value;
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markupInput.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(priceInput.value);
          const percent = parseFloat(markupInput.value) || 0;
          const newHarga = price + (percent * price) / 100;
          hargaJualInput.value = Math.round(newHarga);
          updateTotalRow(row);
        });

        // harga jual → markup
        hargaJualInput.addEventListener("input", () => {
          hargaJualInput.value = hargaJualInput.value.replace(/[^0-9.]/g, "");
          const price = parseRupiah(priceInput.value);
          const newHarga = parseFloat(hargaJualInput.value) || 0;
          const newMarkup = ((newHarga - price) / price) * 100;
          markupInput.value = isFinite(newMarkup) ? newMarkup.toFixed(2) : "0";
          updateTotalRow(row);
        });

        hargaJualInput.addEventListener("focus", handleFormattedFocus);
        hargaJualInput.addEventListener("blur", handleFormattedBlur);
      }

      bindMarkup(markUp1Input, hargaJual1Input);
      bindMarkup(markUp2Input, hargaJual2Input);
      bindMarkup(markUp3Input, hargaJual3Input);
    }

    function updateMarkups(row) {
      const price = parseRupiah(row.querySelector(".price-input").value);

      const hargaJual1 = parseRupiah(row.querySelector(".harga-jual-1-input").value);
      const hargaJual2 = parseRupiah(row.querySelector(".harga-jual-2-input").value);
      const hargaJual3 = parseRupiah(row.querySelector(".harga-jual-3-input").value);

      const markUp1Input = row.querySelector(".markup-1-input");
      const markUp2Input = row.querySelector(".markup-2-input");
      const markUp3Input = row.querySelector(".markup-3-input");

      const markup1 = ((hargaJual1 - price) / price) * 100;
      const markup2 = ((hargaJual2 - price) / price) * 100;
      const markup3 = ((hargaJual3 - price) / price) * 100;

      markUp1Input.value = isFinite(markup1) ? markup1.toFixed(2) : "0";
      markUp2Input.value = isFinite(markup2) ? markup2.toFixed(2) : "0";
      markUp3Input.value = isFinite(markup3) ? markup3.toFixed(2) : "0";
    }


   async function loadTransaction(transaction) {
     while (sellTableBody.firstChild) {
        sellTableBody.removeChild(sellTableBody.firstChild);
      }
      // Clear the current sales table
      sellTableBody.innerHTML = "";

      // Set the grand total discounts and customer
      if (transaction.subtotal > 0) {
        const discountPercent = (transaction.totalDisc / transaction.subtotal) * 100;
        grandDiscountPercent.value = discountPercent.toFixed(2);
      } else {
        grandDiscountPercent.value = "0.00";
      }
      grandDiscountAmount.value = transaction.totalDisc;

      // Set customer if you want
      if (transaction.supplierDTO.supplierId) {
        customerSelect.value = transaction.supplierDTO.supplierId;
      }

      // Insert no faktur, poDate, jenis pembayaran, poDueDate
      if (transaction.noFaktur) {
        document.getElementById("invoiceNumber").value = transaction.noFaktur;
      }

      window.addEventListener("load", function () {
        const poDateInput = document.getElementById("poDate");
        if (poDateInput && transaction.tanggalBeli) {
          poDateInput.value = transaction.tanggalBeli.split("T")[0];
        }

        if (transaction.cash === true) {
          document.getElementById("paymentType").value = "tunai";
        } else {
          document.getElementById("paymentType").value = "kredit";
          document.getElementById("dueDateContainer").style.display = "block";
          if (transaction.tanggalTempo) {
            document.getElementById("poDueDate").value = transaction.tanggalTempo.split("T")[0];
          }
        }

        if (transaction.isCash === false) {
          document.getElementById("poDueDate").value = transaction.tanggalTempo.split("T")[0];
        }
      });

      // ✅ Ganti forEach → for...of agar bisa pakai await
      for (const [index, detail] of transaction.pembelianDetailDTOS.entries()) {
        const row = document.createElement("tr");

        // Simpan data original
        row.dataset.originalCode = detail.code;
        row.dataset.originalName = detail.name;
        row.dataset.originalPrice = detail.price;
        row.dataset.originalQty = detail.qty;
        row.dataset.originalDiscountPercent = detail.discountPercent || "0";
        row.dataset.originalDiscountAmount = detail.discountAmount || "0";
        row.dataset.originalTotal = detail.total || "Rp 0";

        row.innerHTML = `
          <td class="row-number">${index + 1}</td>
          <td><input type="text" class="form-control form-control-sm code-input" value="${detail.code}" /></td>
          <td><input type="text" class="form-control form-control-sm name-input" readonly value="${detail.name}" /></td>
          <td><input type="number" class="form-control form-control-sm qty-input" min="1" value="${detail.qty}" /></td>
          <td><input type="text" class="form-control form-control-sm price-input" value="${formatRupiah(detail.price)}" /></td>
          <td><input type="number" class="form-control form-control-sm discount-percent-input" min="0" max="100" value="${(detail.discAmount / (detail.total + detail.discAmount)) * 100}" /></td>
          <td><input type="number" class="form-control form-control-sm discount-amount-input" min="0" value="${detail.discAmount}" /></td>
          <td class="total-cell">${formatRupiah(detail.total)}</td>
          <td><input type="number" class="form-control form-control-sm stok-input" value="0" readonly/></td>
          <td><input type="text" class="form-control form-control-sm harga-jual-lama" value="${formatRupiah(detail.hargaJual1 ?? 0)}" readonly/></td>
          <td><input type="number" class="form-control form-control-sm markup-1-input" value="${(detail.markup1 ?? 0).toFixed(2)}" /></td>
          <td><input type="text" class="form-control form-control-sm harga-jual-1-input" value="${formatRupiah(detail.hargaJual1 ?? 0)}"/></td>
          <td><input type="number" class="form-control form-control-sm markup-2-input" value="${(detail.markup2 ?? 0).toFixed(2)}" /></td>
          <td><input type="text" class="form-control form-control-sm harga-jual-2-input" value="${formatRupiah(detail.hargaJual2 ?? 0)}" /></td>
          <td><input type="number" class="form-control form-control-sm markup-3-input" value="${(detail.markup3 ?? 0).toFixed(2)}" /></td>
          <td><input type="text" class="form-control form-control-sm harga-jual-3-input" value="${formatRupiah(detail.hargaJual3 ?? 0)}"/></td>
        `;

        const codeInput = row.querySelector(".code-input");
        const priceInput = row.querySelector(".price-input");
        const qtyInput = row.querySelector(".qty-input");

        priceInput.addEventListener("focus", handleFormattedFocus);
        priceInput.addEventListener("blur", handleFormattedBlur);
        priceInput.addEventListener("input", () => updateTotalRow(row));
        qtyInput.addEventListener("input", () => updateTotalRow(row));

        if (focus) codeInput.focus();
        codeInput.addEventListener("keydown", async (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
              selectedRow = row;
              loadProductTable();
              productModal.show();
              return;
            }

            // 🔍 Cari produk di masterProducts dulu
            let product = masterProducts.find((p) => p.shortName === code);

            // 🚀 Kalau belum ada, fetch ke backend
            if (!product) {
              try {
                const res = await fetch(`/products/find?keyword=${encodeURIComponent(code)}`);
                if (res.ok) {
                  const result = await res.json();
                  if (result) {
                    product = result;
                    // ✅ Simpan ke cache agar validasi harga jual bisa pakai data B ini
                    dynamicProductsCache.push(product);
                  }
                }
              } catch (err) {
                console.error("Error fetching product:", err);
              }
            }

            if (product) {
              // 🔁 Cek apakah produk ini sudah ada di baris lain
              const existingRow = [...sellTableBody.querySelectorAll("tr")].find((r) => {
                const existingCode = r.querySelector(".code-input").value.trim().toUpperCase();
                return existingCode === code;
              });

              if (existingRow && existingRow !== row) {
                // ✅ Kalau sudah ada → tambahkan qty dan update total
                const qtyInput = existingRow.querySelector(".qty-input");
                qtyInput.value = parseInt(qtyInput.value || "0") + 1;
                updateTotalRow(existingRow);

                // Kosongkan input baru agar tidak duplikat
                codeInput.value = "";
                codeInput.focus();
                return;
              }

              // 🔹 Kalau produk baru → isi data ke baris ini
              fillProductRow(row, product);
              maybeAddNewRow();
            } else {
              alert("Product not found");
              codeInput.value = "";
              codeInput.focus();
            }
          }
        });

        // 🔁 lanjut binding handler
<!--        attachNavigationHandlers(row);-->
        attachMarkupHandlers(row);

        // (lanjut semua event listener & append row)
        sellTableBody.appendChild(row);
        row.addEventListener("contextmenu", function (e) {
            e.preventDefault();
            selectedRow = row;
            showContextMenu(e.pageX, e.pageY);
          });
      }

      // Add a new empty row
      await Promise.resolve(); // tunggu microtask async selesai
      addNewRow();
      // Recalculate and display the grand total
      calculateGrandTotal();
    }


   // Init
   loadCustomers();
   if (
     masterTransactions.pembelianId !== null &&
     masterTransactions.pembelianDetailDTOS !== null
   ) {
     loadTransaction(masterTransactions);
   }else{
      addNewRow();
    }
   updateJam();
   calculateGrandTotal();
   setInterval(updateJam, 1000);
    sellTableBody.addEventListener("contextmenu", function (e) {
      const row = e.target.closest("tr");
      if (row && sellTableBody.contains(row)) {
        e.preventDefault();
        selectedRow = row;
        showContextMenu(e.pageX, e.pageY);
      }
    });

    // ============================
    // 🔁 Restore old code value on blur (lose focus)
    // ============================
    sellTableBody.addEventListener("focusin", (e) => {
      // When focusing into a code-input, remember its old value
      if (e.target.classList.contains("code-input")) {
        const input = e.target;
        input.dataset.oldValue = input.value; // store old value temporarily
      }
    });

    sellTableBody.addEventListener("focusout", (e) => {
      // When leaving a code-input, restore if empty
      if (e.target.classList.contains("code-input")) {
        const input = e.target;
        const oldValue = input.dataset.oldValue || "";

        // if input is empty, restore old value
        if (!input.value.trim() && oldValue) {
          input.value = oldValue;
        }

        // cleanup
        delete input.dataset.oldValue;
      }
    });
</script>
</body>
</html>
