<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Pembelian</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>

    <!-- Bootstrap 5 (example) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!--    datatable-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
          background-color: #f8f9fa;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            "Helvetica Neue", Arial, sans-serif;
        }
        .card {
          border: none;
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .table {
          margin-bottom: 0;
        }
        .table thead {
          background-color: #e9ecef;
        }
        .table td,
        .table th {
          vertical-align: middle;
          padding: 0.5rem 0.75rem;
        }
        .form-control-sm,
        .form-select-sm {
          padding: 0.25rem 0.5rem;
          font-size: 0.875rem;
        }
        .btn {
          font-size: 0.875rem;
        }

        #contextMenu {
          position: absolute;
          display: none;
          background-color: white;
          border: 1px solid #ccc;
          z-index: 1000;
          min-width: 150px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
          border-radius: 0.25rem;
        }
        #contextMenu ul {
          list-style: none;
          padding: 0;
          margin: 0;
        }
        #contextMenu li {
          padding: 8px 12px;
          cursor: pointer;
          font-size: 0.875rem;
        }
        #contextMenu li:hover {
          background-color: #f0f0f0;
        }

        /* Custom styles for the scrollable table */
        .scrollable-table {
          max-height: 100%;
          overflow-y: auto;
        }

        /* Payment section styling */
        .payment-section-card {
          background-color: #e9ecef;
          padding: 1.5rem;
        }
        html, body {
          height: 100%;
          overflow: hidden; /* hilangkan scroll body */
        }
        .table-responsive {
          border-radius: 0.3rem;
          height: 100%;
          max-width:100%;
          overflow-y: auto; /* kalau banyak data scroll di tabel aja */
          overflow-x:auto;
        }
        .scrollable-table thead th {
          position: sticky;
          top: 0;
          background: #f8f9fa;  /* biar header tidak tembus */
          z-index: 2;           /* biar header di atas isi tabel */
        }
        #sellTable {
          width: max-content; /* Biarkan tabel melebar melebihi container */
          min-width: 100%;    /* Tetap 100% minimal */
        }

        #sellTable th,
        #sellTable td {
          white-space: nowrap; /* Jangan wrap konten */
        }

        .bottom-right-fixed {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
          }
    </style>
</head>
<body class="d-flex flex-column vh-100 p-2">
<div class="container-fluid">
    <div
            class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-3"
    >
        <!-- CARD -->
        <div class="card p-3 flex-grow-1" style="min-width: 600px">
            <div class="row g-3">
                <!-- Kiri: Info Utama -->
                <div class="col-md-4">
                    <h5 class="m-0 mb-2" id="transactionNumberDisplay">#TRX000001</h5>
                    <select
                            id="customerSelect"
                            class="form-select form-select-sm w-100"
                    ></select>
                    <br>

                    <button class="btn btn-success add-product-btn" data-bs-toggle="modal"
                            data-bs-target="#addBarangModal" id="add-barang-btn">Add Product
                    </button>

                </div>

                <!-- Tengah: Faktur + PO Date -->
                <div class="col-md-4">
                    <label for="invoiceNumber" class="form-label">No. Faktur</label>
                    <div class="d-flex mb-2">
                        <input
                                type="text"
                                id="invoiceNumber"
                                class="form-control form-control-sm me-2"
                                placeholder="Masukkan No. Faktur"
                                required
                        />
                        <button type="button" class="btn btn-info btn-sm" onclick="cekNoFaktur(document.getElementById('invoiceNumber').value)">Cek</button>
                    </div>

                    <label for="poDate" class="form-label">PO Date</label>
                    <input
                            type="date"
                            id="poDate"
                            class="form-control form-control-sm"
                            required
                    />
                </div>

                <!-- Kanan: Pembayaran + Due Date -->
                <div class="col-md-4">
                    <label for="paymentType" class="form-label"
                    >Jenis Pembayaran</label
                    >
                    <select id="paymentType" class="form-select form-select-sm w-100">
                        <option value="tunai">Tunai</option>
                        <option value="kredit">Kredit</option>
                    </select>

                    <div class="mt-2" id="dueDateContainer" style="display: none">
                        <label for="poDueDate" class="form-label">PO Due Date</label>
                        <input
                                type="date"
                                id="poDueDate"
                                class="form-control form-control-sm"
                        />
                    </div>
                </div>
            </div>
        </div>

        <!-- TOMBOL KEMBALI -->
        <div class="d-flex align-items-start">
            <a
                    th:href="${pembelianData.pembelianId == null and pembelianData.pembelianDetailDTOS == null} ? '/home' : '/pembelian'"
                    class="btn btn-warning"
                    onclick="return confirm('Apakah anda yakin ingin kembali ke main menu?');"
            >Kembali
            </a>
        </div>
    </div>

    <div class="table-responsive mb-3 scrollable-table">
        <table class="table table-bordered" id="sellTable">
            <thead class="table-light">
            <tr>
                <th style="width: 30px;">No.</th>
                <th style="width: 200px;">Kode</th>
                <th style="width: 550px;">Nama</th>
                <th style="width: 150px;">Harga Beli</th>
                <th style="width: 80px;">Qty</th>
                <th style="width: 150px;">Disc (%)</th>
                <th style="width: 150px;">Disc (Rp)</th>
                <th style="width: 150px;">Total Harga</th>
                <th style="width: 80px;">Stok Lama</th>
                <th style="width: 150px;">Harga Jual Lama</th>
                <th style="width: 150px;">Markup 1 (%)</th>
                <th style="width: 150px;">Harga Jual Baru 1</th>
                <th style="width: 150px;">Markup 2 (%)</th>
                <th style="width: 150px;">Harga Jual Baru 2</th>
                <th style="width: 150px;">Markup 3 (%)</th>
                <th style="width: 150px;">Harga Jual Baru 3</th>
            </tr>
            </thead>
            <tbody id="sellTableBody"></tbody>
        </table>
    </div>

    <div class="bottom-right-fixed" style="">
        <div class="card p-3 payment-section-card">
            <div class="row">
                <div class="col">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Subtotal:</strong>
                        <span id="subTotalDisplay">Rp 0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Discount (%):</strong>
                        <input
                                type="number"
                                id="grandDiscountPercent"
                                class="form-control form-control-sm w-50 text-end"
                                value="0"
                                min="0"
                                max="100"
                        />
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Discount (Rp):</strong>
                        <input
                                type="number"
                                id="grandDiscountAmount"
                                class="form-control form-control-sm w-50 text-end"
                                value="0"
                                min="0"
                        />
                    </div>
                    <hr class="my-2"/>
                    <div
                            class="d-flex justify-content-between align-items-center mb-2"
                    >
                        <h5 class="m-0">Grand Total:</h5>
                        <h5 class="m-0 text-end" id="grandTotalDisplay">Rp 0</h5>
                    </div>
                    <div class="d-flex justify-content-end" style="margin-top:20px">
                        <div>
                            <button
                                    class="btn btn-primary btn-sm me-2"
                                    onclick="saveTransaction()"
                            >
                                Simpan
                            </button>
                            <button
                                    class="btn btn-secondary btn-sm"
                                    onclick="cancelTransaction()"
                            >
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit & Add Barang Modal -->
    <div
            class="modal fade"
            id="barangModal"
            tabindex="-1"
            aria-labelledby="editBarangLabel"
            aria-hidden="true"
    >
        <div class="modal-dialog modal-lg">
            <form th:action="@{/products/add}" method="post" id="barangForm">
                <div class="modal-content">
                    <div class="modal-header py-2">
                        <h5 class="modal-title" id="editBarangLabel">
                            Edit/Tambah Master Barang
                        </h5>
                        <button
                                type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="productId" name="productId"/>
                        <!-- Kode -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label" for="shortName">Kode Barang</label>
                            <div class="col-sm-4">
                                <input type="text" id="shortName" class="form-control" name="shortName"
                                       oninput="this.value = this.value.toUpperCase();" required/>
                            </div>
                        </div>

                        <!-- Nama Barang -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label" for="fullName">Nama Barang</label>
                            <div class="col-sm-6">
                                <input
                                        type="text"
                                        class="form-control"
                                        id="fullName"
                                        name="fullName"
                                        oninput="this.value = this.value.toUpperCase();"
                                        required
                                />
                            </div>
                        </div>

                        <!-- Supplier (Searchable Dropdown) -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label">Supplier Utama</label>
                            <div class="col-sm-4">
                                <select class="form-select highlight-field" id="supplierId" name="supplierId"
                                        required>
                                    <option value="" disabled selected>Pilih Supplier</option>
                                    <option th:each="suppliers : ${supplierData}"
                                            th:value="${suppliers.supplierId}"
                                            th:text="${suppliers.supplierName}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Nama Barang -->
                        <div class="mb-3 row">
                            <label class="col-sm-2 col-form-label" for="stok">Stok</label>
                            <div class="col-sm-2">
                                <input
                                        type="number"
                                        class="form-control"
                                        id="stok"
                                        name="stock"
                                        value="0"
                                        required
                                />
                            </div>
                        </div>

                        <hr/>

                        <!-- Harga Beli -->
                        <div class="mb-3">
                            <h6>Harga Beli</h6>
                            <div class="row mb-2">
                                <label class="col-sm-3 col-form-label" for="supplierPrice">Harga Beli Satuan</label>
                                <div class="col-sm-3">
                                    <input
                                            type="text"
                                            class="form-control rupiah-input"
                                            id="supplierPrice"
                                            name="supplierPrice"
                                            required
                                    />
                                </div>
                            </div>
                        </div>

                        <hr/>

                        <!-- Harga Jual -->
                        <h6>Harga Jual</h6>
                        <table class="table table-bordered table-sm align-middle">
                            <thead class="table-light">
                            <tr>
                                <th></th>
                                <th>Maks Qty</th>
                                <th>Pct</th>
                                <th>Harga Jual Satuan</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td><p>Harga Jual 1</p></td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[0].maximalCount"
                                            id="maxqty1"
                                            value="0"
                                            required/>
                                </td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="pct1"
                                            name="productPricesDTO[0].percentage"
                                            value="0"
                                            step="0.01"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm rupiah-input"
                                            name="productPricesDTO[0].price"
                                            id="hargaJual1"
                                            value="0"
                                            required/>
                                </td>
                            </tr>
                            <tr>
                                <td><p>Harga Jual 2</p></td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[1].maximalCount"
                                            value="0"
                                            id="maxqty2"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[1].percentage"
                                            id="pct2"
                                            value="0"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm rupiah-input"
                                            name="productPricesDTO[1].price"
                                            value="0"
                                            id="hargaJual2"
                                    />
                                </td>
                            </tr>
                            <tr>
                                <td><p>Harga Jual 3</p></td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            name="productPricesDTO[2].maximalCount"
                                            value="0"
                                            id="maxqty3"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="pct3"
                                            name="productPricesDTO[2].percentage"
                                            value="0"
                                    />
                                </td>
                                <td>
                                    <input
                                            type="text"
                                            class="form-control form-control-sm rupiah-input"
                                            name="productPricesDTO[2].price"
                                            value="0"
                                            id="hargaJual3"
                                    />
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-primary" id="addProductForm">Simpan</button>
                        <button
                                type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                        >
                            Tutup
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="contextMenu">
    <ul>
        <li onclick="deleteRow()">🗑️ Delete Row</li>
    </ul>
</div>

<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Product</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="height: 400px; overflow-y: auto">
                <div class="row mb-3">
                    <div class="col">
                        <input
                                type="text"
                                id="searchCode"
                                class="form-control form-control-sm"
                                placeholder="Search by Code"
                        />
                    </div>
                    <div class="col">
                        <input
                                type="text"
                                id="searchName"
                                class="form-control form-control-sm"
                                placeholder="Search by Name"
                        />
                    </div>
                </div>
                <table class="table table-sm table-hover" id="productTable">
                    <thead class="table-light">
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Stok</th>
                    </tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="receiptContent" style="display: none">
        <!-- Your receipt layout (table, totals, etc.) -->
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const masterProducts = /*[[${productData}]]*/ [];
    const masterSuppliers = /*[[${supplierData}]]*/ [];
    const masterTransactions = /*[[${pembelianData}]]*/ [];
    console.log(
      "master Transaction Saved:",
      JSON.stringify(masterTransactions, null, 2)
    );
</script>
<script>
    //Cek no faktur
    function cekNoFaktur(noFaktur){
        const supplierId = document.getElementById("customerSelect").value;
        if(!supplierId){
            alert("Harap pilih supplier terlebih dahulu");
            return;
        }
        console.log("supplier id cek faktur : " , supplierId);
        console.log(noFaktur);
        const params = noFaktur + "_" + supplierId;
        const apiUrl = `/api/pembelian/cek/${params}`;

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not OK');
            }
            return response.text();
        })
        .then(data => {
            // Handle the response data from your backend
            console.log('API response:', data);
            // For example, show a message
            alert(data);
        })
        .catch(error => {
            console.error('Error calling API:', error);
            alert('Failed to check invoice number');
        });
    }

     document.addEventListener("DOMContentLoaded", () => {
      const addButton = document.getElementById("add-barang-btn");
      const productModalEl = document.getElementById("barangModal");
      const productModal = new bootstrap.Modal(productModalEl);

      addButton.addEventListener("click", () => {
        productModal.show();
      });

     // Set default PO Date = today
       const poDate = document.getElementById("poDate");
       const today = new Date().toISOString().split("T")[0];
       poDate.value = today;

       const cekButton = document.querySelector(".btn-info");
       const noFakturInput = document.getElementById("invoiceNumber");

       function toggleButtonState() {
        if (noFakturInput.value.trim().length === 0) {
            console.log("input value kosong : ", noFakturInput.value);
            cekButton.disabled = true;
        } else {
            console.log("input value ada isi: ", noFakturInput.value);
            cekButton.disabled = false;
        }
       }

        toggleButtonState();
        noFakturInput.addEventListener('input', toggleButtonState);
     });

     // Toggle PO Due Date visibility
     const paymentType = document.getElementById("paymentType");
     const dueDateContainer = document.getElementById("dueDateContainer");

     paymentType.addEventListener("change", () => {
       if (paymentType.value === "kredit") {
         dueDateContainer.style.display = "block";
       } else {
         dueDateContainer.style.display = "none";
       }
     });
   const sellTableBody = document.getElementById("sellTableBody");
   const productTableBody = document.getElementById("productTableBody");
   const searchCode = document.getElementById("searchCode");
   const searchName = document.getElementById("searchName");
   const productModalEl = document.getElementById("productModal");
   const productModal = new bootstrap.Modal(productModalEl);
  productModalEl.addEventListener("shown.bs.modal", () => {
      searchName.focus();
    });
   const subTotalDisplay = document.getElementById("subTotalDisplay");
   const grandTotalDisplay = document.getElementById("grandTotalDisplay");
   const grandDiscountPercent = document.getElementById(
     "grandDiscountPercent"
   );
   const grandDiscountAmount = document.getElementById(
     "grandDiscountAmount"
   );
   const returnAmountInput = document.getElementById("returnAmount");
   const saveButton = document.querySelector(".btn-primary");

   const transactionNumberDisplay = document.getElementById(
     "transactionNumberDisplay"
   );
   const customerSelect = document.getElementById("customerSelect");

   let selectedRow = null;
   let currentKeyboardIndex = -1;
   let activeSearchField = "shortName";

   function generateTransactionNumber() {
     const timestamp = Date.now();
     console.log("timestamp : " + timestamp);
     const random = Math.floor(Math.random() * 10000);
     return `#TRX${timestamp}${random}`;
   }

   function isRowEmpty(row) {
     const code = row.querySelector(".code-input").value.trim();
     return code === "";
   }

   function formatTanggalWaktuIndonesia(date = new Date()) {
     const hari = new Intl.DateTimeFormat("id-ID", {
       weekday: "long",
     }).format(date);
     const tanggal = new Intl.DateTimeFormat("id-ID", {
       day: "numeric",
       month: "long",
       year: "numeric",
     }).format(date);
     const jam = date.getHours().toString().padStart(2, "0");
     const menit = date.getMinutes().toString().padStart(2, "0");
     const detik = date.getSeconds().toString().padStart(2, "0");

     return `${hari}, ${tanggal} - ${jam}:${menit}:${detik}`;
   }

   function parseRupiah(rupiahString) {
     if (!rupiahString) return 0;
     return parseFloat(
       rupiahString.replace(/^Rp\s*|\./g, "").replace(",", ".") || 0
     );
   }

   function formatRupiah(number) {
     return (
       "Rp " +
       number.toLocaleString("id-ID", {
         minimumFractionDigits: 0,
         maximumFractionDigits: 0,
       })
     );
   }

   function handleFormattedFocus(event) {
     let value = parseRupiah(event.target.value);
     if (value === 0) {
       event.target.value = "";
     } else {
       event.target.value = value;
     }
   }

   function handleFormattedBlur(event) {
     const value = event.target.value.replace(/[^0-9]/g, "");
     if (value === "" || isNaN(value)) {
       event.target.value = formatRupiah(0);
     } else {
       event.target.value = formatRupiah(parseInt(value));
     }
   }

   function clearZeroOnFocus(event) {
     if (event.target.value === "0") {
       event.target.value = "";
     }
   }

<!--   paymentAmountInput.addEventListener("focus", handleFormattedFocus);-->
<!--   paymentAmountInput.addEventListener("blur", handleFormattedBlur);-->
<!--   paymentAmountInput.addEventListener("input", calculateReturnAmount);-->

   function addNewRow(focus = true) {
     const rows = sellTableBody.querySelectorAll("tr");
     if (rows.length > 0) {
       const lastRowCodeInput =
         rows[rows.length - 1].querySelector(".code-input");
       if (lastRowCodeInput && lastRowCodeInput.value.trim() === "") {
         if (focus) {
           lastRowCodeInput.focus();
         }
         return;
       }
     }
     const rowNumber = rows.length + 1;
     const row = document.createElement("tr");

     row.innerHTML = `
<td class="row-number">${rowNumber}</td>
<td><input type="text" class="form-control form-control-sm code-input" /></td>
<td><input type="text" class="form-control form-control-sm name-input" readonly /></td>
<td><input type="text" class="form-control form-control-sm price-input" /></td>
<td><input type="number" class="form-control form-control-sm qty-input" min="1" value="1" /></td>
<td><input type="number" class="form-control form-control-sm discount-percent-input" min="0" max="100" value="0" /></td>
<td><input type="number" class="form-control form-control-sm discount-amount-input" min="0" value="0" /></td>
<td class="total-cell">Rp 0</td>
<td><input type="number" class="form-control form-control-sm stok-input" value="0" readonly/></td>
<td><input type="text" class="form-control form-control-sm harga-jual-lama" value="0" readonly/></td>
<td><input type="number" class="form-control form-control-sm markup-1-input" value="0" /></td>
<td><input type="text" class="form-control form-control-sm harga-jual-1-input" value="${formatRupiah(0)}"/></td>
<td><input type="number" class="form-control form-control-sm markup-2-input" value="0" /></td>
<td><input type="text" class="form-control form-control-sm harga-jual-2-input" value="${formatRupiah(0)}" /></td>
<td><input type="number" class="form-control form-control-sm markup-3-input" value="0"/></td>
<td><input type="text" class="form-control form-control-sm harga-jual-3-input" value="${formatRupiah(0)}"/></td>
`;

     sellTableBody.appendChild(row);

     const codeInput = row.querySelector(".code-input");
     const nameInput = row.querySelector(".name-input");
     const priceInput = row.querySelector(".price-input");
     const qtyInput = row.querySelector(".qty-input");
     const discPercentInput = row.querySelector(".discount-percent-input");
     const discAmountInput = row.querySelector(".discount-amount-input");
     const markUp1Input = row.querySelector(".markup-1-input");
     const hargaJual1Input = row.querySelector(".harga-jual-1-input");
     const markUp2Input = row.querySelector(".markup-2-input");
     const hargaJual2Input = row.querySelector(".harga-jual-2-input");
     const markUp3Input = row.querySelector(".markup-3-input");
     const hargaJual3Input = row.querySelector(".harga-jual-3-input");

    hargaJual1Input.addEventListener("focus", handleFormattedFocus);
    hargaJual1Input.addEventListener("blur", handleFormattedBlur);
    hargaJual2Input.addEventListener("focus", handleFormattedFocus);
    hargaJual2Input.addEventListener("blur", handleFormattedBlur);
    hargaJual3Input.addEventListener("focus", handleFormattedFocus);
    hargaJual3Input.addEventListener("blur", handleFormattedBlur);
     const inputs = [
       codeInput,
       nameInput,
       priceInput,
       qtyInput,
       discPercentInput,
       discAmountInput,
       markUp1Input,
       hargaJual1Input,
       markUp2Input,
       hargaJual2Input,
       markUp3Input,
       hargaJual3Input
     ];

     inputs.forEach((input, index) => {
       input.addEventListener("keydown", (e) => {
         if (e.key === "Enter") {
           e.preventDefault();
           const currentRow = e.target.closest("tr");
           const lastRow = sellTableBody.lastElementChild;

           // pastikan ada baris kosong berikutnya
           if (currentRow === lastRow && !isRowEmpty(currentRow)) {
             // panggil function yang sudah ada untuk tambah baris
             maybeAddNewRow();
           }

           // fokuskan ke baris berikutnya (pasti kosong karena maybeAddNewRow)
           const nextRow = currentRow.nextElementSibling;
           if (nextRow) {
             nextRow.querySelector(".code-input").focus();
           }
         } else if (
           e.key === "ArrowUp" ||
           e.key === "ArrowDown" ||
           e.key === "ArrowLeft" ||
           e.key === "ArrowRight"
         ) {
           e.preventDefault();

           const currentRows = [...sellTableBody.querySelectorAll("tr")];
           const currentRowIndex = currentRows.indexOf(row);
           const editableInputs = [
             ...row.querySelectorAll("input:not([readonly])"),
           ];
           const currentEditableIndex = editableInputs.indexOf(e.target);

           let nextRowIndex = currentRowIndex;
           let nextEditableIndex = currentEditableIndex;

           if (e.key === "ArrowUp") {
             nextRowIndex = Math.max(0, currentRowIndex - 1);
           } else if (e.key === "ArrowDown") {
             nextRowIndex = currentRowIndex + 1;
             if (nextRowIndex >= currentRows.length) {
               addNewRow();
               nextRowIndex = currentRows.length;
             }
           } else if (e.key === "ArrowLeft") {
             nextEditableIndex = Math.max(0, currentEditableIndex - 1);
           } else if (e.key === "ArrowRight") {
             nextEditableIndex = Math.min(
               editableInputs.length - 1,
               currentEditableIndex + 1
             );
           }

           const targetRow =
             sellTableBody.querySelectorAll("tr")[nextRowIndex];
           const targetEditableInputs = [
             ...targetRow.querySelectorAll("input:not([readonly])"),
           ];
           const targetInput = targetEditableInputs[nextEditableIndex];

           if (targetInput) {
             targetInput.focus();
             if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
               targetInput.select();
             }
           }
         }
       });
     });

     priceInput.addEventListener("focus", handleFormattedFocus);
     priceInput.addEventListener("blur", handleFormattedBlur);
     priceInput.addEventListener("input", () => {
       updateTotalRow(row);
     });

     qtyInput.addEventListener("focus", clearZeroOnFocus);
     discPercentInput.addEventListener("focus", clearZeroOnFocus);
     discAmountInput.addEventListener("focus", clearZeroOnFocus);

     grandDiscountPercent.addEventListener("focus", clearZeroOnFocus);
     grandDiscountAmount.addEventListener("focus", clearZeroOnFocus);

     [discPercentInput, discAmountInput].forEach((inp) => {
          inp.addEventListener("blur", () => {
            if (inp.value.trim() === "" || isNaN(parseFloat(inp.value))) {
              inp.value = "0";
            }
          });
        });

     if (focus) codeInput.focus();

     codeInput.addEventListener("keydown", (e) => {
       if (e.key === "Enter") {
         e.preventDefault();
         const code = codeInput.value.trim().toUpperCase();

         if (!code) {
           selectedRow = row;
           productModal.show();
           loadProductTable();
           return;
         }

         const product = masterProducts.find((p) => p.shortName === code);
         if (product) {
           const rows = [...sellTableBody.querySelectorAll("tr")];
           let existingRow = null;
           for (const r of rows) {
             if (r === row) continue;
             const cInput = r.querySelector(".code-input");
             if (cInput.value.trim().toUpperCase() === code) {
               existingRow = r;
               break;
             }
           }

           if (existingRow) {
             const qInput = existingRow.querySelector(".qty-input");
             qInput.value = parseInt(qInput.value || "0") + 1;
             updateTotalRow(existingRow);

             // Clear the current row and focus
             codeInput.value = "";
             row.querySelector(".name-input").value = "";
             row.querySelector(".price-input").value = "Rp 0";
             row.querySelector(".qty-input").value = "1";
             row.querySelector(".discount-percent-input").value = "0";
             row.querySelector(".discount-amount-input").value = "0";
             row.querySelector(".total-cell").textContent = "Rp 0";
             codeInput.focus();
           } else {
             fillProductRow(row, product);
             maybeAddNewRow();
           }
         } else {
           alert("Product not found");
           codeInput.value = ""; // Clear the input field
           codeInput.focus();
         }
       }
     });

     qtyInput.addEventListener("input", () => {
       const qty = parseInt(qtyInput.value) || 0;
       const code = codeInput.value.trim();
       const product = masterProducts.find((p) => p.shortName === code);

       if (product) {
         const newPrice = getPriceByQty(product, qty);
         priceInput.value = formatRupiah(newPrice);
       }

       updateTotalRow(row);
     });

      markUp1Input.addEventListener("input", () => {
          let val = markUp1Input.value;
          console.log("value markup1 is : " + val);

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markUp1Input.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(row.querySelector(".price-input").value);
          const markUp1Percent = parseFloat(markUp1Input.value) || 0;
          const markUp1Amount = price + ((markUp1Percent * price) / 100)
          hargaJual1Input.value = Math.round(markUp1Amount)
          updateTotalRow(row);
        });

      hargaJual1Input.addEventListener("input", () => {
           const price = parseRupiah(row.querySelector(".price-input").value);
           const qty = parseInt(qtyInput.value) || 0;
           const hargaJual1 = parseFloat(hargaJual1Input.value) || 0;
           const markUp1 = ((hargaJual1 - price) / price) * 100;
           markUp1Input.value = isFinite(markUp1) ? markUp1.toFixed(2) : "0" ;
           updateTotalRow(row);
      });

      markUp2Input.addEventListener("input", () => {
          let val = markUp2Input.value;
          console.log("value markup2 is : " + val);

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markUp2Input.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(row.querySelector(".price-input").value);
          const markUp2Percent = parseFloat(markUp2Input.value) || 0;
          const markUp2Amount = price + ((markUp2Percent * price) / 100)
          hargaJual2Input.value = Math.round(markUp2Amount)
          updateTotalRow(row);
        });

      hargaJual2Input.addEventListener("input", () => {
           const price = parseRupiah(row.querySelector(".price-input").value);
           const qty = parseInt(qtyInput.value) || 0;
           const hargaJual2 = parseFloat(hargaJual2Input.value) || 0;
           const markUp2 = ((hargaJual2 - price) / price) * 100;
           markUp2Input.value = isFinite(markUp2) ? markUp2.toFixed(2) : "0" ;
           updateTotalRow(row);
      });

      markUp3Input.addEventListener("input", () => {
          let val = markUp3Input.value;
          console.log("value markup3 is : " + val);

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markUp3Input.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(row.querySelector(".price-input").value);
          const markUp3Percent = parseFloat(markUp3Input.value) || 0;
          const markUp3Amount = price + ((markUp3Percent * price) / 100)
          hargaJual3Input.value = Math.round(markUp3Amount)
          updateTotalRow(row);
        });

      hargaJual3Input.addEventListener("input", () => {
           hargaJual3Input.value = hargaJual3Input.value.replace(/[^0-9.]/g, '');
           const price = parseRupiah(row.querySelector(".price-input").value);
           const qty = parseInt(qtyInput.value) || 0;
           const hargaJual3 = parseFloat(hargaJual3Input.value) || 0;
           const markUp3 = ((hargaJual3 - price) / price) * 100;
           markUp3Input.value = isFinite(markUp3) ? markUp3.toFixed(2) : "0" ;
           updateTotalRow(row);
      });

     discPercentInput.addEventListener("input", () => {
          let val = discPercentInput.value;

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            discPercentInput.value = intPart + "." + decPart.slice(0, 2);
          }

          const price = parseRupiah(row.querySelector(".price-input").value);
          const qty = parseInt(qtyInput.value) || 0;
          const discountPercent = parseFloat(discPercentInput.value) || 0;

          if (price * qty > 0) {
            const discountAmount = price * qty * (discountPercent / 100);
            discAmountInput.value = Math.round(discountAmount);
          } else {
            discAmountInput.value = "0";
          }
          updateTotalRow(row);
     });

     discAmountInput.addEventListener("input", () => {
       const price = parseRupiah(row.querySelector(".price-input").value);
       const qty = parseInt(qtyInput.value) || 0;
       const discountAmount = parseFloat(discAmountInput.value) || 0;

       if (price * qty > 0 ) {
         const discountPercent = (discountAmount / (price * qty)) * 100;
         discPercentInput.value = isFinite(discountPercent) ? discountPercent.toFixed(2) : "0" ;
       } else {
         discPercentInput.value = "0";
       }
       updateTotalRow(row);
     });

     row.addEventListener("contextmenu", function (e) {
       e.preventDefault();
       selectedRow = row;
       showContextMenu(e.pageX, e.pageY);
     });
     calculateGrandTotal();
   }

   function maybeAddNewRow() {
     const rows = [...sellTableBody.querySelectorAll("tr")];
     const lastRow = rows[rows.length - 1];
     const codeVal = lastRow.querySelector(".code-input").value.trim();
     if (codeVal) {
       addNewRow();
     }
   }
   function getPriceByQty(product, qty) {
     let chosenPrice = product.productPricesDTO[0].price; // default first tier

     for (let i = 0; i < product.productPricesDTO.length; i++) {
       const tier = product.productPricesDTO[i];

       // if qty fits inside this tier, use it and stop
       if (qty <= tier.maximalCount && tier.price > 0) {
         chosenPrice = tier.price;
         return chosenPrice;
       }

       // if qty is bigger, keep moving, but always carry forward the latest valid price
       if (tier.price > 0) {
         chosenPrice = tier.price;
       }
     }

     return chosenPrice; // at the end, it's the last tier
   }

   function fillProductRow(row, product) {
      const qty = 1; // default qty
      const price = getPriceByQty(product, qty);
      console.log("price : ", price);

      const price1 = product.productPricesDTO[0].price;
      const price2 = product.productPricesDTO[1].price;
      const price3 = product.productPricesDTO[2].price;

      row.querySelector(".code-input").value = product.shortName;
      row.querySelector(".name-input").value = product.fullName;
      row.querySelector(".price-input").value = formatRupiah(product.hargaBeli);
      row.querySelector(".qty-input").value = qty;
      row.querySelector(".discount-percent-input").value = 0;
      row.querySelector(".discount-amount-input").value = 0;
      row.querySelector(".stok-input").value = product.stok;
      row.querySelector(".harga-jual-lama").value = formatRupiah(price);

      // Harga Jual 1
      if (price1 > 0) {
        row.querySelector(".markup-1-input").value =
          ((price1 - product.hargaBeli) / product.hargaBeli * 100).toFixed(2);
        row.querySelector(".harga-jual-1-input").value = formatRupiah(price1);
      } else {
        row.querySelector(".markup-1-input").value = 0;
        row.querySelector(".harga-jual-1-input").value = formatRupiah(0);
      }

      // Harga Jual 2
      if (price2 > 0) {
        row.querySelector(".markup-2-input").value =
          ((price2 - product.hargaBeli) / product.hargaBeli * 100).toFixed(2);
        row.querySelector(".harga-jual-2-input").value = formatRupiah(price2);
      } else {
        row.querySelector(".markup-2-input").value = 0;
        row.querySelector(".harga-jual-2-input").value = formatRupiah(0);
      }

      // Harga Jual 3
      if (price3 > 0) {
        row.querySelector(".markup-3-input").value =
          ((price3 - product.hargaBeli) / product.hargaBeli * 100).toFixed(2);
        row.querySelector(".harga-jual-3-input").value = formatRupiah(price3);
      } else {
        row.querySelector(".markup-3-input").value = 0;
        row.querySelector(".harga-jual-3-input").value = formatRupiah(0);
      }

      updateTotalRow(row);
    }

   function updateTotalRow(r) {
     const price = parseRupiah(r.querySelector(".price-input").value);
     const qty = parseInt(r.querySelector(".qty-input").value) || 0;
     const discAmount =
       parseFloat(r.querySelector(".discount-amount-input").value) || 0;
     const subTotal = price * qty;
     const total = subTotal - discAmount;
     r.querySelector(".total-cell").textContent =
       "Rp " + total.toLocaleString("id-ID");
     calculateGrandTotal();
   }

   function selectProduct(product) {
     const rows = [...sellTableBody.querySelectorAll("tr")];
     let targetRow = rows.find((r) => {
       const code = r.querySelector(".code-input").value.trim();
       return code === "";
     });
     if (!targetRow) {
       addNewRow(false);
       targetRow = sellTableBody.lastElementChild;
     }

     let existingRow = null;
     for (const r of rows) {
       const code = r
         .querySelector(".code-input")
         .value.trim()
         .toUpperCase();
       if (code === product.shortName) {
         existingRow = r;
         break;
       }
     }

     if (existingRow) {
       const qtyInput = existingRow.querySelector(".qty-input");
       qtyInput.value = parseInt(qtyInput.value || "0") + 1;
       updateTotalRow(existingRow);

       if (targetRow) {
         targetRow.querySelector(".code-input").value = "";
         targetRow.querySelector(".name-input").value = "";
         targetRow.querySelector(".price-input").value = "Rp 0";
         targetRow.querySelector(".qty-input").value = "1";
         targetRow.querySelector(".discount-percent-input").value = "0";
         targetRow.querySelector(".discount-amount-input").value = "0";
         targetRow.querySelector(".total-cell").textContent = "Rp 0";
       }
     } else {
       fillProductRow(targetRow, product);
       maybeAddNewRow();
     }

     productModal.hide();

     setTimeout(() => {
       focusNextEmptyRow();
     }, 200);
   }

   function calculateGrandTotal() {
     let subTotal = 0;
     let totalDiscount = 0;
     const rows = sellTableBody.querySelectorAll("tr");
     rows.forEach((row) => {
       const price = parseRupiah(row.querySelector(".price-input").value);
       const qty = parseInt(row.querySelector(".qty-input").value) || 0;
       const discAmt = parseFloat(row.querySelector(".discount-amount-input").value) || 0;

       if (price && qty) {
         subTotal += price * qty;
         totalDiscount += discAmt;
       }
     });

     const grandDiscPercent = parseFloat(grandDiscountPercent.value) || 0;
     const grandDiscAmount = parseFloat(grandDiscountAmount.value) || 0;

     let finalDiscount = totalDiscount;
     if (grandDiscPercent > 0) {
       finalDiscount += subTotal * (grandDiscPercent / 100);
     } else {
       finalDiscount += grandDiscAmount;
     }

     const grandTotal = subTotal - finalDiscount;

     subTotalDisplay.textContent = "Rp " + subTotal.toLocaleString("id-ID");
     grandTotalDisplay.textContent =
       "Rp " + Math.max(0, grandTotal).toLocaleString("id-ID");

     calculateReturnAmount();
   }

   function calculateReturnAmount() {
     const grandTotal =
       parseFloat(
         grandTotalDisplay.textContent
           .replace("Rp ", "")
           .replace(/\./g, "")
           .replace(",", ".")
       ) || 0;
     saveButton.disabled =
       sellTableBody.querySelectorAll("tr").length === 0 || grandTotal === 0;
   }

   grandDiscountPercent.addEventListener("input", () => {
     updateGrandDiscountAmount();
   });

   grandDiscountAmount.addEventListener("input", () => {
     updateGrandDiscountPercent();
   });

   function updateGrandDiscountAmount() {
     const subTotal =
       parseFloat(
         subTotalDisplay.textContent.replace("Rp ", "").replace(/\./g, "")
       ) || 0;
     const discountPercent = parseFloat(grandDiscountPercent.value) || 0;

     if (subTotal > 0 && discountPercent >= 0) {
       const discountAmount = subTotal * (discountPercent / 100);
       grandDiscountAmount.value = discountAmount.toFixed(0);
     } else {
       grandDiscountAmount.value = 0;
     }
     calculateGrandTotal();
   }

   function updateGrandDiscountPercent() {
     const subTotal =
       parseFloat(
         subTotalDisplay.textContent.replace("Rp ", "").replace(/\./g, "")
       ) || 0;
     const discountAmount = parseFloat(grandDiscountAmount.value) || 0;

     if (subTotal > 0 && discountAmount >= 0) {
       const discountPercent = (discountAmount / subTotal) * 100;
       grandDiscountPercent.value = discountPercent.toFixed(2);
     } else {
       grandDiscountPercent.value = 0;
     }
     calculateGrandTotal();
   }

   function loadProductTable(filteredProducts = masterProducts) {
     productTableBody.innerHTML = "";
     let rows = [];

     filteredProducts.forEach((product, index) => {
       const row = document.createElement("tr");
       row.setAttribute("data-index", index);
       row.tabIndex = 0;
       row.style.cursor = "pointer";

       row.innerHTML = `
 <td>${product.shortName}</td>
 <td>${product.fullName}</td>
 <td>Rp ${product.productPricesDTO[0].price.toLocaleString("id-ID")}</td>
 <td>${product.stok}</td>
`;

       row.addEventListener("dblclick", () => {
         selectProduct(product);
       });

       productTableBody.appendChild(row);
       rows.push(row);
     });

     currentKeyboardIndex = -1;
     highlightRow(null);

     document.onkeydown = null;

     document.onkeydown = function (e) {
       if (!productModalEl.classList.contains("show")) return;

       const activeElement = document.activeElement;
       const isInSearch =
         activeElement === searchCode || activeElement === searchName;

       switch (e.key) {
         case "ArrowDown":
           e.preventDefault();
           if (rows.length === 0) return;

           if (isInSearch) {
             currentKeyboardIndex = 0;
             highlightRow(rows[currentKeyboardIndex]);
             rows[currentKeyboardIndex].focus();
           } else {
             if (currentKeyboardIndex < rows.length - 1)
               currentKeyboardIndex++;
             highlightRow(rows[currentKeyboardIndex]);
             rows[currentKeyboardIndex].focus();
           }
           break;

         case "ArrowUp":
           e.preventDefault();
           if (rows.length === 0) return;

           if (!isInSearch) {
             if (currentKeyboardIndex > 0) currentKeyboardIndex--;
             highlightRow(rows[currentKeyboardIndex]);
             rows[currentKeyboardIndex].focus();
           }
           break;

         case "ArrowLeft":
           e.preventDefault();
           searchCode.focus();
           break;

         case "ArrowRight":
           e.preventDefault();
           searchName.focus();
           break;

         case "Enter":
           e.preventDefault();

           if (isInSearch) {
             doFilter();
           } else {
             if (currentKeyboardIndex >= 0 && rows[currentKeyboardIndex]) {
               const selectedCode = rows[currentKeyboardIndex]
                 .querySelector("td")
                 .textContent.trim();
               const selected = masterProducts.find(
                 (p) => p.shortName === selectedCode
               );
               if (selected) selectProduct(selected);
             }
           }
           break;
       }
     };

     function highlightRow(row) {
       rows.forEach((r) => r.classList.remove("table-active"));
       if (row) {
         row.classList.add("table-active");
         row.scrollIntoView({ block: "nearest", behavior: "smooth" });
       }
     }
   }

   searchCode.addEventListener("focus", () => {
     activeSearchField = "shortName";
   });

   searchName.addEventListener("focus", () => {
     activeSearchField = "fullName";
   });

   function doFilter() {
     if (activeSearchField === "shortName") {
       const val = searchCode.value.trim().toLowerCase();
       const filtered = masterProducts.filter((p) =>
         p.shortName.toLowerCase().includes(val)
       );
       loadProductTable(filtered);
     } else if (activeSearchField === "fullName") {
       const val = searchName.value.trim().toLowerCase();
       const filtered = masterProducts.filter((p) =>
         p.fullName.toLowerCase().includes(val)
       );
       loadProductTable(filtered);
     }
   }

   [searchCode, searchName].forEach((input) => {
     input.addEventListener("keydown", (e) => {
       if (e.key === "Enter") {
         e.preventDefault();
         doFilter();
       }
     });
   });

   function showContextMenu(x, y) {
     const menu = document.getElementById("contextMenu");
     menu.style.top = `${y}px`;
     menu.style.left = `${x}px`;
     menu.style.display = "block";
   }

   function deleteRow() {
     if (selectedRow) {
       selectedRow.remove();
       selectedRow = null;
       document.getElementById("contextMenu").style.display = "none";

       reindexRows();

       if (sellTableBody.querySelectorAll("tr").length === 0) {
         addNewRow();
       }
       calculateGrandTotal();
     }
   }
   function reindexRows() {
      const rows = sellTableBody.querySelectorAll("tr");
      rows.forEach((row, index) => {
        // Assuming the first cell (td) contains the row number
        row.cells[0].textContent = index + 1;
      });
    }

   document.addEventListener("click", () => {
     document.getElementById("contextMenu").style.display = "none";
   });

   productModalEl.addEventListener("hidden.bs.modal", () => {
     searchCode.value = "";
     searchName.value = "";
     loadProductTable();
     focusNextEmptyRow();
   });

   function focusNextEmptyRow() {
     const rows = [...sellTableBody.querySelectorAll("tr")];
     for (const row of rows) {
       const codeInput = row.querySelector(".code-input");
       const nameInput = row.querySelector(".name-input");
       if (codeInput.value.trim() === "" && nameInput.value.trim() === "") {
         codeInput.focus();
         return;
       }
     }
     addNewRow(true);
   }

   function loadCustomers() {
     customerSelect.innerHTML =
       '<option value="">-- Pilih Supplier --</option>';
     masterSuppliers.forEach((supplier) => {
       const option = document.createElement("option");
       const newOption = `<option value="${supplier.supplierId}">${supplier.supplierName}</option>`;
       customerSelect.insertAdjacentHTML("beforeend", newOption);
     });
   }

   async function saveTransaction() {
     const grandTotal =
       parseFloat(
         grandTotalDisplay.textContent
           .replace("Rp ", "")
           .replace(/\./g, "")
           .replace(",", ".")
       ) || 0;
     if (
       sellTableBody.querySelectorAll("tr").length === 0 ||
       grandTotal === 0
     ) {
       alert("Transaction cannot be saved with no items.");
       return;
     }

     const isCash = document.getElementById("paymentType").value === "tunai";
     console.log("value payment type : " + document.getElementById("paymentType").value);
        let poDueDate = null;
        const poDueDateInput = document.getElementById("poDueDate");

        if (!isCash) {
            if (!poDueDateInput || !poDueDateInput.value) {
                alert("PO Due Date wajib diisi untuk pembayaran Kredit.");
                return;
            }
            poDueDate = poDueDateInput.value;
        }

     const selectedCustomerId = customerSelect.value;
     if(!selectedCustomerId){
        alert("Nama supplier tidak boleh kosong");
        return;
     }
     console.log("selected customer : " + selectedCustomerId);
     console.log("master Suppliers : " + masterSuppliers);
     const selectedCustomer = masterSuppliers.find(
       (c) => c.supplierId == selectedCustomerId
     );

     console.log("selected customer v2: " + selectedCustomer);

     const purchasingNumberInput = document.getElementById("invoiceNumber").value;
     if(!purchasingNumberInput){
        alert("Nomor Faktur tidak boleh kosong");
        return;
     }

     const poDateInput = document.getElementById("poDate").value;
     if(!poDateInput){
        alert("Tanggal Faktur tidak boleh kosong");
        return;
     }

     const transactionData = {
       supplierId: selectedCustomer.supplierId,
       purchasingNumber: purchasingNumberInput,
       pembelianDetailDTOS: [],
       subTotal: parseFloat(
         subTotalDisplay.textContent
           .replace("Rp ", "")
           .replace(/\./g, "")
           .replace(",", ".")
       ),
       totalDisc: parseFloat(grandDiscountAmount.value) || 0,
       totalPrice: grandTotal,
       isCash: isCash,
       poDate: document.getElementById("poDate").value,
       poDueDate: poDueDate
     };

     sellTableBody.querySelectorAll("tr").forEach((row) => {
       const code = row.querySelector(".code-input").value;
       if (code) {
         transactionData.pembelianDetailDTOS.push({
           code: code,
           name: row.querySelector(".name-input").value,
           price: parseRupiah(row.querySelector(".price-input").value),
           qty: parseInt(row.querySelector(".qty-input").value),
           discAmount: parseFloat(
             row.querySelector(".discount-amount-input").value
           ),
           total: parseFloat(
             row
               .querySelector(".total-cell")
               .textContent.replace("Rp ", "")
               .replace(/\./g, "")
               .replace(",", ".")
           ),
           markup1: row.querySelector(".markup-1-input").value,
           markup2: row.querySelector(".markup-2-input").value,
           markup3: row.querySelector(".markup-3-input").value,
           hargaJual1: parseRupiah(row.querySelector(".harga-jual-1-input").value),
           hargaJual2: parseRupiah(row.querySelector(".harga-jual-2-input").value),
           hargaJual3: parseRupiah(row.querySelector(".harga-jual-3-input").value),
         });
       }
     });
     console.log(
       "Transaction Saved:",
       JSON.stringify(transactionData, null, 2)
     );
     try {
       let response;
       console.log("otw save nih, transaction data : " + JSON.stringify(transactionData,null,2));
       if (
         masterTransactions.pembelianId !== null &&
         masterTransactions.pembelianDetailDTOS !== null
       ) {
         console.log("otw edit");
         response = await fetch(
           `/api/pembelian/edit/${masterTransactions.pembelianId}`,
           {
             method: "POST",
             headers: {
               "Content-Type": "application/json",
             },
             body: JSON.stringify(transactionData),
           }
         );
       } else {
         console.log("otw add");
         response = await fetch("/api/pembelian/add", {
           method: "POST",
           headers: {
             "Content-Type": "application/json",
           },
           body: JSON.stringify(transactionData),
         });
       }

       console.log("response from be : ", !response.ok);

       if (!response.ok) {
         throw new Error(`Server responded with ${response.status}`);
       }

       const result = await response.text();
       console.log("Transaction Saved:", result);
       alert("Transaction saved successfully!");

       if (
         masterTransactions.transactionId !== null &&
         masterTransactions.pembelianDetailDTOS !== null
       ) {
         window.location.href = "/pembelian";
       } else {
         window.location.href = "/pembelian/tambah";
       }
     } catch (error) {
       console.error("Failed to save transaction:", error);
       alert("Failed to save transaction. Please try again.");
     }
   }

   function cancelTransaction() {
    location.reload();
   }

   function updateJam() {
     transactionNumberDisplay.textContent = formatTanggalWaktuIndonesia();
   }

   function attachNavigationHandlers(row) {
      const inputs = [...row.querySelectorAll("input:not([readonly])")];

      inputs.forEach((input) => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const currentRow = e.target.closest("tr");
            const lastRow = sellTableBody.lastElementChild;

            if (currentRow === lastRow && !isRowEmpty(currentRow)) {
              maybeAddNewRow();
            }

            const nextRow = currentRow.nextElementSibling;
            if (nextRow) {
              nextRow.querySelector(".code-input").focus();
            }
          } else if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
            e.preventDefault();

            const rows = [...sellTableBody.querySelectorAll("tr")];
            const currentRowIndex = rows.indexOf(row);
            const currentInputs = [...row.querySelectorAll("input:not([readonly])")];
            const currentInputIndex = currentInputs.indexOf(e.target);

            let nextRowIndex = currentRowIndex;
            let nextInputIndex = currentInputIndex;

            if (e.key === "ArrowUp") nextRowIndex = Math.max(0, currentRowIndex - 1);
            if (e.key === "ArrowDown") nextRowIndex = Math.min(rows.length - 1, currentRowIndex + 1);
            if (e.key === "ArrowLeft") nextInputIndex = Math.max(0, currentInputIndex - 1);
            if (e.key === "ArrowRight") nextInputIndex = Math.min(currentInputs.length - 1, currentInputIndex + 1);

            const targetRow = rows[nextRowIndex];
            const targetInputs = [...targetRow.querySelectorAll("input:not([readonly])")];
            const targetInput = targetInputs[nextInputIndex];

            if (targetInput) {
              targetInput.focus();
              if (["ArrowLeft", "ArrowRight"].includes(e.key)) {
                targetInput.select();
              }
            }
          }
        });
      });
    }

    function attachMarkupHandlers(row) {
      const priceInput = row.querySelector(".price-input");
      const qtyInput = row.querySelector(".qty-input");

      const markUp1Input = row.querySelector(".markup-1-input");
      const hargaJual1Input = row.querySelector(".harga-jual-1-input");
      const markUp2Input = row.querySelector(".markup-2-input");
      const hargaJual2Input = row.querySelector(".harga-jual-2-input");
      const markUp3Input = row.querySelector(".markup-3-input");
      const hargaJual3Input = row.querySelector(".harga-jual-3-input");

      function bindMarkup(markupInput, hargaJualInput) {
        // markup → harga jual
        markupInput.addEventListener("input", () => {
          let val = markupInput.value;
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            markupInput.value = intPart + "." + decPart.slice(0, 2);
          }
          const price = parseRupiah(priceInput.value);
          const percent = parseFloat(markupInput.value) || 0;
          const newHarga = price + (percent * price) / 100;
          hargaJualInput.value = Math.round(newHarga);
          updateTotalRow(row);
        });

        // harga jual → markup
        hargaJualInput.addEventListener("input", () => {
          hargaJualInput.value = hargaJualInput.value.replace(/[^0-9.]/g, "");
          const price = parseRupiah(priceInput.value);
          const newHarga = parseFloat(hargaJualInput.value) || 0;
          const newMarkup = ((newHarga - price) / price) * 100;
          markupInput.value = isFinite(newMarkup) ? newMarkup.toFixed(2) : "0";
          updateTotalRow(row);
        });

        hargaJualInput.addEventListener("focus", handleFormattedFocus);
        hargaJualInput.addEventListener("blur", handleFormattedBlur);
      }

      bindMarkup(markUp1Input, hargaJual1Input);
      bindMarkup(markUp2Input, hargaJual2Input);
      bindMarkup(markUp3Input, hargaJual3Input);
    }



   function loadTransaction(transaction) {
     // Clear the current sales table
     sellTableBody.innerHTML = "";

     // Set the grand total discounts and customer
     if (transaction.subtotal > 0) {
       const discountPercent =
         (transaction.totalDisc / transaction.subtotal) * 100;
       grandDiscountPercent.value = discountPercent.toFixed(2); // e.g. "12.50"
       console.log(
         "grand disc percent value:",
         grandDiscountPercent.value + "%"
       );
     } else {
       grandDiscountPercent.value = "0.00";
       console.warn(
         "Subtotal is zero or invalid, cannot compute discount percent."
       );
     }
     grandDiscountAmount.value = transaction.totalDisc;

     // Set customer if you want
     if (transaction.supplierDTO.supplierId) {
      console.log("transaction.supplierDTO.supplierId : " +  transaction.supplierDTO.supplierId);
       customerSelect.value = transaction.supplierDTO.supplierId;
       console.log("customerSelect.value : " + customerSelect.value);
     }

      //Insert no faktur, poDate, jenis pembayaran, poDueDate
      if(transaction.noFaktur) {
        document.getElementById("invoiceNumber").value = transaction.noFaktur;
      }

      window.addEventListener("load", function () {
          const poDateInput = document.getElementById("poDate");
          if (poDateInput && transaction.tanggalBeli) {
            poDateInput.value = transaction.tanggalBeli.split("T")[0];
          }

          if(transaction.cash == true){
            document.getElementById("paymentType").value = 'tunai';
          }else{
            document.getElementById("paymentType").value = 'kredit';
            document.getElementById("dueDateContainer").style.display = "block";
            if(transaction.tanggalTempo){
                document.getElementById("poDueDate").value = transaction.tanggalTempo.split("T")[0];
            }
          }

          if(transaction.isCash === false){
              document.getElementById("poDueDate").value = transaction.tanggalTempo.split("T")[0];
          }
      });


     // Populate the table with transaction details
     transaction.pembelianDetailDTOS.forEach((detail, index) => {
       const row = document.createElement("tr");

       row.innerHTML = `
   <td class="row-number">${index + 1}</td>
   <td><input type="text" class="form-control form-control-sm code-input" value="${
     detail.code
   }" /></td>
   <td><input type="text" class="form-control form-control-sm name-input" readonly value="${
     detail.name
   }" /></td>
   <td><input type="text" class="form-control form-control-sm price-input" value="${formatRupiah(
     detail.price
   )}" /></td>
   <td><input type="number" class="form-control form-control-sm qty-input" min="1" value="${
     detail.qty
   }" /></td>
   <td><input type="number" class="form-control form-control-sm discount-percent-input" min="0" max="100" value="${
     (detail.discAmount / (detail.total + detail.discAmount)) * 100
   }" /></td>
   <td><input type="number" class="form-control form-control-sm discount-amount-input" min="0" value="${
     detail.discAmount
   }" /></td>
   <td class="total-cell">${formatRupiah(detail.total)}</td>
    <td><input type="number" class="form-control form-control-sm stok-input" value="0" readonly/></td>
    <td><input type="number" class="form-control form-control-sm harga-jual-lama" value="${detail.hargaJual1}" readonly/></td>
      <!-- ✅ make harga jual 1/2/3 text inputs + formatted -->
      <td><input type="number" class="form-control form-control-sm markup-1-input" value="${detail.markup1}" /></td>
      <td><input type="text" class="form-control form-control-sm harga-jual-1-input" value="${formatRupiah(detail.hargaJual1)}"/></td>
      <td><input type="number" class="form-control form-control-sm markup-2-input" value="${detail.markup2}" /></td>
      <td><input type="text" class="form-control form-control-sm harga-jual-2-input" value="${formatRupiah(detail.hargaJual2)}" /></td>
      <td><input type="number" class="form-control form-control-sm markup-3-input" value="${detail.markup3}" /></td>
      <td><input type="text" class="form-control form-control-sm harga-jual-3-input" value="${formatRupiah(detail.hargaJual3)}"/></td>
    `;

    // Attach events (reuse same logic as addNewRow)
        attachNavigationHandlers(row);
        attachMarkupHandlers(row);


       // Re-attach event listeners to the new row's inputs
       const codeInput = row.querySelector(".code-input");
       const priceInput = row.querySelector(".price-input");
       const qtyInput = row.querySelector(".qty-input");
       const discPercentInput = row.querySelector(".discount-percent-input");
       const discAmountInput = row.querySelector(".discount-amount-input");
       const markUp1Input = row.querySelector(".markup-1-input");
       const markUp2Input = row.querySelector(".markup-2-input");
       const markUp3Input = row.querySelector(".markup-3-input");
       const hargaJual1Input = row.querySelector(".harga-jual-1-input");
       const hargaJual2Input = row.querySelector(".harga-jual-2-input");
       const hargaJual3Input = row.querySelector(".harga-jual-3-input");

       priceInput.addEventListener("focus", handleFormattedFocus);
       priceInput.addEventListener("blur", handleFormattedBlur);
       priceInput.addEventListener("input", () => updateTotalRow(row));
       qtyInput.addEventListener("input", () => updateTotalRow(row));


       discPercentInput.addEventListener("input", () => {
          let val = discPercentInput.value;
          console.log("value is : " + val);

          // Jika ada titik desimal, batasi hanya 2 digit setelah koma
          if (val.includes(".")) {
            const [intPart, decPart] = val.split(".");
            discPercentInput.value = intPart + "." + decPart.slice(0, 2);
          }

          const price = parseRupiah(row.querySelector(".price-input").value);
          const qty = parseInt(qtyInput.value) || 0;
          const discountPercent = parseFloat(discPercentInput.value) || 0;

          if (price * qty > 0) {
            const discountAmount = price * qty * (discountPercent / 100);
            discAmountInput.value = Math.round(discountAmount);
          } else {
            discAmountInput.value = "0";
          }
          updateTotalRow(row);
        });

       discAmountInput.addEventListener("input", () => {
         const price = parseRupiah(row.querySelector(".price-input").value);
         const qty = parseInt(qtyInput.value) || 0;
         const discountAmount = parseFloat(discAmountInput.value) || 0;
         if (price * qty > 0 && !isNaN(discountPercent)) {
           const discountPercent = (discountAmount / (price * qty)) * 100;
           discPercentInput.value = discountPercent.toFixed(2);
         } else {
           discPercentInput.value = "0";
         }
         updateTotalRow(row);
       });

       row.addEventListener("contextmenu", function (e) {
         e.preventDefault();
         selectedRow = row;
         showContextMenu(e.pageX, e.pageY);
       });

       sellTableBody.appendChild(row);
     });

     // Add a new empty row for a new item
     addNewRow();

     // Recalculate and display the grand total
     calculateGrandTotal();
   }

   // Init
   loadCustomers();
   if (
     masterTransactions.pembelianId !== null &&
     masterTransactions.pembelianDetailDTOS !== null
   ) {
     console.log("otw init master transactions");
     loadTransaction(masterTransactions);
   }
<!--   loadCustomers();-->
   updateJam();
   addNewRow();
   calculateGrandTotal();
   setInterval(updateJam, 1000);
</script>
</body>
</html>
