<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS Dashboard</title>

    <!-- Tabler CSS -->
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css"
    />

    <!-- Bootstrap 5 -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
          margin: 0;
          height: 100vh;
          overflow: hidden; /* cegah body ada scrollbar */
        }
        .page {
          display: flex;
          height: 100vh;
          width: 100%;
        }
        aside {
          flex-shrink: 0; /* sidebar tetap ukuran */
        }
        .page-wrapper {
          flex: 1;
          overflow-y: auto; /* hanya konten scroll */
          background-color: #f4f4f4;
        }
    </style>
</head>
<body>
<div class="page">
    <!-- Sidebar -->
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <!-- Main content -->
    <div class="page-wrapper">
        <div class="container py-4">
            <div style="text-align: center">
                <h1 style="text-align: center">Dashboard Anugrah Motor</h1>
                <h4 id="currentDateTime">TANGGAL HARI INI</h4>
            </div>

            <!-- Stat Cards -->
            <div class="row mb-4" style="padding-top: 15px">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="card-title">Jumlah Transaksi Hari Ini</h4>
                            <span
                                    class="display-6 fw-bold"
                                    id="transactionCount"
                                    th:text="${topBarData.countTransaction}"
                            >999</span
                            >
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="card-title">Nilai Penjualan Hari Ini</h4>
                            <span
                                    class="display-6 fw-bold text-success"
                                    id="totalTransaction"
                                    th:text="${topBarData.totalTransaction}"
                            >
                    Rp 25.255.255
                  </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="card-title">Nilai Laba Hari Ini</h4>
                            <span
                                    class="display-6 fw-bold text-primary"
                                    id="totalRevenue"
                                    th:text="${topBarData.totalProfit}"
                            >
                    Rp 5.555.555
                  </span>
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <div style="margin-bottom: 20px">
                <form
                        id="filterForm"
                        method="get"
                        action="/home"
                        class="row d-flex align-items-end"
                >
                    <!-- Start Date -->
                    <div class="col-md-3">
                        <label for="startDateInput" class="form-label"
                        >Start Date</label
                        >
                        <input
                                type="date"
                                id="startDateInput"
                                name="startDate"
                                class="form-control"
                                th:value="${#temporals.format(startDate, 'yyyy-MM-dd')}"
                        />
                    </div>

                    <!-- End Date -->
                    <div class="col-md-3">
                        <label for="endDateInput" class="form-label">End Date</label>
                        <input
                                type="date"
                                id="endDateInput"
                                name="endDate"
                                class="form-control"
                                th:value="${#temporals.format(endDate, 'yyyy-MM-dd')}"
                        />
                    </div>

                    <!-- Period Filter -->
                    <div class="col-md-2">
                        <label for="periodFilter" class="form-label">Filter Per</label>
                        <select
                                id="periodFilter"
                                name="periodFilter"
                                class="form-select w-100"
                        >
                            <option th:value="day" th:selected="${periodFilter == 'day'}">
                                Hari
                            </option>
                            <option
                                    th:value="month"
                                    th:selected="${periodFilter == 'month'}"
                            >
                                Bulan
                            </option>
                            <option
                                    th:value="year"
                                    th:selected="${periodFilter == 'year'}"
                            >
                                Tahun
                            </option>
                        </select>
                    </div>

                    <!-- Button aligned to right -->
                    <div class="col-md-2 d-flex justify-content-end ms-auto">
                        <div class="w-100">
                            <label class="form-label invisible">Apply</label>
                            <button type="submit" class="btn btn-primary w-100">
                                Terapkan Filter
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Chart -->
            <div class="card mb-4">
                <div class="card-body">
                    <div
                            class="d-flex justify-content-between align-items-center mb-3"
                    >
                        <h4 class="card-title mb-0">Grafik Keuangan</h4>
                    </div>
                    <canvas id="financeChart" height="120"></canvas>
                </div>
            </div>

            <!-- Top Products & Top Customers -->
            <div class="row">
                <!-- Top 10 Produk -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Top 10 Produk Terlaris</h4>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th style="width: 10%">Rank</th>
                                        <th style="width: 70%">Produk</th>
                                        <th style="width: 20%">Jumlah Terjual</th>
                                    </tr>
                                    </thead>
                                    <tbody id="topProductsTable">
                                    <tr
                                            th:each="product, iterStat : ${homeProductData}"
                                            th:if="${!homeProductData.empty}"
                                    >
                                        <td style="width: 5%" th:text="${iterStat.index + 1}">
                                            1
                                        </td>
                                        <td style="width: 80%" th:text="${product.name}"></td>
                                        <td style="width: 15%" th:text="${product.qty}"></td>
                                    </tr>
                                    <tr th:if="${homeProductData.empty}">
                                        <td colspan="3" class="text-center text-muted">
                                            Tidak ada data untuk ditampilkan.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top 5 Pelanggan -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Top 5 Pelanggan</h4>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Nama Pelanggan</th>
                                        <th>Total Pembelian</th>
                                    </tr>
                                    </thead>
                                    <tbody id="topCustomersTable">
                                    <tr
                                            th:each="customer, iterStat : ${homeCustomerData}"
                                            th:if="${!homeCustomerData.empty}"
                                    >
                                        <td style="width: 5%" th:text="${iterStat.index + 1}">
                                            1
                                        </td>
                                        <td
                                                style="width: 60%"
                                                th:text="${customer.name}"
                                        ></td>
                                        <td
                                                class="totalSpending"
                                                style="width: 35%"
                                                th:text="${customer.totalSpending}"
                                        ></td>
                                    </tr>
                                    <tr th:if="${homeCustomerData.empty}">
                                        <td colspan="3" class="text-center text-muted">
                                            Tidak ada data untuk ditampilkan.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabler JS -->
<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    var chartData = /*[[${chartDatas}]]*/ {
      labels: [],
      pendapatan: [],
      pengeluaran: [],
      laba: [],
    };
</script>

<script th:inline="javascript">
    var chartData = /*[[${chartDatas}]]*/ {
      labels: [],
      pendapatan: [],
      pengeluaran: [],
      laba: [],
    };
    console.log(chartData.labels);

    var startDateBackend = /*[[${startDate}]]*/
    var endDateBackend = /*[[${endDate}]]*/
</script>

<script>
    function formatToRupiah(amount) {
      return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
      }).format(amount);
    }

    function filterDataByDate(data, startDateStr, endDateStr, period) {
      if (!startDateStr || !endDateStr) return data;

      const filteredLabels = [];
      const filteredPendapatan = [];
      const filteredPengeluaran = [];
      const filteredLaba = [];

      if (period === "day") {
        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999);

        data.labels.forEach((label, idx) => {
          const labelDate = new Date(label);
          if (!isNaN(labelDate) && labelDate >= startDate && labelDate <= endDate) {
            filteredLabels.push(label);
            filteredPendapatan.push(data.pendapatan[idx]);
            filteredPengeluaran.push(data.pengeluaran[idx]);
            filteredLaba.push(data.laba[idx]);
          }
        });
      } else if (period === "month") {
          const startMonth = startDateStr.slice(0, 7); // "YYYY-MM"
          const endMonth = endDateStr.slice(0, 7);     // "YYYY-MM"

          data.labels.forEach((label, idx) => {
            if (label >= startMonth && label <= endMonth) {
              filteredLabels.push(label);
              filteredPendapatan.push(data.pendapatan[idx]);
              filteredPengeluaran.push(data.pengeluaran[idx]);
              filteredLaba.push(data.laba[idx]);
            }
          });
      } else if (period === "year") {
        const startYear = parseInt(startDateStr);
        const endYear = parseInt(endDateStr);

        data.labels.forEach((label, idx) => {
          const labelYear = parseInt(label);

          if (labelYear >= startYear && labelYear <= endYear) {
            filteredLabels.push(label);
            filteredPendapatan.push(data.pendapatan[idx]);
            filteredPengeluaran.push(data.pengeluaran[idx]);
            filteredLaba.push(data.laba[idx]);
          }
        });
      }

      return {
        labels: filteredLabels,
        pendapatan: filteredPendapatan,
        pengeluaran: filteredPengeluaran,
        laba: filteredLaba,
      };
    }

    const ctx = document.getElementById("financeChart").getContext("2d");
    let financeChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: "Pendapatan",
            data: chartData.pendapatan,
            borderColor: "green",
            fill: false,
            tension: 0.3,
          },
          {
            label: "Pengeluaran",
            data: chartData.pengeluaran,
            borderColor: "red",
            fill: false,
            tension: 0.3,
          },
          {
            label: "Laba Rugi",
            data: chartData.laba,
            borderColor: "blue",
            fill: false,
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "top" } },
        scales: {
          y: {
            ticks: { callback: (value) => "Rp " + value.toLocaleString() },
          },
        },
      },
    });

    function updateChart() {
      const period = document.getElementById("periodFilter").value;

      let startDateValue = document.getElementById("startDateInput").value;
      let endDateValue = document.getElementById("endDateInput").value;

      if (period === "year") {
        startDateValue = startDateValue.split("-")[0]; // just the year part, e.g. "2025"
        endDateValue = endDateValue.split("-")[0];
      }

      const filteredData = filterDataByDate(chartData, startDateValue, endDateValue, period);

      financeChart.data.labels = filteredData.labels;
      financeChart.data.datasets[0].data = filteredData.pendapatan;
      financeChart.data.datasets[1].data = filteredData.pengeluaran;
      financeChart.data.datasets[2].data = filteredData.laba;
      financeChart.update();
    }

    function formatTanggalWaktuIndonesia(date = new Date()) {
      const hari = new Intl.DateTimeFormat("id-ID", {
        weekday: "long",
      }).format(date);
      const tanggal = new Intl.DateTimeFormat("id-ID", {
        day: "numeric",
        month: "long",
        year: "numeric",
      }).format(date);
      const jam = date.getHours().toString().padStart(2, "0");
      const menit = date.getMinutes().toString().padStart(2, "0");
      const detik = date.getSeconds().toString().padStart(2, "0");

      return `${hari}, ${tanggal} - ${jam}:${menit}:${detik}`;
    }
    function updateJam() {
      const now = new Date();
      const jam = now.toLocaleTimeString("id-ID", { hour12: false });
      const tanggal = now.toLocaleDateString("id-ID");
      const waktuElement = document.getElementById("currentDateTime");
      if (waktuElement) {
        waktuElement.textContent = formatTanggalWaktuIndonesia();
      }
    }

    setInterval(updateJam, 1000);
    updateJam();
    updateChart();
</script>
</body>
</html>
